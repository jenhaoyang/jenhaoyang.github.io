<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="deepstream教學" /><meta property="og:locale" content="en" /><meta name="description" content="客製化模型實作nvinfer介面" /><meta property="og:description" content="客製化模型實作nvinfer介面" /><link rel="canonical" href="https://jenhaoyang.github.io//posts/deepstream%E6%95%99%E5%AD%B8/" /><meta property="og:url" content="https://jenhaoyang.github.io//posts/deepstream%E6%95%99%E5%AD%B8/" /><meta property="og:site_name" content="Steven" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-01-11T12:28:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="deepstream教學" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-08-17T08:03:06+08:00","datePublished":"2023-01-11T12:28:00+08:00","description":"客製化模型實作nvinfer介面","headline":"deepstream教學","mainEntityOfPage":{"@type":"WebPage","@id":"https://jenhaoyang.github.io//posts/deepstream%E6%95%99%E5%AD%B8/"},"url":"https://jenhaoyang.github.io//posts/deepstream%E6%95%99%E5%AD%B8/"}</script><title>deepstream教學 | Steven</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Steven"><meta name="application-name" content="Steven"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/favicons/android-chrome-512x512.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Steven</a></div><div class="site-subtitle font-italic">深度學習、機器學習、MLOps</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/jenhaoyang" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['steven05yang','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href="https://www.linkedin.com/in/jenhaoyang/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>deepstream教學</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>deepstream教學</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1673411280" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jan 11, 2023 </em> </span> <span> Updated <em class="" data-ts="1692230586" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Aug 17, 2023 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/jenhaoyang">Steven Yang</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="5067 words"> <em>28 min</em> read</span></div></div></div><div class="post-content"><h1 id="客製化模型實作nvinfer介面">客製化模型實作nvinfer介面</h1><h2 id="nvinfer呼叫介面"><span class="mr-2">nvinfer呼叫介面</span><a href="#nvinfer呼叫介面" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>任何客製化介面最終必須被編譯成一個獨立的shared library。nvinfer在執行期間利用<code class="language-plaintext highlighter-rouge">dlopen()</code>呼叫函式庫，並且利用<code class="language-plaintext highlighter-rouge">dlsym()</code>呼叫函式庫中的函式。進一步的資訊紀錄在<code class="language-plaintext highlighter-rouge">nvdsinfer_custom_impl.h</code>裡面https://docs.nvidia.com/metropolis/deepstream/sdk-api/nvdsinfer__custom__impl_8h.html</p><h2 id="客製化output-parsing"><span class="mr-2">客製化Output Parsing</span><a href="#客製化output-parsing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>對於detectors使用者必須自行解析模型的輸出並且將之轉化成bounding box 座標和物件類別。對於classifiers則是必須自行解析出物件屬性。範例在<code class="language-plaintext highlighter-rouge">/opt/nvidia/deepstream/deepstream/sources/libs/nvdsinfer_customparser</code>，裡面的README有關於使用custom parser的說明。<li>客製化parsing function必須為<code class="language-plaintext highlighter-rouge">NvDsInferParseCustomFunc</code>型態。在<code class="language-plaintext highlighter-rouge">nvdsinfer_custom_impl.h</code>的221行可以看到下面的型態定義，代表每一個客製化的解析函式都必須符合這個格式 ```c /**<li>Type definition for the custom bounding box parsing function. *<li>@param[in] outputLayersInfo A vector containing information on the output<li>layers of the model.<li>@param[in] networkInfo Network information.<li>@param[in] detectionParams Detection parameters required for parsing<li>objects.<li>@param[out] objectList A reference to a vector in which the function<li><p>is to add parsed objects. <em>/ typedef bool (</em> NvDsInferParseCustomFunc) ( std::vector<NvDsInferLayerInfo> const &amp;outputLayersInfo, NvDsInferNetworkInfo const &amp;networkInfo, NvDsInferParseDetectionParams const &amp;detectionParams, std::vector<NvDsInferObjectDetectionInfo> &amp;objectList); ```</NvDsInferObjectDetectionInfo></NvDsInferLayerInfo></p><li>客製化parsing function可以在<code class="language-plaintext highlighter-rouge">Gst-nvinfer</code>的參數檔<code class="language-plaintext highlighter-rouge">parse-bbox-func-name</code>和<code class="language-plaintext highlighter-rouge">custom-lib-name</code>屬性指定。例如我們定義了Yolov2-tiny的客製化bounding box解析函式<code class="language-plaintext highlighter-rouge">NvDsInferParseCustomYoloV2Tiny</code>，編譯出來的shared library位於<code class="language-plaintext highlighter-rouge">nvdsinfer_custom_impl_Yolo/libnvdsinfer_custom_impl_Yolo.so</code>，我們在設定檔就就必須要有以下設定<div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>parse-bbox-func-name=NvDsInferParseCustomYoloV2Tiny
custom-lib-path=nvdsinfer_custom_impl_Yolo/libnvdsinfer_custom_impl_Yolo.so
</pre></table></code></div></div></ul><p>可以藉由在定義函式後呼叫<code class="language-plaintext highlighter-rouge">CHECK_CUSTOM_PARSE_FUNC_PROTOTYPE()</code>marco來驗證函式的定義。 使用範例如下</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="k">extern</span> <span class="s">"C"</span> <span class="n">bool</span> <span class="nf">NvDsInferParseCustomYoloV2Tiny</span><span class="p">(</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">NvDsInferLayerInfo</span><span class="o">&gt;</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">outputLayersInfo</span><span class="p">,</span>
    <span class="n">NvDsInferNetworkInfo</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">networkInfo</span><span class="p">,</span>
    <span class="n">NvDsInferParseDetectionParams</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">detectionParams</span><span class="p">,</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">NvDsInferParseObjectInfo</span><span class="o">&gt;&amp;</span> <span class="n">objectList</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">...</span>
<span class="p">}</span>
<span class="n">CHECK_CUSTOM_PARSE_FUNC_PROTOTYPE</span><span class="p">(</span><span class="n">NvDsInferParseCustomYoloV2Tiny</span><span class="p">);</span>
</pre></table></code></div></div><p>https://forums.developer.nvidia.com/t/deepstreamsdk-4-0-1-custom-yolov3-tiny-error/108391?u=jenhao</p><h2 id="iplugin-implementation"><span class="mr-2">IPlugin Implementation</span><a href="#iplugin-implementation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>對於TensorRT不支援的network layer，Deepstream提供IPlugin interface來客製化處理。在<code class="language-plaintext highlighter-rouge">/opt/nvidia/deepstream/deepstream/sources</code>底下的<code class="language-plaintext highlighter-rouge">objectDetector_SSD</code>, <code class="language-plaintext highlighter-rouge">objectDetector_FasterRCNN</code>, 和 <code class="language-plaintext highlighter-rouge">objectDetector_YoloV3</code>資料夾展示了如何使用custom layers。</p><p>在<code class="language-plaintext highlighter-rouge">objectDetector_YoloV3</code>範例中我們可以看到如何製作Tensorrt不支援的Yolov3的yolo layer。可以在<code class="language-plaintext highlighter-rouge">yolo.cpp</code>中看到自定義的layer是如何被呼叫使用的，程式節錄如下。</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre><span class="p">....</span>
<span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">m_ConfigBlocks</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">at</span><span class="p">(</span><span class="s">"type"</span><span class="p">)</span> <span class="o">==</span> <span class="s">"yolo"</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">nvinfer1</span><span class="o">::</span><span class="n">Dims</span> <span class="n">prevTensorDims</span> <span class="o">=</span> <span class="n">previous</span><span class="o">-&gt;</span><span class="n">getDimensions</span><span class="p">();</span>
            <span class="n">assert</span><span class="p">(</span><span class="n">prevTensorDims</span><span class="p">.</span><span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">prevTensorDims</span><span class="p">.</span><span class="n">d</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
            <span class="n">TensorInfo</span><span class="o">&amp;</span> <span class="n">curYoloTensor</span> <span class="o">=</span> <span class="n">m_OutputTensors</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">outputTensorCount</span><span class="p">);</span>
            <span class="n">curYoloTensor</span><span class="p">.</span><span class="n">gridSize</span> <span class="o">=</span> <span class="n">prevTensorDims</span><span class="p">.</span><span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
            <span class="n">curYoloTensor</span><span class="p">.</span><span class="n">stride</span> <span class="o">=</span> <span class="n">m_InputW</span> <span class="o">/</span> <span class="n">curYoloTensor</span><span class="p">.</span><span class="n">gridSize</span><span class="p">;</span>
            <span class="n">m_OutputTensors</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">outputTensorCount</span><span class="p">).</span><span class="n">volume</span> <span class="o">=</span> <span class="n">curYoloTensor</span><span class="p">.</span><span class="n">gridSize</span>
                <span class="o">*</span> <span class="n">curYoloTensor</span><span class="p">.</span><span class="n">gridSize</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">curYoloTensor</span><span class="p">.</span><span class="n">numBBoxes</span> <span class="o">*</span> <span class="p">(</span><span class="mi">5</span> <span class="o">+</span> <span class="n">curYoloTensor</span><span class="p">.</span><span class="n">numClasses</span><span class="p">));</span>
            <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">layerName</span> <span class="o">=</span> <span class="s">"yolo_"</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
            <span class="n">curYoloTensor</span><span class="p">.</span><span class="n">blobName</span> <span class="o">=</span> <span class="n">layerName</span><span class="p">;</span>
            <span class="n">nvinfer1</span><span class="o">::</span><span class="n">IPluginV2</span><span class="o">*</span> <span class="n">yoloPlugin</span>
                <span class="o">=</span> <span class="n">new</span> <span class="n">YoloLayerV3</span><span class="p">(</span><span class="n">m_OutputTensors</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">outputTensorCount</span><span class="p">).</span><span class="n">numBBoxes</span><span class="p">,</span>
                                  <span class="n">m_OutputTensors</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">outputTensorCount</span><span class="p">).</span><span class="n">numClasses</span><span class="p">,</span>
                                  <span class="n">m_OutputTensors</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">outputTensorCount</span><span class="p">).</span><span class="n">gridSize</span><span class="p">);</span>
            <span class="n">assert</span><span class="p">(</span><span class="n">yoloPlugin</span> <span class="o">!=</span> <span class="n">nullptr</span><span class="p">);</span>
            <span class="n">nvinfer1</span><span class="o">::</span><span class="n">IPluginV2Layer</span><span class="o">*</span> <span class="n">yolo</span> <span class="o">=</span>
                <span class="n">network</span><span class="p">.</span><span class="n">addPluginV2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">previous</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">yoloPlugin</span><span class="p">);</span>
            <span class="n">assert</span><span class="p">(</span><span class="n">yolo</span> <span class="o">!=</span> <span class="n">nullptr</span><span class="p">);</span>
            <span class="n">yolo</span><span class="o">-&gt;</span><span class="n">setName</span><span class="p">(</span><span class="n">layerName</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
            <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">inputVol</span> <span class="o">=</span> <span class="n">dimsToString</span><span class="p">(</span><span class="n">previous</span><span class="o">-&gt;</span><span class="n">getDimensions</span><span class="p">());</span>
            <span class="n">previous</span> <span class="o">=</span> <span class="n">yolo</span><span class="o">-&gt;</span><span class="n">getOutput</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
            <span class="n">assert</span><span class="p">(</span><span class="n">previous</span> <span class="o">!=</span> <span class="n">nullptr</span><span class="p">);</span>
            <span class="n">previous</span><span class="o">-&gt;</span><span class="n">setName</span><span class="p">(</span><span class="n">layerName</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
            <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">outputVol</span> <span class="o">=</span> <span class="n">dimsToString</span><span class="p">(</span><span class="n">previous</span><span class="o">-&gt;</span><span class="n">getDimensions</span><span class="p">());</span>
            <span class="n">network</span><span class="p">.</span><span class="n">markOutput</span><span class="p">(</span><span class="o">*</span><span class="n">previous</span><span class="p">);</span>
            <span class="n">channels</span> <span class="o">=</span> <span class="n">getNumChannels</span><span class="p">(</span><span class="n">previous</span><span class="p">);</span>
            <span class="n">tensorOutputs</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">yolo</span><span class="o">-&gt;</span><span class="n">getOutput</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
            <span class="n">printLayerInfo</span><span class="p">(</span><span class="n">layerIndex</span><span class="p">,</span> <span class="s">"yolo"</span><span class="p">,</span> <span class="n">inputVol</span><span class="p">,</span> <span class="n">outputVol</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">weightPtr</span><span class="p">));</span>
            <span class="o">++</span><span class="n">outputTensorCount</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">...</span>
</pre></table></code></div></div><p>而其他版本的YOLO，Nvidia也已經幫我們建立好許多Plugin，例如yolov2的region layer，Nvidia已經幫我們建立，其他已經建立好的layer可以在這裡找到。 https://github.com/NVIDIA/TensorRT/tree/1c0e3fdd039c92e584430a2ed91b4e2612e375b8/plugin</p><h1 id="畫出範例的結構圖">畫出範例的結構圖</h1><p>首先在<code class="language-plaintext highlighter-rouge">~/.bashrc</code>加入下面這行設定pipeline圖儲存的位置，注意GStreamer不會幫你建立資料夾，你必須確認資料夾存在</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">export </span><span class="nv">GST_DEBUG_DUMP_DOT_DIR</span><span class="o">=</span>/tmp
</pre></table></code></div></div><p>接下來在pipeline 狀態設為PLAYING之前加入下面這行程式</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">GST_DEBUG_BIN_TO_DOT_FILE</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">GST_DEBUG_GRAPH_SHOW_ALL</span><span class="p">,</span> <span class="s">"dstest1-pipeline"</span><span class="p">);</span>
</pre></table></code></div></div><p>最後執行程式後就會產生<code class="language-plaintext highlighter-rouge">.dot</code>在前面設定的資料夾，你可以下載<a href="http://www.graphviz.org/">Graphviz</a>，或是用<a href="https://marketplace.visualstudio.com/items?itemName=tintinweb.graphviz-interactive-preview">VScode的插件</a>來看圖</p><h2 id="deepstream-說明書"><span class="mr-2">Deepstream 說明書</span><a href="#deepstream-說明書" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>https://docs.nvidia.com/metropolis/deepstream/dev-guide/text/DS_plugin_gst-nvdsxfer.html</p><h2 id="gst-launch-10建立rtsp輸入源的pipeline"><span class="mr-2">gst-launch-1.0建立rtsp輸入源的pipeline</span><a href="#gst-launch-10建立rtsp輸入源的pipeline" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>首先先用<code class="language-plaintext highlighter-rouge">gst-launch-1.0</code>建立一個簡單的rtsp輸入、螢幕輸出的pipeline</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>gst-launch-1.0 rtspsrc location='rtsp://192.168.1.10:554/user=admin_password=xxxxxx_channel=1_stream=0.sdp' ! rtph264depay ! h264parse ! nvv4l2decoder ! nvvideoconvert ! video/x-raw,format=BGRx ! videoconvert ! video/x-raw,format=BGR ! autovideosink
</pre></table></code></div></div><h2 id="將python的範例程式轉成c"><span class="mr-2">將python的範例程式轉成c++</span><a href="#將python的範例程式轉成c" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>https://github.com/NVIDIA-AI-IOT/deepstream_python_apps/tree/master/apps/deepstream-rtsp-in-rtsp-out</p><h2 id="建立mjpeg串流"><span class="mr-2">建立mjpeg串流</span><a href="#建立mjpeg串流" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ol><li>指令方式<div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>gst-launch-1.0 -v rtspsrc location="rtsp://&lt;rtsp url&gt;/live1.sdp" \
! rtph264depay ! avdec_h264 \
! timeoverlay halignment=right valignment=bottom \
! videorate ! video/x-raw,framerate=37000/1001 ! jpegenc ! multifilesink location="snapshot.jpeg"
</pre></table></code></div></div><p>https://stackoverflow.com/questions/59885450/jpeg-live-stream-in-html-slow</p></ol><h2 id="查詢deepstream-bin的說明"><span class="mr-2">查詢deepstream bin的說明</span><a href="#查詢deepstream-bin的說明" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>gst-inspect-1.0 nvurisrcbin
</pre></table></code></div></div><h2 id="gst-launch-10輸出除錯訊息到檔案"><span class="mr-2">gst-launch-1.0輸出除錯訊息到檔案</span><a href="#gst-launch-10輸出除錯訊息到檔案" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>參考:<br /> https://www.cnblogs.com/xleng/p/12228720.html</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>GST_DEBUG_NO_COLOR=1 GST_DEBUG_FILE=pipeline.log GST_DEBUG=5 gst-launch-1.0 -v rtspsrc location="rtsp://192.168.8.19/live.sdp" user-id="root" user-pw="3edc\$RFV" ! rtph264depay ! avdec_h264 ! timeoverlay halignment=right valignment=bottom ! videorate ! video/x-raw,framerate=37000/1001 ! jpegenc ! multifilesink location="snapshot.jpeg"
</pre></table></code></div></div><p>參考: https://gstreamer.freedesktop.org/documentation/tutorials/basic/debugging-tools.html?gi-language=c<br /> https://embeddedartistry.com/blog/2018/02/22/generating-gstreamer-pipeline-graphs/</p><h2 id="本地端觀看udp傳送影像"><span class="mr-2">本地端觀看udp傳送影像</span><a href="#本地端觀看udp傳送影像" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>host設為本機ip或127.0.0.1</p><p>send:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>gst-launch-1.0 -v videotestsrc ! x264enc tune=zerolatency bitrate=500 speed-preset=superfast ! rtph264pay ! udpsink port=5000 host=$HOST
</pre></table></code></div></div><p>receive:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>gst-launch-1.0 -v udpsrc port=5000 ! "application/x-rtp, media=(string)video, clock-rate=(int)90000, encoding-name=(string)H264, payload=(int)96" ! rtph264depay ! h264parse ! avdec_h264 ! videoconvert ! autovideosink
</pre></table></code></div></div><h2 id="glibs說明書"><span class="mr-2">Glibs說明書</span><a href="#glibs說明書" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>http://irtfweb.ifa.hawaii.edu/SoftwareDocs/gtk20/glib/glib-hash-tables.html#g-int-hash</p><h2 id="gdb文字圖形介面"><span class="mr-2">GDB文字圖形介面</span><a href="#gdb文字圖形介面" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>https://blog.louie.lu/2016/09/12/gdb-%E9%8C%A6%E5%9B%8A%E5%A6%99%E8%A8%88/</p><h2 id="範例"><span class="mr-2">範例</span><a href="#範例" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>https://gist.github.com/liviaerxin/bb34725037fd04afa76ef9252c2ee875#tips-for-debug</p><h2 id="rtsp-元件nvrtspoutsinkbin"><span class="mr-2">rtsp 元件nvrtspoutsinkbin</span><a href="#rtsp-元件nvrtspoutsinkbin" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>nvrtspoutsinkbin沒有說明書，只能用gst-inspect-1.0看 https://forums.developer.nvidia.com/t/where-can-fine-nvrtspoutsinkbin-info/199124</p><p>範例 /opt/nvidia/deepstream/deepstream/sources/apps/sample_apps/deepstream_reference_apps/deepstream-bodypose-3d/sources/deepstream_pose_estimation_app.cpp</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre>    <span class="cm">/* Create RTSP output bin */</span>
    <span class="n">rtsp_out_bin</span> <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"nvrtspoutsinkbin"</span><span class="p">,</span> <span class="s">"nvrtsp-renderer"</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtsp_out_bin</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Failed to create RTSP output elements. Exiting.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">g_object_set</span> <span class="p">(</span><span class="n">G_OBJECT</span> <span class="p">(</span><span class="n">rtsp_out_bin</span><span class="p">),</span> <span class="s">"sync"</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">g_object_set</span> <span class="p">(</span><span class="n">G_OBJECT</span> <span class="p">(</span><span class="n">rtsp_out_bin</span><span class="p">),</span> <span class="s">"bitrate"</span><span class="p">,</span> <span class="mi">768000</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">g_object_set</span> <span class="p">(</span><span class="n">G_OBJECT</span> <span class="p">(</span><span class="n">rtsp_out_bin</span><span class="p">),</span> <span class="s">"rtsp-port"</span><span class="p">,</span> <span class="n">rtsp_port_num</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">g_object_set</span> <span class="p">(</span><span class="n">G_OBJECT</span> <span class="p">(</span><span class="n">rtsp_out_bin</span><span class="p">),</span> <span class="s">"enc-type"</span><span class="p">,</span> <span class="n">enc_type</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="n">gst_bin_add_many</span> <span class="p">(</span><span class="n">GST_BIN</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">),</span> <span class="n">rtsp_out_bin</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</pre></table></code></div></div><h2 id="取得source-id"><span class="mr-2">取得source id</span><a href="#取得source-id" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><a href="https://forums.developer.nvidia.com/t/can-i-pass-source-id-from-nvinferserver-along-with-frame/205418">https://forums.developer.nvidia.com/t/how-to-get-sources-index-in-deepstream/244461 </a></p><p>可以用prob取得meta data deepstream_test3_app.c 有範例</p><p><a href="https://forums.developer.nvidia.com/t/how-to-make-metadata-probe-for-classification-only-pipeline/171126">probe使用範例 </a></p><p><img data-src="/assets/img/deepstream/metadata.png" alt="metadata" data-proofer-ignore></p><h2 id="切換輸入源"><span class="mr-2">切換輸入源</span><a href="#切換輸入源" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>https://forums.developer.nvidia.com/t/how-switch-camera-output-gst-nvmultistreamtiler/233062</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>tiler_sink_pad.add_probe(Gst.PadProbeType.BUFFER, tiler_sink_pad_buffer_probe, 0)

tiler.set_property("show-source", &lt;stream_id&gt;) `
</pre></table></code></div></div><p>/opt/nvidia/deepstream/deepstream/sources/apps/apps-common/src/deepstream-yaml/deepstream_source_yaml.cpp有範例</p><h2 id="斷線重連"><span class="mr-2">斷線重連</span><a href="#斷線重連" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>rust的插件(可能可以編譯成c函式庫) https://coaxion.net/blog/2020/07/automatic-retry-on-error-and-fallback-stream-handling-for-gstreamer-sources/</p><p>https://gitlab.freedesktop.org/gstreamer/gst-plugins-rs/-/tree/master/utils/fallbackswitch</p><p>編譯rust插件<br /> https://www.collabora.com/news-and-blog/blog/2020/06/23/cross-building-rust-gstreamer-plugins-for-the-raspberry-pi/</p><p>RUST說明書 https://rust-lang.tw/book-tw/ch01-03-hello-cargo.html</p><h2 id="截出有物件的圖"><span class="mr-2">截出有物件的圖</span><a href="#截出有物件的圖" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>https://forums.developer.nvidia.com/t/saving-frame-with-detected-object-jetson-nano-ds4-0-2/121797/3</p><h2 id="關閉ubuntu圖形介面"><span class="mr-2">關閉Ubuntu圖形介面</span><a href="#關閉ubuntu圖形介面" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>https://linuxconfig.org/how-to-disable-enable-gui-on-boot-in-ubuntu-20-04-focal-fossa-linux-desktop</p><h2 id="關閉使用gpu的資源"><span class="mr-2">關閉使用gpu的資源</span><a href="#關閉使用gpu的資源" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>https://heary.cn/posts/Linux环境下重装NVIDIA驱动报错kernel-module-nvidia-modeset-in-use问题分析/</p><p>發現nvidia smi persistence mode會占用GPU資源，必須釋放掉才能安裝新的driver 可以用nvidia-smi的指令關掉https://docs.nvidia.com/deploy/driver-persistence/index.html#usage</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>nvidia-smi -pm 0
</pre></table></code></div></div><h2 id="移除舊的driver"><span class="mr-2">移除舊的driver</span><a href="#移除舊的driver" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>apt-get remove --purge nvidia-driver-520
apt-get autoremove
</pre></table></code></div></div><h2 id="queue的用途"><span class="mr-2">queue的用途</span><a href="#queue的用途" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>https://docs.xilinx.com/r/en-US/ug1449-multimedia/Performance-Improvement-from-the-GStreamer-Perspective</p><h2 id="probe"><span class="mr-2">probe</span><a href="#probe" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>https://coaxion.net/blog/2014/01/gstreamer-dynamic-pipelines/</p><p>https://erit-lvx.medium.com/probes-handling-in-gstreamer-pipelines-3f96ea367f31</p><h2 id="deepstream-test4-用prob取得metadata的範例"><span class="mr-2">deepstream-test4 用prob取得metadata的範例</span><a href="#deepstream-test4-用prob取得metadata的範例" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>NvDsBatchMeta資料圖: https://docs.nvidia.com/metropolis/deepstream/dev-guide/text/DS_plugin_metadata.html</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
</pre><td class="rouge-code"><pre><span class="k">static</span> <span class="n">GstPadProbeReturn</span>
<span class="nf">osd_sink_pad_buffer_probe</span> <span class="p">(</span><span class="n">GstPad</span> <span class="o">*</span> <span class="n">pad</span><span class="p">,</span> <span class="n">GstPadProbeInfo</span> <span class="o">*</span> <span class="n">info</span><span class="p">,</span>
    <span class="n">gpointer</span> <span class="n">u_data</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">GstBuffer</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">GstBuffer</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
  <span class="n">NvDsFrameMeta</span> <span class="o">*</span><span class="n">frame_meta</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">NvOSD_TextParams</span> <span class="o">*</span><span class="n">txt_params</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">guint</span> <span class="n">vehicle_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">guint</span> <span class="n">person_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">gboolean</span> <span class="n">is_first_object</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
  <span class="n">NvDsMetaList</span> <span class="o">*</span><span class="n">l_frame</span><span class="p">,</span> <span class="o">*</span><span class="n">l_obj</span><span class="p">;</span>

  <span class="n">NvDsBatchMeta</span> <span class="o">*</span><span class="n">batch_meta</span> <span class="o">=</span> <span class="n">gst_buffer_get_nvds_batch_meta</span> <span class="p">(</span><span class="n">buf</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">batch_meta</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// No batch meta attached.</span>
    <span class="k">return</span> <span class="n">GST_PAD_PROBE_OK</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">//batch_meta : NvDsBatchMeta https://docs.nvidia.com/metropolis/deepstream/sdk-api/struct__NvDsBatchMeta.html</span>
  <span class="c1">//</span>
  <span class="c1">//l_frame : NvDsFrameMetaList, 本質是GList http://irtfweb.ifa.hawaii.edu/SoftwareDocs/gtk20/glib/glib-doubly-linked-lists.html#GList</span>
  <span class="c1">//   struct GList</span>
  <span class="c1">// {</span>
  <span class="c1">//   gpointer data;</span>
  <span class="c1">//   GList *next;</span>
  <span class="c1">//   GList *prev;</span>
  <span class="c1">// };</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">l_frame</span> <span class="o">=</span> <span class="n">batch_meta</span><span class="o">-&gt;</span><span class="n">frame_meta_list</span><span class="p">;</span> <span class="n">l_frame</span><span class="p">;</span> <span class="n">l_frame</span> <span class="o">=</span> <span class="n">l_frame</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">frame_meta</span> <span class="o">=</span> <span class="p">(</span><span class="n">NvDsFrameMeta</span> <span class="o">*</span><span class="p">)</span> <span class="n">l_frame</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">frame_meta</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Ignore Null frame meta.</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">is_first_object</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>

    <span class="c1">// frame_meta : NvDsFrameMeta https://docs.nvidia.com/metropolis/deepstream/sdk-api/struct__NvDsFrameMeta.html</span>
    <span class="c1">// l_obj : NvDsObjectMetaList * 本質是GList </span>
    <span class="c1">// obj_meta : NvDsObjectMeta</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">l_obj</span> <span class="o">=</span> <span class="n">frame_meta</span><span class="o">-&gt;</span><span class="n">obj_meta_list</span><span class="p">;</span> <span class="n">l_obj</span><span class="p">;</span> <span class="n">l_obj</span> <span class="o">=</span> <span class="n">l_obj</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">NvDsObjectMeta</span> <span class="o">*</span><span class="n">obj_meta</span> <span class="o">=</span> <span class="p">(</span><span class="n">NvDsObjectMeta</span> <span class="o">*</span><span class="p">)</span> <span class="n">l_obj</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">obj_meta</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Ignore Null object.</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="c1">// obj_meta : NvDsObjectMeta</span>
      <span class="c1">// text_params : NvOSD_TextParams 描述物件的文字</span>
      <span class="c1">// line233 - 241應該是清掉原本的文字然後放入字定義的class名稱</span>
      <span class="n">txt_params</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">obj_meta</span><span class="o">-&gt;</span><span class="n">text_params</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">txt_params</span><span class="o">-&gt;</span><span class="n">display_text</span><span class="p">)</span>
        <span class="n">g_free</span> <span class="p">(</span><span class="n">txt_params</span><span class="o">-&gt;</span><span class="n">display_text</span><span class="p">);</span>

      <span class="n">txt_params</span><span class="o">-&gt;</span><span class="n">display_text</span> <span class="o">=</span> <span class="n">g_malloc0</span> <span class="p">(</span><span class="n">MAX_DISPLAY_LEN</span><span class="p">);</span>

      <span class="n">g_snprintf</span> <span class="p">(</span><span class="n">txt_params</span><span class="o">-&gt;</span><span class="n">display_text</span><span class="p">,</span> <span class="n">MAX_DISPLAY_LEN</span><span class="p">,</span> <span class="s">"%s "</span><span class="p">,</span>
          <span class="n">pgie_classes_str</span><span class="p">[</span><span class="n">obj_meta</span><span class="o">-&gt;</span><span class="n">class_id</span><span class="p">]);</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">obj_meta</span><span class="o">-&gt;</span><span class="n">class_id</span> <span class="o">==</span> <span class="n">PGIE_CLASS_ID_VEHICLE</span><span class="p">)</span>
        <span class="n">vehicle_count</span><span class="o">++</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">obj_meta</span><span class="o">-&gt;</span><span class="n">class_id</span> <span class="o">==</span> <span class="n">PGIE_CLASS_ID_PERSON</span><span class="p">)</span>
        <span class="n">person_count</span><span class="o">++</span><span class="p">;</span>

      <span class="cm">/* Now set the offsets where the string should appear */</span>
      <span class="n">txt_params</span><span class="o">-&gt;</span><span class="n">x_offset</span> <span class="o">=</span> <span class="n">obj_meta</span><span class="o">-&gt;</span><span class="n">rect_params</span><span class="p">.</span><span class="n">left</span><span class="p">;</span>
      <span class="n">txt_params</span><span class="o">-&gt;</span><span class="n">y_offset</span> <span class="o">=</span> <span class="n">obj_meta</span><span class="o">-&gt;</span><span class="n">rect_params</span><span class="p">.</span><span class="n">top</span> <span class="o">-</span> <span class="mi">25</span><span class="p">;</span>

      <span class="cm">/* Font , font-color and font-size */</span>
      <span class="n">txt_params</span><span class="o">-&gt;</span><span class="n">font_params</span><span class="p">.</span><span class="n">font_name</span> <span class="o">=</span> <span class="s">"Serif"</span><span class="p">;</span>
      <span class="n">txt_params</span><span class="o">-&gt;</span><span class="n">font_params</span><span class="p">.</span><span class="n">font_size</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
      <span class="n">txt_params</span><span class="o">-&gt;</span><span class="n">font_params</span><span class="p">.</span><span class="n">font_color</span><span class="p">.</span><span class="n">red</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
      <span class="n">txt_params</span><span class="o">-&gt;</span><span class="n">font_params</span><span class="p">.</span><span class="n">font_color</span><span class="p">.</span><span class="n">green</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
      <span class="n">txt_params</span><span class="o">-&gt;</span><span class="n">font_params</span><span class="p">.</span><span class="n">font_color</span><span class="p">.</span><span class="n">blue</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
      <span class="n">txt_params</span><span class="o">-&gt;</span><span class="n">font_params</span><span class="p">.</span><span class="n">font_color</span><span class="p">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

      <span class="cm">/* Text background color */</span>
      <span class="n">txt_params</span><span class="o">-&gt;</span><span class="n">set_bg_clr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="n">txt_params</span><span class="o">-&gt;</span><span class="n">text_bg_clr</span><span class="p">.</span><span class="n">red</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
      <span class="n">txt_params</span><span class="o">-&gt;</span><span class="n">text_bg_clr</span><span class="p">.</span><span class="n">green</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
      <span class="n">txt_params</span><span class="o">-&gt;</span><span class="n">text_bg_clr</span><span class="p">.</span><span class="n">blue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
      <span class="n">txt_params</span><span class="o">-&gt;</span><span class="n">text_bg_clr</span><span class="p">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

      <span class="cm">/*
       * Ideally NVDS_EVENT_MSG_META should be attached to buffer by the
       * component implementing detection / recognition logic.
       * Here it demonstrates how to use / attach that meta data.
       */</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">is_first_object</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">frame_number</span> <span class="o">%</span> <span class="n">frame_interval</span><span class="p">))</span> <span class="p">{</span>
        <span class="cm">/* Frequency of messages to be send will be based on use case.
         * Here message is being sent for first object every frame_interval(default=30).
         */</span>

        <span class="n">NvDsEventMsgMeta</span> <span class="o">*</span><span class="n">msg_meta</span> <span class="o">=</span>
            <span class="p">(</span><span class="n">NvDsEventMsgMeta</span> <span class="o">*</span><span class="p">)</span> <span class="n">g_malloc0</span> <span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="n">NvDsEventMsgMeta</span><span class="p">));</span>
        <span class="n">msg_meta</span><span class="o">-&gt;</span><span class="n">bbox</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="n">obj_meta</span><span class="o">-&gt;</span><span class="n">rect_params</span><span class="p">.</span><span class="n">top</span><span class="p">;</span>
        <span class="n">msg_meta</span><span class="o">-&gt;</span><span class="n">bbox</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">obj_meta</span><span class="o">-&gt;</span><span class="n">rect_params</span><span class="p">.</span><span class="n">left</span><span class="p">;</span>
        <span class="n">msg_meta</span><span class="o">-&gt;</span><span class="n">bbox</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">obj_meta</span><span class="o">-&gt;</span><span class="n">rect_params</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
        <span class="n">msg_meta</span><span class="o">-&gt;</span><span class="n">bbox</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">obj_meta</span><span class="o">-&gt;</span><span class="n">rect_params</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
        <span class="n">msg_meta</span><span class="o">-&gt;</span><span class="n">frameId</span> <span class="o">=</span> <span class="n">frame_number</span><span class="p">;</span>
        <span class="n">msg_meta</span><span class="o">-&gt;</span><span class="n">trackingId</span> <span class="o">=</span> <span class="n">obj_meta</span><span class="o">-&gt;</span><span class="n">object_id</span><span class="p">;</span>
        <span class="n">msg_meta</span><span class="o">-&gt;</span><span class="n">confidence</span> <span class="o">=</span> <span class="n">obj_meta</span><span class="o">-&gt;</span><span class="n">confidence</span><span class="p">;</span>
        <span class="n">generate_event_msg_meta</span> <span class="p">(</span><span class="n">msg_meta</span><span class="p">,</span> <span class="n">obj_meta</span><span class="o">-&gt;</span><span class="n">class_id</span><span class="p">,</span> <span class="n">obj_meta</span><span class="p">);</span>

        <span class="c1">// 要增加自訂的meta data必須要先用            nvds_acquire_user_meta_from_pool (batch_meta);取得</span>
        <span class="c1">// https://docs.nvidia.com/metropolis/deepstream/dev-guide/text/DS_plugin_metadata.html#user-custom-metadata-addition-inside-nvdsbatchmeta</span>

        <span class="n">NvDsUserMeta</span> <span class="o">*</span><span class="n">user_event_meta</span> <span class="o">=</span>
            <span class="n">nvds_acquire_user_meta_from_pool</span> <span class="p">(</span><span class="n">batch_meta</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">user_event_meta</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">user_event_meta</span><span class="o">-&gt;</span><span class="n">user_meta_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">msg_meta</span><span class="p">;</span>
          <span class="n">user_event_meta</span><span class="o">-&gt;</span><span class="n">base_meta</span><span class="p">.</span><span class="n">meta_type</span> <span class="o">=</span> <span class="n">NVDS_EVENT_MSG_META</span><span class="p">;</span>
          <span class="n">user_event_meta</span><span class="o">-&gt;</span><span class="n">base_meta</span><span class="p">.</span><span class="n">copy_func</span> <span class="o">=</span>
              <span class="p">(</span><span class="n">NvDsMetaCopyFunc</span><span class="p">)</span> <span class="n">meta_copy_func</span><span class="p">;</span>
          <span class="n">user_event_meta</span><span class="o">-&gt;</span><span class="n">base_meta</span><span class="p">.</span><span class="n">release_func</span> <span class="o">=</span>
              <span class="p">(</span><span class="n">NvDsMetaReleaseFunc</span><span class="p">)</span> <span class="n">meta_free_func</span><span class="p">;</span>
          <span class="n">nvds_add_user_meta_to_frame</span> <span class="p">(</span><span class="n">frame_meta</span><span class="p">,</span> <span class="n">user_event_meta</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">g_print</span> <span class="p">(</span><span class="s">"Error in attaching event meta to buffer</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">is_first_object</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">g_print</span> <span class="p">(</span><span class="s">"Frame Number = %d "</span>
      <span class="s">"Vehicle Count = %d Person Count = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
      <span class="n">frame_number</span><span class="p">,</span> <span class="n">vehicle_count</span><span class="p">,</span> <span class="n">person_count</span><span class="p">);</span>
  <span class="n">frame_number</span><span class="o">++</span><span class="p">;</span>

  <span class="k">return</span> <span class="n">GST_PAD_PROBE_OK</span><span class="p">;</span>
<span class="p">}</span>

</pre></table></code></div></div><h2 id="注意element的名稱不要一樣以免出錯"><span class="mr-2">注意element的名稱不要一樣以免出錯</span><a href="#注意element的名稱不要一樣以免出錯" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h2 id="nvdsobjencusrargs參數的功用"><span class="mr-2">NvDsObjEncUsrArgs參數的功用</span><a href="#nvdsobjencusrargs參數的功用" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>bool isFrame : 告訴encoder要編碼整張照片還是編碼每一個偵測物件的截圖。<ul><li>1: Encodes the entire frame.<li>0: Encodes object of specified resolution.</ul><li>bool saveImg : 會直接儲存一張照片到當前資料夾<li>bool attachUsrMeta :<ul><li>決定是否加上NVDS_CROP_IMAGE_META metadata</ul></ul><h1 id="deepstream截圖以deepstream_image_meta_test為例">Deepstream截圖，以deepstream_image_meta_test為例</h1><h2 id="注意"><span class="mr-2">注意:</span><a href="#注意" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><a href="https://docs.nvidia.com/metropolis/deepstream/sdk-api/group__ee__object__encoder.html#ga83f212f9db247092c2b51b6f239f7482">根據文件</a><code class="language-plaintext highlighter-rouge">nvds_obj_enc_process</code>是一個非阻塞的函式，使用者必須呼叫<code class="language-plaintext highlighter-rouge">nvds_obj_enc_finish()</code>以確保所有的圖片都已經確實被處理完成。</p><h2 id="第一步設定要儲存照片的條件並且encode成jpg檔"><span class="mr-2">第一步，設定要儲存照片的條件並且encode成jpg檔</span><a href="#第一步設定要儲存照片的條件並且encode成jpg檔" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
</pre><td class="rouge-code"><pre><span class="cm">/* pgie_src_pad_buffer_probe will extract metadata received on pgie src pad
 * and update params for drawing rectangle, object information etc. We also
 * iterate through the object list and encode the cropped objects as jpeg
 * images and attach it as user meta to the respective objects.*/</span>
<span class="k">static</span> <span class="n">GstPadProbeReturn</span>
<span class="nf">pgie_src_pad_buffer_probe</span> <span class="p">(</span><span class="n">GstPad</span> <span class="o">*</span> <span class="n">pad</span><span class="p">,</span> <span class="n">GstPadProbeInfo</span> <span class="o">*</span> <span class="n">info</span><span class="p">,</span> <span class="n">gpointer</span> <span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">GstBuffer</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">GstBuffer</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
  <span class="n">GstMapInfo</span> <span class="n">inmap</span> <span class="o">=</span> <span class="n">GST_MAP_INFO_INIT</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gst_buffer_map</span> <span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inmap</span><span class="p">,</span> <span class="n">GST_MAP_READ</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">GST_ERROR</span> <span class="p">(</span><span class="s">"input buffer mapinfo failed"</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">GST_PAD_PROBE_DROP</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">NvBufSurface</span> <span class="o">*</span><span class="n">ip_surf</span> <span class="o">=</span> <span class="p">(</span><span class="n">NvBufSurface</span> <span class="o">*</span><span class="p">)</span> <span class="n">inmap</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
  <span class="n">gst_buffer_unmap</span> <span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inmap</span><span class="p">);</span>

  <span class="n">NvDsObjectMeta</span> <span class="o">*</span><span class="n">obj_meta</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">guint</span> <span class="n">vehicle_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">guint</span> <span class="n">person_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">NvDsMetaList</span> <span class="o">*</span><span class="n">l_frame</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">NvDsMetaList</span> <span class="o">*</span><span class="n">l_obj</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">NvDsBatchMeta</span> <span class="o">*</span><span class="n">batch_meta</span> <span class="o">=</span> <span class="n">gst_buffer_get_nvds_batch_meta</span> <span class="p">(</span><span class="n">buf</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">l_frame</span> <span class="o">=</span> <span class="n">batch_meta</span><span class="o">-&gt;</span><span class="n">frame_meta_list</span><span class="p">;</span> <span class="n">l_frame</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
      <span class="n">l_frame</span> <span class="o">=</span> <span class="n">l_frame</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NvDsFrameMeta</span> <span class="o">*</span><span class="n">frame_meta</span> <span class="o">=</span> <span class="p">(</span><span class="n">NvDsFrameMeta</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">l_frame</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
    <span class="cm">/* For demonstration purposes, we will encode the first 10 frames. */</span>
    <span class="k">if</span><span class="p">(</span><span class="n">frame_count</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">NvDsObjEncUsrArgs</span> <span class="n">frameData</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
      <span class="cm">/* Preset */</span>
      <span class="n">frameData</span><span class="p">.</span><span class="n">isFrame</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="cm">/* To be set by user */</span>
      <span class="n">frameData</span><span class="p">.</span><span class="n">saveImg</span> <span class="o">=</span> <span class="n">save_img</span><span class="p">;</span>
      <span class="n">frameData</span><span class="p">.</span><span class="n">attachUsrMeta</span> <span class="o">=</span> <span class="n">attach_user_meta</span><span class="p">;</span>
      <span class="cm">/* Set if Image scaling Required */</span>
      <span class="n">frameData</span><span class="p">.</span><span class="n">scaleImg</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
      <span class="n">frameData</span><span class="p">.</span><span class="n">scaledWidth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">frameData</span><span class="p">.</span><span class="n">scaledHeight</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="cm">/* Quality */</span>
      <span class="n">frameData</span><span class="p">.</span><span class="n">quality</span> <span class="o">=</span> <span class="mi">80</span><span class="p">;</span>
      <span class="cm">/* Main Function Call */</span>
      <span class="n">nvds_obj_enc_process</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frameData</span><span class="p">,</span> <span class="n">ip_surf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">frame_meta</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">guint</span> <span class="n">num_rects</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">l_obj</span> <span class="o">=</span> <span class="n">frame_meta</span><span class="o">-&gt;</span><span class="n">obj_meta_list</span><span class="p">;</span> <span class="n">l_obj</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">l_obj</span> <span class="o">=</span> <span class="n">l_obj</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">obj_meta</span> <span class="o">=</span> <span class="p">(</span><span class="n">NvDsObjectMeta</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">l_obj</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">obj_meta</span><span class="o">-&gt;</span><span class="n">class_id</span> <span class="o">==</span> <span class="n">PGIE_CLASS_ID_VEHICLE</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">vehicle_count</span><span class="o">++</span><span class="p">;</span>
        <span class="n">num_rects</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">obj_meta</span><span class="o">-&gt;</span><span class="n">class_id</span> <span class="o">==</span> <span class="n">PGIE_CLASS_ID_PERSON</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">person_count</span><span class="o">++</span><span class="p">;</span>
        <span class="n">num_rects</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="cm">/* Conditions that user needs to set to encode the detected objects of
       * interest. Here, by default all the detected objects are encoded.
       * For demonstration, we will encode the first object in the frame. */</span>
      <span class="k">if</span> <span class="p">((</span><span class="n">obj_meta</span><span class="o">-&gt;</span><span class="n">class_id</span> <span class="o">==</span> <span class="n">PGIE_CLASS_ID_PERSON</span>
              <span class="o">||</span> <span class="n">obj_meta</span><span class="o">-&gt;</span><span class="n">class_id</span> <span class="o">==</span> <span class="n">PGIE_CLASS_ID_VEHICLE</span><span class="p">)</span>
          <span class="o">&amp;&amp;</span> <span class="n">num_rects</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NvDsObjEncUsrArgs</span> <span class="n">objData</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
        <span class="cm">/* To be set by user */</span>
        <span class="n">objData</span><span class="p">.</span><span class="n">saveImg</span> <span class="o">=</span> <span class="n">save_img</span><span class="p">;</span>
        <span class="n">objData</span><span class="p">.</span><span class="n">attachUsrMeta</span> <span class="o">=</span> <span class="n">attach_user_meta</span><span class="p">;</span>
        <span class="cm">/* Set if Image scaling Required */</span>
        <span class="n">objData</span><span class="p">.</span><span class="n">scaleImg</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">objData</span><span class="p">.</span><span class="n">scaledWidth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">objData</span><span class="p">.</span><span class="n">scaledHeight</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="cm">/* Preset */</span>
        <span class="n">objData</span><span class="p">.</span><span class="n">objNum</span> <span class="o">=</span> <span class="n">num_rects</span><span class="p">;</span>
        <span class="cm">/* Quality */</span>
        <span class="n">objData</span><span class="p">.</span><span class="n">quality</span> <span class="o">=</span> <span class="mi">80</span><span class="p">;</span>
        <span class="cm">/*Main Function Call */</span>
        <span class="n">nvds_obj_enc_process</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">objData</span><span class="p">,</span> <span class="n">ip_surf</span><span class="p">,</span> <span class="n">obj_meta</span><span class="p">,</span> <span class="n">frame_meta</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">nvds_obj_enc_finish</span> <span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
  <span class="n">frame_count</span><span class="o">++</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">GST_PAD_PROBE_OK</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="第二步檢查usrmetadata是否的meta_type是不是nvds_crop_image_meta"><span class="mr-2">第二步，檢查usrMetaData是否的meta_type是不是NVDS_CROP_IMAGE_META</span><a href="#第二步檢查usrmetadata是否的meta_type是不是nvds_crop_image_meta" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>如果發現是NVDS_CROP_IMAGE_META，就儲存照片</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
</pre><td class="rouge-code"><pre><span class="cm">/* osd_sink_pad_buffer_probe will extract metadata received on OSD sink pad
 * and update params for drawing rectangle, object information. We also iterate
 * through the user meta of type "NVDS_CROP_IMAGE_META" to find image crop meta
 * and demonstrate how to access it.*/</span>
<span class="k">static</span> <span class="n">GstPadProbeReturn</span>
<span class="nf">osd_sink_pad_buffer_probe</span> <span class="p">(</span><span class="n">GstPad</span> <span class="o">*</span> <span class="n">pad</span><span class="p">,</span> <span class="n">GstPadProbeInfo</span> <span class="o">*</span> <span class="n">info</span><span class="p">,</span>
    <span class="n">gpointer</span> <span class="n">u_data</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">GstBuffer</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">GstBuffer</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

  <span class="n">guint</span> <span class="n">num_rects</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">NvDsObjectMeta</span> <span class="o">*</span><span class="n">obj_meta</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">guint</span> <span class="n">vehicle_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">guint</span> <span class="n">person_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">NvDsMetaList</span> <span class="o">*</span><span class="n">l_frame</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">NvDsMetaList</span> <span class="o">*</span><span class="n">l_obj</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">NvDsDisplayMeta</span> <span class="o">*</span><span class="n">display_meta</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">NvDsBatchMeta</span> <span class="o">*</span><span class="n">batch_meta</span> <span class="o">=</span> <span class="n">gst_buffer_get_nvds_batch_meta</span> <span class="p">(</span><span class="n">buf</span><span class="p">);</span>
  <span class="n">g_print</span> <span class="p">(</span><span class="s">"Running osd_sink_pad_buffer_probe...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">l_frame</span> <span class="o">=</span> <span class="n">batch_meta</span><span class="o">-&gt;</span><span class="n">frame_meta_list</span><span class="p">;</span> <span class="n">l_frame</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
      <span class="n">l_frame</span> <span class="o">=</span> <span class="n">l_frame</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NvDsFrameMeta</span> <span class="o">*</span><span class="n">frame_meta</span> <span class="o">=</span> <span class="p">(</span><span class="n">NvDsFrameMeta</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">l_frame</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="cm">/* To verify  encoded metadata of cropped frames, we iterate through the
    * user metadata of each frame and if a metadata of the type
    * 'NVDS_CROP_IMAGE_META' is found then we write that to a file as
    * implemented below.
    */</span>
    <span class="kt">char</span> <span class="n">fileFrameNameString</span><span class="p">[</span><span class="n">FILE_NAME_SIZE</span><span class="p">];</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">osd_string</span> <span class="o">=</span> <span class="s">"OSD"</span><span class="p">;</span>

    <span class="cm">/* For Demonstration Purposes we are writing metadata to jpeg images of
      * the first 10 frames only.
      * The files generated have an 'OSD' prefix. */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">frame_number</span> <span class="o">&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">NvDsUserMetaList</span> <span class="o">*</span><span class="n">usrMetaList</span> <span class="o">=</span> <span class="n">frame_meta</span><span class="o">-&gt;</span><span class="n">frame_user_meta_list</span><span class="p">;</span>
      <span class="kt">FILE</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">stream_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">usrMetaList</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NvDsUserMeta</span> <span class="o">*</span><span class="n">usrMetaData</span> <span class="o">=</span> <span class="p">(</span><span class="n">NvDsUserMeta</span> <span class="o">*</span><span class="p">)</span> <span class="n">usrMetaList</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">usrMetaData</span><span class="o">-&gt;</span><span class="n">base_meta</span><span class="p">.</span><span class="n">meta_type</span> <span class="o">==</span> <span class="n">NVDS_CROP_IMAGE_META</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">snprintf</span> <span class="p">(</span><span class="n">fileFrameNameString</span><span class="p">,</span> <span class="n">FILE_NAME_SIZE</span><span class="p">,</span> <span class="s">"%s_frame_%d_%d.jpg"</span><span class="p">,</span>
              <span class="n">osd_string</span><span class="p">,</span> <span class="n">frame_number</span><span class="p">,</span> <span class="n">stream_num</span><span class="o">++</span><span class="p">);</span>
          <span class="n">NvDsObjEncOutParams</span> <span class="o">*</span><span class="n">enc_jpeg_image</span> <span class="o">=</span>
              <span class="p">(</span><span class="n">NvDsObjEncOutParams</span> <span class="o">*</span><span class="p">)</span> <span class="n">usrMetaData</span><span class="o">-&gt;</span><span class="n">user_meta_data</span><span class="p">;</span>
          <span class="cm">/* Write to File */</span>
          <span class="n">file</span> <span class="o">=</span> <span class="n">fopen</span> <span class="p">(</span><span class="n">fileFrameNameString</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">);</span>
          <span class="n">fwrite</span> <span class="p">(</span><span class="n">enc_jpeg_image</span><span class="o">-&gt;</span><span class="n">outBuffer</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">),</span>
              <span class="n">enc_jpeg_image</span><span class="o">-&gt;</span><span class="n">outLen</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
          <span class="n">fclose</span> <span class="p">(</span><span class="n">file</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">usrMetaList</span> <span class="o">=</span> <span class="n">usrMetaList</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">l_obj</span> <span class="o">=</span> <span class="n">frame_meta</span><span class="o">-&gt;</span><span class="n">obj_meta_list</span><span class="p">;</span> <span class="n">l_obj</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">l_obj</span> <span class="o">=</span> <span class="n">l_obj</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">obj_meta</span> <span class="o">=</span> <span class="p">(</span><span class="n">NvDsObjectMeta</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">l_obj</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">obj_meta</span><span class="o">-&gt;</span><span class="n">class_id</span> <span class="o">==</span> <span class="n">PGIE_CLASS_ID_VEHICLE</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">vehicle_count</span><span class="o">++</span><span class="p">;</span>
        <span class="n">num_rects</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">obj_meta</span><span class="o">-&gt;</span><span class="n">class_id</span> <span class="o">==</span> <span class="n">PGIE_CLASS_ID_PERSON</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">person_count</span><span class="o">++</span><span class="p">;</span>
        <span class="n">num_rects</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="cm">/* To verify  encoded metadata of cropped objects, we iterate through the
       * user metadata of each object and if a metadata of the type
       * 'NVDS_CROP_IMAGE_META' is found then we write that to a file as
       * implemented below.
       */</span>
      <span class="kt">char</span> <span class="n">fileObjNameString</span><span class="p">[</span><span class="n">FILE_NAME_SIZE</span><span class="p">];</span>

      <span class="cm">/* For Demonstration Purposes we are writing metadata to jpeg images of
       * vehicles or persons for the first 100 frames only.
       * The files generated have a 'OSD' prefix. */</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">frame_number</span> <span class="o">&lt;</span> <span class="mi">100</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">obj_meta</span><span class="o">-&gt;</span><span class="n">class_id</span> <span class="o">==</span> <span class="n">PGIE_CLASS_ID_PERSON</span>
              <span class="o">||</span> <span class="n">obj_meta</span><span class="o">-&gt;</span><span class="n">class_id</span> <span class="o">==</span> <span class="n">PGIE_CLASS_ID_VEHICLE</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">NvDsUserMetaList</span> <span class="o">*</span><span class="n">usrMetaList</span> <span class="o">=</span> <span class="n">obj_meta</span><span class="o">-&gt;</span><span class="n">obj_user_meta_list</span><span class="p">;</span>
        <span class="kt">FILE</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">usrMetaList</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">NvDsUserMeta</span> <span class="o">*</span><span class="n">usrMetaData</span> <span class="o">=</span> <span class="p">(</span><span class="n">NvDsUserMeta</span> <span class="o">*</span><span class="p">)</span> <span class="n">usrMetaList</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">usrMetaData</span><span class="o">-&gt;</span><span class="n">base_meta</span><span class="p">.</span><span class="n">meta_type</span> <span class="o">==</span> <span class="n">NVDS_CROP_IMAGE_META</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">NvDsObjEncOutParams</span> <span class="o">*</span><span class="n">enc_jpeg_image</span> <span class="o">=</span>
                <span class="p">(</span><span class="n">NvDsObjEncOutParams</span> <span class="o">*</span><span class="p">)</span> <span class="n">usrMetaData</span><span class="o">-&gt;</span><span class="n">user_meta_data</span><span class="p">;</span>

            <span class="n">snprintf</span> <span class="p">(</span><span class="n">fileObjNameString</span><span class="p">,</span> <span class="n">FILE_NAME_SIZE</span><span class="p">,</span> <span class="s">"%s_%d_%d_%d_%s.jpg"</span><span class="p">,</span>
                <span class="n">osd_string</span><span class="p">,</span> <span class="n">frame_number</span><span class="p">,</span> <span class="n">frame_meta</span><span class="o">-&gt;</span><span class="n">batch_id</span><span class="p">,</span> <span class="n">num_rects</span><span class="p">,</span>
                <span class="n">obj_meta</span><span class="o">-&gt;</span><span class="n">obj_label</span><span class="p">);</span>
            <span class="cm">/* Write to File */</span>
            <span class="n">file</span> <span class="o">=</span> <span class="n">fopen</span> <span class="p">(</span><span class="n">fileObjNameString</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">);</span>
            <span class="n">fwrite</span> <span class="p">(</span><span class="n">enc_jpeg_image</span><span class="o">-&gt;</span><span class="n">outBuffer</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">),</span>
                <span class="n">enc_jpeg_image</span><span class="o">-&gt;</span><span class="n">outLen</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
            <span class="n">fclose</span> <span class="p">(</span><span class="n">file</span><span class="p">);</span>
            <span class="n">usrMetaList</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">usrMetaList</span> <span class="o">=</span> <span class="n">usrMetaList</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">display_meta</span> <span class="o">=</span> <span class="n">nvds_acquire_display_meta_from_pool</span> <span class="p">(</span><span class="n">batch_meta</span><span class="p">);</span>
    <span class="n">NvOSD_TextParams</span> <span class="o">*</span><span class="n">txt_params</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">display_meta</span><span class="o">-&gt;</span><span class="n">text_params</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">txt_params</span><span class="o">-&gt;</span><span class="n">display_text</span> <span class="o">=</span> <span class="n">g_malloc0</span> <span class="p">(</span><span class="n">MAX_DISPLAY_LEN</span><span class="p">);</span>
    <span class="n">offset</span> <span class="o">=</span>
        <span class="n">snprintf</span> <span class="p">(</span><span class="n">txt_params</span><span class="o">-&gt;</span><span class="n">display_text</span><span class="p">,</span> <span class="n">MAX_DISPLAY_LEN</span><span class="p">,</span> <span class="s">"Person = %d "</span><span class="p">,</span>
        <span class="n">person_count</span><span class="p">);</span>
    <span class="n">offset</span> <span class="o">=</span>
        <span class="n">snprintf</span> <span class="p">(</span><span class="n">txt_params</span><span class="o">-&gt;</span><span class="n">display_text</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">MAX_DISPLAY_LEN</span><span class="p">,</span>
        <span class="s">"Vehicle = %d "</span><span class="p">,</span> <span class="n">vehicle_count</span><span class="p">);</span>

    <span class="cm">/* Now set the offsets where the string should appear */</span>
    <span class="n">txt_params</span><span class="o">-&gt;</span><span class="n">x_offset</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="n">txt_params</span><span class="o">-&gt;</span><span class="n">y_offset</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>

    <span class="cm">/* Font , font-color and font-size */</span>
    <span class="n">txt_params</span><span class="o">-&gt;</span><span class="n">font_params</span><span class="p">.</span><span class="n">font_name</span> <span class="o">=</span> <span class="s">"Serif"</span><span class="p">;</span>
    <span class="n">txt_params</span><span class="o">-&gt;</span><span class="n">font_params</span><span class="p">.</span><span class="n">font_size</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="n">txt_params</span><span class="o">-&gt;</span><span class="n">font_params</span><span class="p">.</span><span class="n">font_color</span><span class="p">.</span><span class="n">red</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">txt_params</span><span class="o">-&gt;</span><span class="n">font_params</span><span class="p">.</span><span class="n">font_color</span><span class="p">.</span><span class="n">green</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">txt_params</span><span class="o">-&gt;</span><span class="n">font_params</span><span class="p">.</span><span class="n">font_color</span><span class="p">.</span><span class="n">blue</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">txt_params</span><span class="o">-&gt;</span><span class="n">font_params</span><span class="p">.</span><span class="n">font_color</span><span class="p">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

    <span class="cm">/* Text background color */</span>
    <span class="n">txt_params</span><span class="o">-&gt;</span><span class="n">set_bg_clr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">txt_params</span><span class="o">-&gt;</span><span class="n">text_bg_clr</span><span class="p">.</span><span class="n">red</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">txt_params</span><span class="o">-&gt;</span><span class="n">text_bg_clr</span><span class="p">.</span><span class="n">green</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">txt_params</span><span class="o">-&gt;</span><span class="n">text_bg_clr</span><span class="p">.</span><span class="n">blue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">txt_params</span><span class="o">-&gt;</span><span class="n">text_bg_clr</span><span class="p">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

    <span class="n">nvds_add_display_meta_to_frame</span> <span class="p">(</span><span class="n">frame_meta</span><span class="p">,</span> <span class="n">display_meta</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">g_print</span> <span class="p">(</span><span class="s">"Frame Number = %d Number of objects = %d "</span>
      <span class="s">"Vehicle Count = %d Person Count = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
      <span class="n">frame_number</span><span class="p">,</span> <span class="n">num_rects</span><span class="p">,</span> <span class="n">vehicle_count</span><span class="p">,</span> <span class="n">person_count</span><span class="p">);</span>
  <span class="n">frame_number</span><span class="o">++</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">GST_PAD_PROBE_OK</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><h1 id="加入自己客製的的metadata">加入自己客製的的metadata</h1><p>參考deepstream-user-metadata-test範例的nvinfer_src_pad_buffer_probe</p><ol><li>有四個東西需要使用者自行提供<ol><li>user_meta_data : pointer to User specific meta data<li>meta_type : Metadata type that user sets to identify its metadata<li>copy_func : Metadata copy or transform function to be provided when there is buffer transformation<li>release_func : Metadata release function to be provided when it is no longer required.</ol><li>這個範例添加一個亂數到metadata上面，以下是要達成這個目標要準備的函式<ol><li>user_meta_data ```c void <em>set_metadata_ptr() { int i = 0; gchar *user_metadata = (gchar</em>)g_malloc0(USER_ARRAY_SIZE);</ol></ol><p>g_print(“\n<strong>**</strong><strong>**</strong><em>**</em> Setting user metadata array of 16 on nvinfer src pad\n”); for(i = 0; i &lt; USER_ARRAY_SIZE; i++) { user_metadata[i] = rand() % 255; g_print(“user_meta_data [%d] = %d\n”, i, user_metadata[i]); } return (void *)user_metadata; }</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>
   2. meta_type
記得要在在probe function裡面定義變數
```c
/** set the user metadata type */
#define NVDS_USER_FRAME_META_EXAMPLE (nvds_get_user_meta_type("NVIDIA.NVINFER.USER_META"))
NvDsMetaType user_meta_type = NVDS_USER_FRAME_META_EXAMPLE;
</pre></table></code></div></div><ol><li>copy_func</ol><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="cm">/* copy function set by user. "data" holds a pointer to NvDsUserMeta*/</span>
<span class="k">static</span> <span class="n">gpointer</span> <span class="nf">copy_user_meta</span><span class="p">(</span><span class="n">gpointer</span> <span class="n">data</span><span class="p">,</span> <span class="n">gpointer</span> <span class="n">user_data</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">NvDsUserMeta</span> <span class="o">*</span><span class="n">user_meta</span> <span class="o">=</span> <span class="p">(</span><span class="n">NvDsUserMeta</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
  <span class="n">gchar</span> <span class="o">*</span><span class="n">src_user_metadata</span> <span class="o">=</span> <span class="p">(</span><span class="n">gchar</span><span class="o">*</span><span class="p">)</span><span class="n">user_meta</span><span class="o">-&gt;</span><span class="n">user_meta_data</span><span class="p">;</span>
  <span class="n">gchar</span> <span class="o">*</span><span class="n">dst_user_metadata</span> <span class="o">=</span> <span class="p">(</span><span class="n">gchar</span><span class="o">*</span><span class="p">)</span><span class="n">g_malloc0</span><span class="p">(</span><span class="n">USER_ARRAY_SIZE</span><span class="p">);</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="n">dst_user_metadata</span><span class="p">,</span> <span class="n">src_user_metadata</span><span class="p">,</span> <span class="n">USER_ARRAY_SIZE</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">gpointer</span><span class="p">)</span><span class="n">dst_user_metadata</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><ol><li>release_func</ol><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="cm">/* release function set by user. "data" holds a pointer to NvDsUserMeta*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">release_user_meta</span><span class="p">(</span><span class="n">gpointer</span> <span class="n">data</span><span class="p">,</span> <span class="n">gpointer</span> <span class="n">user_data</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">NvDsUserMeta</span> <span class="o">*</span><span class="n">user_meta</span> <span class="o">=</span> <span class="p">(</span><span class="n">NvDsUserMeta</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="n">user_meta</span><span class="o">-&gt;</span><span class="n">user_meta_data</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">g_free</span><span class="p">(</span><span class="n">user_meta</span><span class="o">-&gt;</span><span class="n">user_meta_data</span><span class="p">);</span>
    <span class="n">user_meta</span><span class="o">-&gt;</span><span class="n">user_meta_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

</pre></table></code></div></div><ol><li>新增一個probe把資料放入metadata ```c /* Set nvds user metadata at frame level. User need to set 4 parameters after<ul><li>acquring user meta from pool using nvds_acquire_user_meta_from_pool(). *<li>Below parameters are required to be set.<li><ol><li>user_meta_data : pointer to User specific meta data</ol><li><ol><li>meta_type: Metadata type that user sets to identify its metadata</ol><li><ol><li>copy_func: Metadata copy or transform function to be provided when there</ol><li>is buffer transformation<li><ol><li>release_func: Metadata release function to be provided when it is no</ol><li>longer required. *<li>osd_sink_pad_buffer_probe will extract metadata received on OSD sink pad<li>and update params for drawing rectangle, object information etc. */</ul></ol><p>static GstPadProbeReturn nvinfer_src_pad_buffer_probe (GstPad * pad, GstPadProbeInfo * info, gpointer u_data) { GstBuffer *buf = (GstBuffer *) info-&gt;data; NvDsMetaList * l_frame = NULL; NvDsUserMeta *user_meta = NULL; NvDsMetaType user_meta_type = NVDS_USER_FRAME_META_EXAMPLE;</p><p>NvDsBatchMeta *batch_meta = gst_buffer_get_nvds_batch_meta (buf);</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre>for (l_frame = batch_meta-&gt;frame_meta_list; l_frame != NULL;
  l_frame = l_frame-&gt;next) {
    NvDsFrameMeta *frame_meta = (NvDsFrameMeta *) (l_frame-&gt;data);

    /* Acquire NvDsUserMeta user meta from pool */
    user_meta = nvds_acquire_user_meta_from_pool(batch_meta);

    /* Set NvDsUserMeta below */
    user_meta-&gt;user_meta_data = (void *)set_metadata_ptr();
    user_meta-&gt;base_meta.meta_type = user_meta_type;
    user_meta-&gt;base_meta.copy_func = (NvDsMetaCopyFunc)copy_user_meta;
    user_meta-&gt;base_meta.release_func = (NvDsMetaReleaseFunc)release_user_meta;

    /* We want to add NvDsUserMeta to frame level */
    nvds_add_user_meta_to_frame(frame_meta, user_meta);
}
return GST_PAD_PROBE_OK; } ```
</pre></table></code></div></div><h1 id="將客製化訊息傳換json以之後發送訊息">將客製化訊息傳換json以之後發送訊息</h1><p>nvmsgconv的功能:<br /> 利用<code class="language-plaintext highlighter-rouge">NVDS_EVENT_MSG_META</code>metadata來產生JSON格式的”DeepStream Schema” payload。 所產生的payload會以<code class="language-plaintext highlighter-rouge">NVDS_META_PAYLOAD</code>的型態儲存到buffer。 除了<code class="language-plaintext highlighter-rouge">NvDsEventMsgMeta</code>定義的常用訊號結構，使用者還可以自訂客製化物件並加到<code class="language-plaintext highlighter-rouge">NVDS_EVENT_MSG_META</code>metadata。要加入自定義訊息<code class="language-plaintext highlighter-rouge">NvDsEventMsgMeta</code>提供”extMsg”和”extMsgSize”欄位。使用者可以把自定義的structure指針assign給”extMsg”，並且在”extMsgSize”指令資料大小。</p><p>以deepstream-test4為例，在這裡message放入了客製化訊息NvDsVehicleObject和NvDsPersonObject，如果想要客製化自己的訊息就必須要自己定義。</p><p>自製自己的客製化訊息 可以參考 <code class="language-plaintext highlighter-rouge">/opt/nvidia/deepstream/deepstream-6.2/sources/libs/nvmsgconv/deepstream_schema/eventmsg_payload.cpp</code>參考客製化訊息如何定義轉換成json</p><p>nvmsgconv的原始碼 /opt/nvidia/deepstream/deepstream-6.2/sources/gst-plugins/gst-nvmsgconv /opt/nvidia/deepstream/deepstream-6.2/sources/libs/nvmsgconv</p><ul><li>nvmsgconv開啟除錯功能 debug-payload-dir : Absolute path of the directory to dump payloads for debugging</ul><ol><li>以deepstream-test4為例，首先將模型的偵測結果<code class="language-plaintext highlighter-rouge">NvDsObjectMeta</code>轉換成<code class="language-plaintext highlighter-rouge">NvDsEventMsgMeta</code>，在這步將訊息struct加到<code class="language-plaintext highlighter-rouge">extMsg</code>上<li>將製作好的<code class="language-plaintext highlighter-rouge">NvDsEventMsgMeta</code>加進buffer裡面，metadata為<code class="language-plaintext highlighter-rouge">NvDsUserMeta</code>，在這一步也要指定meta_copy_func、meta_free_func</ol><h1 id="mvmsgbroker使用方法">mvmsgbroker使用方法</h1><p>以下將以rabbitmq為範例</p><ol><li>安裝rabbitmq client 說明文件在<code class="language-plaintext highlighter-rouge">/opt/nvidia/deepstream/deepstream/sources/libs/amqp_protocol_adaptor</code>的readme.md<div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre> git clone <span class="nt">-b</span> v0.8.0  <span class="nt">--recursive</span> https://github.com/alanxz/rabbitmq-c.git
 <span class="nb">cd </span>rabbitmq-c
 <span class="nb">mkdir </span>build <span class="o">&amp;&amp;</span> <span class="nb">cd </span>build
 cmake ..
 cmake <span class="nt">--build</span> <span class="nb">.</span>
 <span class="nb">sudo cp </span>librabbitmq/librabbitmq.so.4 /opt/nvidia/deepstream/deepstream/lib/
 <span class="nb">sudo </span>ldconfig
</pre></table></code></div></div><li>安裝rabbitmq server</ol><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="c">#Install rabbitmq on your ubuntu system: https://www.rabbitmq.com/install-debian.html</span>
<span class="c">#The “Using rabbitmq.com APT Repository” procedure is known to work well</span>

 <span class="nb">sudo </span>apt-get <span class="nb">install </span>rabbitmq-server

<span class="c">#Ensure rabbitmq service has started by running (should be the case):</span>
 <span class="nb">sudo </span>service rabbitmq-server status

<span class="c">#Otherwise</span>
 <span class="nb">sudo </span>service rabbitmq-server start
</pre></table></code></div></div><ol><li>設定連線詳細資訊<li>建立<code class="language-plaintext highlighter-rouge">cfg_amqp.txt</code>連線資訊檔(/opt/nvidia/deepstream/deepstream/sources/libs/amqp_protocol_adaptor 有範例)，並且傳給nvmsgbroker。內容範例如下</ol><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="o">[</span>message-broker]
<span class="nb">hostname</span> <span class="o">=</span> localhost
port <span class="o">=</span> 5672
username <span class="o">=</span> guest
password <span class="o">=</span> guest
exchange <span class="o">=</span> amq.topic
topic <span class="o">=</span> topicname
amqp-framesize <span class="o">=</span> 131072
<span class="c">#share-connection = 1</span>
</pre></table></code></div></div><ul><li>exchange: 預設的exchange是<code class="language-plaintext highlighter-rouge">amq.topic</code>，可以更改成其他的<li>Topic : 設定要發送的topic名稱<li>share-connection : Uncommenting this field signifies that the connection created can be shared with other components within the same process.</ul><ol><li>直接將連線資訊傳給<code class="language-plaintext highlighter-rouge">msgapi_connect_ptr</code></ol><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre> <span class="n">conn_handle</span> <span class="o">=</span> <span class="n">msgapi_connect_ptr</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">"url;port;username;password"</span><span class="p">,(</span><span class="n">nvds_msgapi_connect_cb_t</span><span class="p">)</span> <span class="n">sample_msgapi_connect_cb</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">CFG_FILE</span><span class="p">);</span>
</pre></table></code></div></div><ol><li>測試用程式 在<code class="language-plaintext highlighter-rouge">/opt/nvidia/deepstream/deepstream/sources/libs/amqp_protocol_adaptor</code>有測試用的程式<code class="language-plaintext highlighter-rouge">test_amqp_proto_async.c</code>和<code class="language-plaintext highlighter-rouge">test_amqp_proto_sync.c</code>，可以用來測試連線是否成功，編譯方式如下<div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre> make <span class="nt">-f</span> Makefile.test
 ./test_amqp_proto_async
 ./test_amqp_proto_sync
</pre></table></code></div></div><p>注意:</p><ul><li>你可能須要root權限才能在這個資料夾編譯程式<li>libnvds_amqp_proto.so 位於 /opt/nvidia/deepstream/deepstream-<version>/lib/</version></ul><li>測試和驗證發送出去的訊息<ul><li>建立exchange , queue，並且將他們綁定在一起</ul></ol><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="c"># Rabbitmq management:</span>
It comes with a <span class="nb">command </span>line tool which you can use to create/configure all of your queues/exchanges/etc
https://www.rabbitmq.com/management.html

<span class="c"># Install rabbitmq management plugin:</span>
<span class="nb">sudo </span>rabbitmq-plugins <span class="nb">enable </span>rabbitmq_management

<span class="c"># Use the default exchange amq.topic</span>
OR create an exchange as below, the same name as the one you specify within the cfg_amqp.txt
<span class="c">#sudo rabbitmqadmin -u guest -p guest -V / declare exchange name=myexchange type=topic</span>

<span class="c"># Create a Queue</span>
<span class="nb">sudo </span>rabbitmqadmin <span class="nt">-u</span> guest <span class="nt">-p</span> guest <span class="nt">-V</span> / <span class="nb">declare </span>queue <span class="nv">name</span><span class="o">=</span>myqueue <span class="nv">durable</span><span class="o">=</span><span class="nb">false </span><span class="nv">auto_delete</span><span class="o">=</span><span class="nb">true</span>

<span class="c">#Bind Queue to exchange with routhing_key specification</span>
rabbitmqadmin <span class="nt">-u</span> guest <span class="nt">-p</span> guest <span class="nt">-V</span> / <span class="nb">declare </span>binding <span class="nb">source</span><span class="o">=</span>amq.topic <span class="nv">destination</span><span class="o">=</span>myqueue <span class="nv">routing_key</span><span class="o">=</span>topicname

<span class="c">#To check if the queues were actually created, execute:</span>
<span class="nv">$ </span><span class="nb">sudo </span>rabbitmqctl list_queues
Listing queues
myqueue      0
</pre></table></code></div></div><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>* 接收訊息 ```bash #Install the amqp-tools sudo apt-get install amqp-tools
</pre></table></code></div></div><p>cat «EOF &gt; test_amqp_recv.sh while read -r line; do echo “$line” done EOF</p><p>chmod +x test_amqp_recv.sh</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>
    * 執行consumer
```bash
amqp-consume  -q "myqueue" -r "topicname" -e "amq.topic" ./test_amqp_recv.sh
</pre></table></code></div></div><h1 id="混用c-和-c-程式">混用c 和 c++ 程式</h1><p>https://hackmd.io/@rhythm/HyOxzDkmD<br /> https://embeddedartistry.com/blog/2017/05/01/mixing-c-and-c-extern-c/</p><h1 id="async-property">async property</h1><p>某些狀況下async property 設為true會讓pipeline卡住，還需要進一步了解原因</p><h1 id="nvmsgconv-詳細payload設定">nvmsgconv 詳細payload設定</h1><p>在<code class="language-plaintext highlighter-rouge">/opt/nvidia/deepstream/deepstream/sources/libs/nvmsgconv/nvmsgconv.cpp</code>裡面可以看到<code class="language-plaintext highlighter-rouge">nvds_msg2p_ctx_create</code>這個函式，是用來產出payload的函式。在nvmsgconv讀取的yaml檔裡面可以設定的group和屬性如下</p><h2 id="sensor"><span class="mr-2">sensor</span><a href="#sensor" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>enable : 是否啟用這個sensor<li>id : 對應NvDsEventMsgMeta的sensorId<li>type :<li>description<li>location<ul><li>lat;lon;alt的格式</ul><li>coordinate<ul><li>x;y;z的格式</ul></ul><h2 id="place"><span class="mr-2">place</span><a href="#place" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h2 id="analytics"><span class="mr-2">analytics</span><a href="#analytics" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h2 id="nvdseventmsgmeta-轉換成json的詳細實作"><span class="mr-2">NvDsEventMsgMeta 轉換成json的詳細實作</span><a href="#nvdseventmsgmeta-轉換成json的詳細實作" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>在<code class="language-plaintext highlighter-rouge">/opt/nvidia/deepstream/deepstream-6.2/sources/libs/nvmsgconv/deepstream_schema/eventmsg_payload.cpp</code>這個程式裡，分別有sensor, place, analytics的轉換實作</p><h1 id="客製化nvmsgconv-payload">客製化nvmsgconv payload</h1><p>如果要客製化payload的話，可以參考<code class="language-plaintext highlighter-rouge">/opt/nvidia/deepstream/deepstream-6.2/sources/libs/nvmsgconv/deepstream_schema/eventmsg_payload.cpp</code>裡面的實作，並且加入自己需要的客製化payload。首先將整個<code class="language-plaintext highlighter-rouge">/opt/nvidia/deepstream/deepstream-6.2/sources/libs/nvmsgconv</code>複製到其他資料夾並且準備編譯環境</p><h2 id="編譯環境"><span class="mr-2">編譯環境</span><a href="#編譯環境" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>這裡介紹在Ubuntu20.04的桌上型主機上環境的配置方法，Jetson的環境配置方法可能略有不同。</p><ul><li>下載並且編譯protobuf 在Ubuntu20.04下使用apt-get install protobuf 只會安裝到protobuf 3.6的版本，而許多標頭檔要到3.7以上才有，而且不能超過3.19，以免某些標頭檔又遺失。如果中間有步驟做錯，只要還沒<code class="language-plaintext highlighter-rouge">make install</code>，建議直接刪除protobuf的資料夾，重新下載並且編譯。</ul><p>首先直接從github下載protobuf原始碼</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>git clone https://github.com/protocolbuffers/protobuf.git
</pre></table></code></div></div><p>切換版本到v3.19.6，並且更新submodule。</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nb">cd </span>protobuf
git submodule update <span class="nt">--init</span> <span class="nt">--recursive</span>
./autogen.sh
</pre></table></code></div></div><p>編譯並且安裝，<code class="language-plaintext highlighter-rouge">make check</code>過程中如果有錯誤，編譯出來的程式可能會有部分功能遺失。</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>./configure
make
make check
<span class="nb">sudo </span>make <span class="nb">install
sudo </span>ldconfig <span class="c"># refresh shared library cache.</span>
</pre></table></code></div></div><h2 id="編譯客製化的nvmsgconv"><span class="mr-2">編譯客製化的nvmsgconv</span><a href="#編譯客製化的nvmsgconv" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>接下來進到nvmsgconv的資料夾，修改一下最後產出的lib檔案名稱和install的位置，然後用<code class="language-plaintext highlighter-rouge">make</code>指令編譯</p><h2 id="預訓練模型"><span class="mr-2">預訓練模型</span><a href="#預訓練模型" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>/opt/nvidia/deepstream/deepstream-6.2/samples/models/tao_pretrained_mod els/trafficcamnet</p><h1 id="usb相機">usb相機</h1><p>https://docs.nvidia.com/jetson/archives/r35.4.1/DeveloperGuide/text/SD/CameraDevelopment/CameraSoftwareDevelopmentSolution.html#applications-using-gstreamer-with-the-nvarguscamerasrc-plugin</p><h2 id="儲存影像"><span class="mr-2">儲存影像</span><a href="#儲存影像" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>https://forums.developer.nvidia.com/t/drawn-rectangle-is-not-available-on-encoded-frame/178022/7?u=jenhao</p><h1 id="元件速度測量">元件速度測量</h1><p>https://forums.developer.nvidia.com/t/deepstream-sdk-faq/80236/12?u=jenhao</p><p>參考:<br /> https://www.gclue.jp/2022/06/gstreamer.html</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/%E6%B7%B1%E5%BA%A6%E5%AD%B8%E7%BF%92%E5%B7%A5%E5%85%B7/'>深度學習工具</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/deepstream/" class="post-tag no-text-decoration" >deepstream</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=deepstream%E6%95%99%E5%AD%B8+-+Steven&url=https%3A%2F%2Fjenhaoyang.github.io%2F%2Fposts%2Fdeepstream%25E6%2595%2599%25E5%25AD%25B8%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=deepstream%E6%95%99%E5%AD%B8+-+Steven&u=https%3A%2F%2Fjenhaoyang.github.io%2F%2Fposts%2Fdeepstream%25E6%2595%2599%25E5%25AD%25B8%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fjenhaoyang.github.io%2F%2Fposts%2Fdeepstream%25E6%2595%2599%25E5%25AD%25B8%2F&text=deepstream%E6%95%99%E5%AD%B8+-+Steven" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Windows-NTP%E6%A0%A1%E6%99%82/">Windows-NTP校時</a><li><a href="/posts/Gstreamer%E4%BD%BF%E7%94%A8%E7%AD%86%E8%A8%98/">Gstreamer使用筆記</a><li><a href="/posts/ubuntu%E8%A8%AD%E5%AE%9Ahome%E7%9B%AE%E9%8C%84%E5%88%B0%E5%AE%9A%E5%8F%A6%E4%B8%80%E9%A1%86%E7%A1%AC%E7%A2%9F/">Ubuntu設定home目錄到定另一顆硬碟</a><li><a href="/posts/Linux%E4%B8%8B%E7%9A%84Docker%E6%9B%B4%E6%94%B9image%E5%84%B2%E5%AD%98%E4%BD%8D%E7%BD%AE/">Linux下的Docker更改image儲存位置</a><li><a href="/posts/tensorrt%E7%B3%BB%E5%88%97-%E4%B8%80-%E7%92%B0%E5%A2%83%E8%A8%AD%E5%AE%9A/">TensorRT系列(一)環境設定</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ubuntu/">ubuntu</a> <a class="post-tag" href="/tags/cmake/">cmake</a> <a class="post-tag" href="/tags/cpp/">cpp</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/deepstream/">deepstream</a> <a class="post-tag" href="/tags/peopleflow/">peopleflow</a> <a class="post-tag" href="/tags/pythoncpp/">pythoncpp</a> <a class="post-tag" href="/tags/ssh/">ssh</a> <a class="post-tag" href="/tags/ubuntu/">Ubuntu</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/deepstream-tracker%E5%8F%83%E6%95%B8%E8%AA%BF%E6%95%B4/"><div class="card-body"> <em class="small" data-ts="1686803280" data-df="ll" > Jun 15, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>deepstream-tracker參數調整</h3><div class="text-muted small"><p> Accuracy-Performance Tradeoffs 下面這些參數的調整將會影響到準確度和效能。 Visual Feature Types and Feature Sizes Visual feature types useColorNames useHog Feature sizes featureImgSizeLevel searchRegionPadd...</p></div></div></a></div><div class="card"> <a href="/posts/gstreamer%E5%9F%BA%E7%A4%8E%E6%95%99%E5%AD%B8/"><div class="card-body"> <em class="small" data-ts="1671614280" data-df="ll" > Dec 21, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>GStreamer基礎教學</h3><div class="text-muted small"><p> GObject 和 GLib GStreamer建立在GObject和GLib之上，熟悉GObject和GLib對於學習GStreamer會有幫助，要區分目前的函示是屬於GStreamer還是GLib的方法就是GStreamer的函式是gst_開頭，而GLib的函式是g_開頭 1.簡單範例 範例 下面程式碼是一個最基礎的GStreamer範例basic-tutorial-1.c #incl...</p></div></div></a></div><div class="card"> <a href="/posts/%E7%B7%A8%E8%AD%AFonnxruntime/"><div class="card-body"> <em class="small" data-ts="1655803680" data-df="ll" > Jun 21, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>編譯onnxruntime Tensorrt ExecutionProvider</h3><div class="text-muted small"><p> 1. 安裝CUDA、cuDNN、Tensorrt 我的環境 Windows10 Visual Studio 2019(注意 先安裝visual studio 再安裝CUDA，因為CUDA包含給visual studio使用的原件) cmake: 3.24.0 CUDA: 11.4 cuDNN: 8.2 Tensorrt:8.2.3.0 2.下載onnxrunt...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/ubuntu%E8%A8%AD%E5%AE%9Ahome%E7%9B%AE%E9%8C%84%E5%88%B0%E5%AE%9A%E5%8F%A6%E4%B8%80%E9%A1%86%E7%A1%AC%E7%A2%9F/" class="btn btn-outline-primary" prompt="Older"><p>Ubuntu設定home目錄到定另一顆硬碟</p></a> <a href="/posts/ubuntu%E8%A8%AD%E5%AE%9Avnc%E9%81%A0%E7%AB%AF%E6%A1%8C%E9%9D%A2/" class="btn btn-outline-primary" prompt="Newer"><p>Ubuntu設定VNC遠端桌面</p></a></div><script type="text/javascript"> $(function () { const origin = "https://giscus.app"; const iframe = "iframe.giscus-frame"; const lightTheme = "light"; const darkTheme = "dark_dimmed"; let initTheme = lightTheme; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = darkTheme; } let giscusAttributes = { "src": "https://giscus.app/client.js", "data-repo": "jenhaoyang/jenhaoyang.github.io", "data-repo-id": "R_kgDOGONpkw", "data-category": "Announcements", "data-category-id": "DIC_kwDOGONpk84CPyux", "data-mapping": "pathname", "data-reactions-enabled": "1", "data-emit-metadata": "0", "data-theme": initTheme, "data-input-position": "bottom", "data-lang": "en", "crossorigin": "anonymous", "async": "" }; let giscusScript = document.createElement("script"); Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value)); document.getElementById("tail-wrapper").appendChild(giscusScript); addEventListener("message", (event) => { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* global theme mode changed */ const mode = event.data.message; const theme = (mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme); const message = { setConfig: { theme: theme } }; const giscus = document.querySelector(iframe).contentWindow; giscus.postMessage({ giscus: message }, origin); } }); }); </script></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://github.com/jenhaoyang">Steven Yang</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ubuntu/">ubuntu</a> <a class="post-tag" href="/tags/cmake/">cmake</a> <a class="post-tag" href="/tags/cpp/">cpp</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/deepstream/">deepstream</a> <a class="post-tag" href="/tags/peopleflow/">peopleflow</a> <a class="post-tag" href="/tags/pythoncpp/">pythoncpp</a> <a class="post-tag" href="/tags/ssh/">ssh</a> <a class="post-tag" href="/tags/ubuntu/">Ubuntu</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-YD5Z1Y7D6R"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-YD5Z1Y7D6R'); }); </script>
