<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="GStreamer基礎教學" /><meta property="og:locale" content="en" /><meta name="description" content="GObject 和 GLib GStreamer建立在GObject和GLib之上，熟悉GObject和GLib對於學習GStreamer會有幫助，要區分目前的函示是屬於GStreamer還是GLib的方法就是GStreamer的函式是gst_開頭，而GLib的函式是g_開頭" /><meta property="og:description" content="GObject 和 GLib GStreamer建立在GObject和GLib之上，熟悉GObject和GLib對於學習GStreamer會有幫助，要區分目前的函示是屬於GStreamer還是GLib的方法就是GStreamer的函式是gst_開頭，而GLib的函式是g_開頭" /><link rel="canonical" href="https://jenhaoyang.github.io//posts/gstreamer%E5%9F%BA%E7%A4%8E%E6%95%99%E5%AD%B8/" /><meta property="og:url" content="https://jenhaoyang.github.io//posts/gstreamer%E5%9F%BA%E7%A4%8E%E6%95%99%E5%AD%B8/" /><meta property="og:site_name" content="Steven" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-12-21T17:18:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="GStreamer基礎教學" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-08-17T08:03:06+08:00","datePublished":"2022-12-21T17:18:00+08:00","description":"GObject 和 GLib GStreamer建立在GObject和GLib之上，熟悉GObject和GLib對於學習GStreamer會有幫助，要區分目前的函示是屬於GStreamer還是GLib的方法就是GStreamer的函式是gst_開頭，而GLib的函式是g_開頭","headline":"GStreamer基礎教學","mainEntityOfPage":{"@type":"WebPage","@id":"https://jenhaoyang.github.io//posts/gstreamer%E5%9F%BA%E7%A4%8E%E6%95%99%E5%AD%B8/"},"url":"https://jenhaoyang.github.io//posts/gstreamer%E5%9F%BA%E7%A4%8E%E6%95%99%E5%AD%B8/"}</script><title>GStreamer基礎教學 | Steven</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Steven"><meta name="application-name" content="Steven"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/favicons/android-chrome-512x512.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Steven</a></div><div class="site-subtitle font-italic">深度學習、機器學習、MLOps</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/jenhaoyang" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['steven05yang','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href="https://www.linkedin.com/in/jenhaoyang/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>GStreamer基礎教學</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>GStreamer基礎教學</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1671614280" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Dec 21, 2022 </em> </span> <span> Updated <em class="" data-ts="1692230586" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Aug 17, 2023 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/jenhaoyang">Steven Yang</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="14123 words"> <em>78 min</em> read</span></div></div></div><div class="post-content"><h1 id="gobject-和-glib">GObject 和 GLib</h1><p>GStreamer建立在GObject和GLib之上，熟悉GObject和GLib對於學習GStreamer會有幫助，要區分目前的函示是屬於GStreamer還是GLib的方法就是GStreamer的函式是<code class="language-plaintext highlighter-rouge">gst_</code>開頭，而GLib的函式是<code class="language-plaintext highlighter-rouge">g_</code>開頭</p><h1 id="1簡單範例">1.簡單範例</h1><h2 id="範例"><span class="mr-2">範例</span><a href="#範例" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>下面程式碼是一個最基礎的GStreamer範例<code class="language-plaintext highlighter-rouge">basic-tutorial-1.c</code></p><div file="basic-tutorial-1.c" class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="basic-tutorial-1.c"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;gst/gst.h&gt;</span><span class="cp">
</span>
<span class="cp">#ifdef __APPLE__
#include</span> <span class="cpf">&lt;TargetConditionals.h&gt;</span><span class="cp">
#endif
</span>
<span class="kt">int</span>
<span class="nf">tutorial_main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
  <span class="n">GstElement</span> <span class="o">*</span><span class="n">pipeline</span><span class="p">;</span>
  <span class="n">GstBus</span> <span class="o">*</span><span class="n">bus</span><span class="p">;</span>
  <span class="n">GstMessage</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>

  <span class="cm">/* Initialize GStreamer */</span>
  <span class="n">gst_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span>

  <span class="cm">/* Build the pipeline */</span>
  <span class="n">pipeline</span> <span class="o">=</span>
      <span class="n">gst_parse_launch</span>
      <span class="p">(</span><span class="s">"playbin uri=https://www.freedesktop.org/software/gstreamer-sdk/data/media/sintel_trailer-480p.webm"</span><span class="p">,</span>
      <span class="nb">NULL</span><span class="p">);</span>

  <span class="cm">/* Start playing */</span>
  <span class="n">gst_element_set_state</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">GST_STATE_PLAYING</span><span class="p">);</span>

  <span class="cm">/* Wait until error or EOS */</span>
  <span class="n">bus</span> <span class="o">=</span> <span class="n">gst_element_get_bus</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">);</span>
  <span class="n">msg</span> <span class="o">=</span>
      <span class="n">gst_bus_timed_pop_filtered</span> <span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">GST_CLOCK_TIME_NONE</span><span class="p">,</span>
      <span class="n">GST_MESSAGE_ERROR</span> <span class="o">|</span> <span class="n">GST_MESSAGE_EOS</span><span class="p">);</span>

  <span class="cm">/* See next tutorial for proper error message handling/parsing */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">GST_MESSAGE_TYPE</span> <span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="n">GST_MESSAGE_ERROR</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">g_error</span> <span class="p">(</span><span class="s">"An error occurred! Re-run with the GST_DEBUG=*:WARN environment "</span>
        <span class="s">"variable set for more details."</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/* Free resources */</span>
  <span class="n">gst_message_unref</span> <span class="p">(</span><span class="n">msg</span><span class="p">);</span>
  <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">bus</span><span class="p">);</span>
  <span class="n">gst_element_set_state</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">GST_STATE_NULL</span><span class="p">);</span>
  <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
<span class="cp">#if defined(__APPLE__) &amp;&amp; TARGET_OS_MAC &amp;&amp; !TARGET_OS_IPHONE
</span>  <span class="k">return</span> <span class="n">gst_macos_main</span> <span class="p">(</span><span class="n">tutorial_main</span><span class="p">,</span> <span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="cp">#else
</span>  <span class="k">return</span> <span class="n">tutorial_main</span> <span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
<span class="cp">#endif
</span><span class="p">}</span>
</pre></table></code></div></div><p>在Linux下可以用以下指令編譯。</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>gcc basic-tutorial-1.c -o basic-tutorial-1 `pkg-config --cflags --libs gstreamer-1.0`
</pre></table></code></div></div><h2 id="解說"><span class="mr-2">解說</span><a href="#解說" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>上面這個範例最重要的只有五個需要注意的地方，其他的程式碼都是程式結束後清理的例行動作。</p><ol><li>首先所有的Gstreamer都必須呼叫<code class="language-plaintext highlighter-rouge">gst_init()</code>，他有三個功能<ul><li>初始化GStreamer<li>確認plug-ins都可以使用<li>執行命令列的<a href="https://gstreamer.freedesktop.org/documentation/gstreamer/gst.html#gst_init">參數選項</a>，可以直接將main函式的<code class="language-plaintext highlighter-rouge">argc</code>和<code class="language-plaintext highlighter-rouge">argv</code>直接傳入<code class="language-plaintext highlighter-rouge">gst_init()</code> ```c /* Initialize GStreamer */ gst_init (&amp;argc, &amp;argv);</ul></ol><p>/* Build the pipeline */</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>
2. gst_parse_launch
GStreamer 元件像水管一樣接起來組成像水管的`pipeline`，影音資料像像水流一樣，`source`元件是`pipeline`的起頭，像水龍頭一樣流出影音資料。`sink`元件是`pipeline`的結尾，是影音資料最後到達的地方。過程中經過中間的處理原件可以對影音資料進行處理。  

通常你會需要用程式定義每個元件和串接方式，但是如果你的pipeline很簡單，你可以直接用文字描述的方式作為參數傳給`gst_parse_launch`來建立pipeline

3. playbin
在這個範例中我們用到playbin來建立pipeline，playbin是一個特殊的元件，他可以同時做為source和sink，而且他可以自己建立成一個pipeline。在這個範例我們給他一個影片串流的URL，如果URL有錯或是指定的影片檔不存在，playbin可以回傳錯誤，在這個範例我們遇到錯誤的時候是直接離開程式。
```c
      gst_parse_launch
      ("playbin uri=https://www.freedesktop.org/software/gstreamer-sdk/data/media/sintel_trailer-480p.webm",
      NULL);
</pre></table></code></div></div><ol><li>state GStreamer 還有一個重要的觀念<code class="language-plaintext highlighter-rouge">state</code>。每一個GStreamer element都有<code class="language-plaintext highlighter-rouge">state</code>，很像影音撥放器的播放和暫停按鈕。在這個範例裡面，<code class="language-plaintext highlighter-rouge">pipeline</code>是我們唯一的element，因此要把他設為撥放才會開始撥放影片。<div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>/* Start playing */
gst_element_set_state (pipeline, GST_STATE_PLAYING);
</pre></table></code></div></div><li>message bus、gst_element_get_bus、gst_bus_timed_pop_filtered 在下面這兩行，<code class="language-plaintext highlighter-rouge">gst_element_get_bus</code>會取得<code class="language-plaintext highlighter-rouge">pipeline</code>的bus，而<code class="language-plaintext highlighter-rouge">gst_bus_timed_pop_filtered</code>會把main thread停住直到我們感興趣的訊息，在這裡是<code class="language-plaintext highlighter-rouge">GST_MESSAGE_ERROR</code>和<code class="language-plaintext highlighter-rouge">GST_MESSAGE_EOS</code>，而<code class="language-plaintext highlighter-rouge">GST_MESSAGE_EOS</code>代表影片結束了，因此當影片結束的時候整個程式就會停止。</ol><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>  <span class="cm">/* Wait until error or EOS */</span>
  <span class="n">bus</span> <span class="o">=</span> <span class="n">gst_element_get_bus</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">);</span>
  <span class="n">msg</span> <span class="o">=</span>
      <span class="n">gst_bus_timed_pop_filtered</span> <span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">GST_CLOCK_TIME_NONE</span><span class="p">,</span>
      <span class="n">GST_MESSAGE_ERROR</span> <span class="o">|</span> <span class="n">GST_MESSAGE_EOS</span><span class="p">);</span>
</pre></table></code></div></div><h1 id="2-gstreamer-觀念">2. GStreamer 觀念</h1><p>這個教學將會示範用程式建立pipeline。在這裡將會學到</p><ul><li>介紹GStreamer element並且學習如何建立<li>串接element<li>客製化element行為<li>利用message bus監看錯誤是件並且從中取出錯誤訊息</ul><h2 id="用程式寫出前一個教學的撥放器"><span class="mr-2">用程式寫出前一個教學的撥放器</span><a href="#用程式寫出前一個教學的撥放器" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>完整程式碼<code class="language-plaintext highlighter-rouge">basic-tutorial-2.c</code></p><div file="basic-tutorial-2.c" class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="basic-tutorial-2.c"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;gst/gst.h&gt;</span><span class="cp">
</span>
<span class="cp">#ifdef __APPLE__
#include</span> <span class="cpf">&lt;TargetConditionals.h&gt;</span><span class="cp">
#endif
</span>
<span class="kt">int</span>
<span class="nf">tutorial_main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
  <span class="n">GstElement</span> <span class="o">*</span><span class="n">pipeline</span><span class="p">,</span> <span class="o">*</span><span class="n">source</span><span class="p">,</span> <span class="o">*</span><span class="n">sink</span><span class="p">;</span>
  <span class="n">GstBus</span> <span class="o">*</span><span class="n">bus</span><span class="p">;</span>
  <span class="n">GstMessage</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
  <span class="n">GstStateChangeReturn</span> <span class="n">ret</span><span class="p">;</span>

  <span class="cm">/* Initialize GStreamer */</span>
  <span class="n">gst_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span>

  <span class="cm">/* Create the elements */</span>
  <span class="n">source</span> <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"videotestsrc"</span><span class="p">,</span> <span class="s">"source"</span><span class="p">);</span>
  <span class="n">sink</span> <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"autovideosink"</span><span class="p">,</span> <span class="s">"sink"</span><span class="p">);</span>

  <span class="cm">/* Create the empty pipeline */</span>
  <span class="n">pipeline</span> <span class="o">=</span> <span class="n">gst_pipeline_new</span> <span class="p">(</span><span class="s">"test-pipeline"</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pipeline</span> <span class="o">||</span> <span class="o">!</span><span class="n">source</span> <span class="o">||</span> <span class="o">!</span><span class="n">sink</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Not all elements could be created.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/* Build the pipeline */</span>
  <span class="n">gst_bin_add_many</span> <span class="p">(</span><span class="n">GST_BIN</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">),</span> <span class="n">source</span><span class="p">,</span> <span class="n">sink</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">gst_element_link</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">sink</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Elements could not be linked.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/* Modify the source's properties */</span>
  <span class="n">g_object_set</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s">"pattern"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

  <span class="cm">/* Start playing */</span>
  <span class="n">ret</span> <span class="o">=</span> <span class="n">gst_element_set_state</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">GST_STATE_PLAYING</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">GST_STATE_CHANGE_FAILURE</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Unable to set the pipeline to the playing state.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/* Wait until error or EOS */</span>
  <span class="n">bus</span> <span class="o">=</span> <span class="n">gst_element_get_bus</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">);</span>
  <span class="n">msg</span> <span class="o">=</span>
      <span class="n">gst_bus_timed_pop_filtered</span> <span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">GST_CLOCK_TIME_NONE</span><span class="p">,</span>
      <span class="n">GST_MESSAGE_ERROR</span> <span class="o">|</span> <span class="n">GST_MESSAGE_EOS</span><span class="p">);</span>

  <span class="cm">/* Parse message */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">msg</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">GError</span> <span class="o">*</span><span class="n">err</span><span class="p">;</span>
    <span class="n">gchar</span> <span class="o">*</span><span class="n">debug_info</span><span class="p">;</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">GST_MESSAGE_TYPE</span> <span class="p">(</span><span class="n">msg</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">case</span> <span class="n">GST_MESSAGE_ERROR</span><span class="p">:</span>
        <span class="n">gst_message_parse_error</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">debug_info</span><span class="p">);</span>
        <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Error received from element %s: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
            <span class="n">GST_OBJECT_NAME</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">),</span> <span class="n">err</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">);</span>
        <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Debugging information: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
            <span class="n">debug_info</span> <span class="o">?</span> <span class="n">debug_info</span> <span class="o">:</span> <span class="s">"none"</span><span class="p">);</span>
        <span class="n">g_clear_error</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
        <span class="n">g_free</span> <span class="p">(</span><span class="n">debug_info</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="n">GST_MESSAGE_EOS</span><span class="p">:</span>
        <span class="n">g_print</span> <span class="p">(</span><span class="s">"End-Of-Stream reached.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="nl">default:</span>
        <span class="cm">/* We should not reach here because we only asked for ERRORs and EOS */</span>
        <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Unexpected message received.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">gst_message_unref</span> <span class="p">(</span><span class="n">msg</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/* Free resources */</span>
  <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">bus</span><span class="p">);</span>
  <span class="n">gst_element_set_state</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">GST_STATE_NULL</span><span class="p">);</span>
  <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
<span class="cp">#if defined(__APPLE__) &amp;&amp; TARGET_OS_MAC &amp;&amp; !TARGET_OS_IPHONE
</span>  <span class="k">return</span> <span class="n">gst_macos_main</span> <span class="p">(</span><span class="n">tutorial_main</span><span class="p">,</span> <span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="cp">#else
</span>  <span class="k">return</span> <span class="n">tutorial_main</span> <span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
<span class="cp">#endif
</span><span class="p">}</span>
</pre></table></code></div></div><h2 id="gstreamer-element"><span class="mr-2">GStreamer element</span><a href="#gstreamer-element" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>element是GStreamer最根本的元素，影音資料從<code class="language-plaintext highlighter-rouge">source</code>流向<code class="language-plaintext highlighter-rouge">sink</code>，過程中經過<code class="language-plaintext highlighter-rouge">filter</code>對影音資料進行處理，這三個元素組成為<code class="language-plaintext highlighter-rouge">pipeline</code></p><p><img data-src="/assets/img/2023-01-06-16-33/figure-1.png" alt="pipeline" data-proofer-ignore></p><h2 id="建立element"><span class="mr-2">建立element</span><a href="#建立element" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>/* Create the elements */
source = gst_element_factory_make ("videotestsrc", "source");
sink = gst_element_factory_make ("autovideosink", "sink");
</pre></table></code></div></div><p>建立element可以用<code class="language-plaintext highlighter-rouge">gst_element_factory_make()</code>來建立，第一個參數是要建立的element名稱，第二個參數是我們給element取的名字。幫element命名的好處是如果你沒有儲存pointer，你可以用名稱來找到這個element，而且除錯訊息也會變得比較有意義。</p><p>這個教學中建立兩個element，<code class="language-plaintext highlighter-rouge">videotestsrc</code>和<code class="language-plaintext highlighter-rouge">autovideosink</code>，然後沒有建立任何<code class="language-plaintext highlighter-rouge">filter</code>。所以pipeline長的像下圖。</p><p><img data-src="/assets/img/2023-01-06-16-33/basic-concepts-pipeline.png" alt="basic pipeline" data-proofer-ignore></p><p><a href="https://gstreamer.freedesktop.org/documentation/videotestsrc/index.html#videotestsrc">videotestsrc</a>是一個source element，他會產生除錯用的影像。</p><p><a href="https://gstreamer.freedesktop.org/documentation/autodetect/autovideosink.html#autovideosink">autovideosink</a>是一個sink element，他會將影像顯示到螢幕上。</p><h2 id="建立pipeline"><span class="mr-2">建立pipeline</span><a href="#建立pipeline" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="cm">/* Create the empty pipeline */</span>
<span class="n">pipeline</span> <span class="o">=</span> <span class="n">gst_pipeline_new</span> <span class="p">(</span><span class="s">"test-pipeline"</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pipeline</span> <span class="o">||</span> <span class="o">!</span><span class="n">source</span> <span class="o">||</span> <span class="o">!</span><span class="n">sink</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Not all elements could be created.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>所有的element都必須在pipeline裡面才能運作，利用<code class="language-plaintext highlighter-rouge">gst_pipeline_new()</code>，可以建立新的pipeline。</p><h2 id="bin"><span class="mr-2">bin</span><a href="#bin" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre> <span class="cm">/* Build the pipeline */</span>
  <span class="n">gst_bin_add_many</span> <span class="p">(</span><span class="n">GST_BIN</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">),</span> <span class="n">source</span><span class="p">,</span> <span class="n">sink</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">gst_element_link</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">sink</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Elements could not be linked.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
</pre></table></code></div></div><p>Gstreamer的<a href="https://gstreamer.freedesktop.org/documentation/gstreamer/gstbin.html?gi-language=c#GstBin">bin</a>是也是一個element，它可以拿來成裝其他 GstElement。GstBin的類別關係圖如下</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>GObject
    ╰──GInitiallyUnowned
        ╰──GstObject
            ╰──GstElement
                ╰──GstBin
</pre></table></code></div></div><p>pipeline也是<a href="https://gstreamer.freedesktop.org/documentation/gstreamer/gstbin.html?gi-language=c#GstBin">bin</a>，用來裝入element。</p><p>利用<code class="language-plaintext highlighter-rouge">gst_bin_add_many()</code>可以將element放入pipeline，他可以一次加入許多element。他的第一個參數是<code class="language-plaintext highlighter-rouge">bin</code>，第二個參數之後都是element，也就是要放入的element</p><h2 id="連接element"><span class="mr-2">連接element</span><a href="#連接element" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>到目前為止element並還沒有連接起來，利用<code class="language-plaintext highlighter-rouge">gst_element_link()</code>將element聯接起來。他的第一個參數是來源，第二個參數是目標，也就是第一個參數的element會把資料傳給第二個參數的element，所以是有順序性的。</p><p>注意，只有位於同一個bin的element可以互相聯接。</p><h2 id="屬性"><span class="mr-2">屬性</span><a href="#屬性" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>GStreamer 的element全部都是一種特殊的<a href="https://docs.gtk.org/gobject/#GObject-struct">GObject</a>，因此他們都有<code class="language-plaintext highlighter-rouge">property</code>，有些可以讀取有些可以寫入</p><p><code class="language-plaintext highlighter-rouge">property</code>必須透過<a href="https://docs.gtk.org/gobject/#g-object-get">GLib</a>的方法<code class="language-plaintext highlighter-rouge">g_object_get()</code>和<code class="language-plaintext highlighter-rouge">g_object_set()</code>來讀取和寫入，因此注意到這輛個函式是<code class="language-plaintext highlighter-rouge">g_</code>開頭。</p><p><code class="language-plaintext highlighter-rouge">g_object_set()</code>支援一次修改多個<code class="language-plaintext highlighter-rouge">properties</code>。</p><p>回到我們的程式，我們改變videotestsrc的”pattern” properties，你可以將它改成<a href="https://gstreamer.freedesktop.org/documentation/videotestsrc/index.html#GstVideoTestSrcPattern">其他類型</a>來看看輸出的畫面有什麼改變。</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="cm">/* Modify the source's properties */</span>
<span class="n">g_object_set</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s">"pattern"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</pre></table></code></div></div><h2 id="錯誤檢查"><span class="mr-2">錯誤檢查</span><a href="#錯誤檢查" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>到目前為止pipeline都已經建立完成，接下來我們要增加一些程式來應付錯誤發生的情況。</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>  <span class="cm">/* Start playing */</span>
  <span class="n">ret</span> <span class="o">=</span> <span class="n">gst_element_set_state</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">GST_STATE_PLAYING</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">GST_STATE_CHANGE_FAILURE</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Unable to set the pipeline to the playing state.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
</pre></table></code></div></div><p>這是我們一樣呼叫<code class="language-plaintext highlighter-rouge">gst_element_set_state</code>來開始撥放，但是我們另外檢查<code class="language-plaintext highlighter-rouge">gst_element_set_state</code>回傳的錯誤。</p><p>另外，我們還多了一些程式來處理<code class="language-plaintext highlighter-rouge">gst_bus_timed_pop_filtered()</code>拿到的錯誤訊息，錯誤訊息是一個<a href="https://gstreamer.freedesktop.org/documentation/gstreamer/gstmessage.html#GstMessage">GstMessage</a>，如果遇到<a href="https://gstreamer.freedesktop.org/documentation/gstreamer/gstmessage.html#GST_MESSAGE_EOS">EOS</a>以外的錯誤訊息，就把他印出來。</p><p><a href="https://gstreamer.freedesktop.org/documentation/gstreamer/gstmessage.html#GstMessage">GstMessage</a>十分方便，幾乎可以承載任何形式的訊息，而GSstreamer提供了許多解析訊息的函式。</p><p>首先我們先利用<a href="https://gstreamer.freedesktop.org/documentation/gstreamer/gstmessage.html#GST_MESSAGE_TYPE">GST_MESSAGE_TYPE()</a>來取得錯誤的類型，如果不是EOS錯誤，就再用<code class="language-plaintext highlighter-rouge">gst_message_parse_error()</code>把錯誤轉型成GLib的<a href="https://docs.gtk.org/glib/#GError">GError</a>以及錯誤訊息的文字。注意使用完之後要記得釋放。</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre>  /* Parse message */
  if (msg != NULL) {
    GError *err;
    gchar *debug_info;

    switch (GST_MESSAGE_TYPE (msg)) {
      case GST_MESSAGE_ERROR:
        gst_message_parse_error (msg, &amp;err, &amp;debug_info);
        g_printerr ("Error received from element %s: %s\n",
            GST_OBJECT_NAME (msg-&gt;src), err-&gt;message);
        g_printerr ("Debugging information: %s\n",
            debug_info ? debug_info : "none");
        g_clear_error (&amp;err);
        g_free (debug_info);
        break;
      case GST_MESSAGE_EOS:
        g_print ("End-Of-Stream reached.\n");
        break;
      default:
        /* We should not reach here because we only asked for ERRORs and EOS */
        g_printerr ("Unexpected message received.\n");
        break;
    }
    gst_message_unref (msg);
  }
</pre></table></code></div></div><h2 id="gstreamer-bus"><span class="mr-2">GStreamer bus</span><a href="#gstreamer-bus" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>GStreamer bus是用來將元素所產生的GstMessage按順序傳送給應用程式的thread。這裡要強調的是，消息是從處理影像的thread傳遞給應用程式的thread。</p><p>訊息可以用<code class="language-plaintext highlighter-rouge">gst_bus_timed_pop_filtered()</code>這個函式來同步取得。或是用signals 來非同步取得，應用設必須隨時注意bus上有沒有出現錯誤。</p><h1 id="動態pipeline">動態pipeline</h1><p>在這個範例所建立的pipeline並不是完整的，而這裡將示範如何在程式運行時才將完整的pipeline建立好。</p><p>程式將打開一個multiplexed (或是 muxed)的檔案，也就是聲音和影像都儲存在一個檔案(container file)。用來打開這種檔案的element稱為<code class="language-plaintext highlighter-rouge">demuxers</code>。常見的container file有mp4、MKV、WMV等等。</p><p>如果container file裡面包含多個串流(例如一個影片串流，兩個聲音串流)，demuxer就會把他們分別分配到不同的出口，而不同的pipeline就可以各自處理這些串流。</p><p>在GStreamer裡element用來傳遞資料的接口稱為<code class="language-plaintext highlighter-rouge">pad</code>(GstPad)，<code class="language-plaintext highlighter-rouge">sink pad</code>就是資料流進element的口，以及<code class="language-plaintext highlighter-rouge">source pad</code>就是element將資料流出的口。記憶的方式就是<code class="language-plaintext highlighter-rouge">source elements</code>只會擁有<code class="language-plaintext highlighter-rouge">source pad</code>，而<code class="language-plaintext highlighter-rouge">sink element</code>只會擁有<code class="language-plaintext highlighter-rouge">sink pad</code>。<code class="language-plaintext highlighter-rouge">filter element</code>則同時擁有<code class="language-plaintext highlighter-rouge">source pad</code>和<code class="language-plaintext highlighter-rouge">sink pad</code>。</p><p><img data-src="/assets/img/2023-01-06-16-33/src-element.png" alt="src" data-proofer-ignore></p><p><img data-src="/assets/img/2023-01-06-16-33/sink-element.png" alt="sink" data-proofer-ignore></p><p><img data-src="/assets/img/2023-01-06-16-33/filter-element.png" alt="filter" data-proofer-ignore></p><p>在這個範例裡面，demuxer包含一個<code class="language-plaintext highlighter-rouge">sink pad</code> 和多個 <code class="language-plaintext highlighter-rouge">source pad</code>，而demuxer複雜的地方就在於在讀取檔案之前沒辦法確定demuxer到底有多少個<code class="language-plaintext highlighter-rouge">source pad</code>，因為demuxer要讀取到檔案之後才能決定有多少個<code class="language-plaintext highlighter-rouge">source pad</code>。</p><p>如此一來，demuxers一開始是沒有任何<code class="language-plaintext highlighter-rouge">source pad</code>的，因此也沒辦法在編譯時就將demuxers跟其他element連接。當程式開始運作後並且讀取到檔案時，這時候才是連接<code class="language-plaintext highlighter-rouge">demuxer</code>的時機。</p><p>為了簡單起見這個範例只連接audio pad而忽略video pad。</p><h2 id="範例-1"><span class="mr-2">範例</span><a href="#範例-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>下面範例<code class="language-plaintext highlighter-rouge">basic-tutorial-3.c</code>將示範動態pipeline</p><div file="basic-tutorial-3.c" class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="basic-tutorial-3.c"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;gst/gst.h&gt;</span><span class="cp">
</span>
<span class="cm">/* Structure to contain all our information, so we can pass it to callbacks */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_CustomData</span> <span class="p">{</span>
  <span class="n">GstElement</span> <span class="o">*</span><span class="n">pipeline</span><span class="p">;</span>
  <span class="n">GstElement</span> <span class="o">*</span><span class="n">source</span><span class="p">;</span>
  <span class="n">GstElement</span> <span class="o">*</span><span class="n">convert</span><span class="p">;</span>
  <span class="n">GstElement</span> <span class="o">*</span><span class="n">resample</span><span class="p">;</span>
  <span class="n">GstElement</span> <span class="o">*</span><span class="n">sink</span><span class="p">;</span>
<span class="p">}</span> <span class="n">CustomData</span><span class="p">;</span>

<span class="cm">/* Handler for the pad-added signal */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pad_added_handler</span> <span class="p">(</span><span class="n">GstElement</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="n">GstPad</span> <span class="o">*</span><span class="n">pad</span><span class="p">,</span> <span class="n">CustomData</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
  <span class="n">CustomData</span> <span class="n">data</span><span class="p">;</span>
  <span class="n">GstBus</span> <span class="o">*</span><span class="n">bus</span><span class="p">;</span>
  <span class="n">GstMessage</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
  <span class="n">GstStateChangeReturn</span> <span class="n">ret</span><span class="p">;</span>
  <span class="n">gboolean</span> <span class="n">terminate</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

  <span class="cm">/* Initialize GStreamer */</span>
  <span class="n">gst_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span>

  <span class="cm">/* Create the elements */</span>
  <span class="n">data</span><span class="p">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"uridecodebin"</span><span class="p">,</span> <span class="s">"source"</span><span class="p">);</span>
  <span class="n">data</span><span class="p">.</span><span class="n">convert</span> <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"audioconvert"</span><span class="p">,</span> <span class="s">"convert"</span><span class="p">);</span>
  <span class="n">data</span><span class="p">.</span><span class="n">resample</span> <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"audioresample"</span><span class="p">,</span> <span class="s">"resample"</span><span class="p">);</span>
  <span class="n">data</span><span class="p">.</span><span class="n">sink</span> <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"autoaudiosink"</span><span class="p">,</span> <span class="s">"sink"</span><span class="p">);</span>

  <span class="cm">/* Create the empty pipeline */</span>
  <span class="n">data</span><span class="p">.</span><span class="n">pipeline</span> <span class="o">=</span> <span class="n">gst_pipeline_new</span> <span class="p">(</span><span class="s">"test-pipeline"</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">.</span><span class="n">pipeline</span> <span class="o">||</span> <span class="o">!</span><span class="n">data</span><span class="p">.</span><span class="n">source</span> <span class="o">||</span> <span class="o">!</span><span class="n">data</span><span class="p">.</span><span class="n">convert</span> <span class="o">||</span> <span class="o">!</span><span class="n">data</span><span class="p">.</span><span class="n">resample</span> <span class="o">||</span> <span class="o">!</span><span class="n">data</span><span class="p">.</span><span class="n">sink</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Not all elements could be created.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/* Build the pipeline. Note that we are NOT linking the source at this
   * point. We will do it later. */</span>
  <span class="n">gst_bin_add_many</span> <span class="p">(</span><span class="n">GST_BIN</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">pipeline</span><span class="p">),</span> <span class="n">data</span><span class="p">.</span><span class="n">source</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">convert</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">resample</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">sink</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gst_element_link_many</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">convert</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">resample</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">sink</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Elements could not be linked.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">pipeline</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/* Set the URI to play */</span>
  <span class="n">g_object_set</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">source</span><span class="p">,</span> <span class="s">"uri"</span><span class="p">,</span> <span class="s">"https://www.freedesktop.org/software/gstreamer-sdk/data/media/sintel_trailer-480p.webm"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

  <span class="cm">/* Connect to the pad-added signal */</span>
  <span class="n">g_signal_connect</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">source</span><span class="p">,</span> <span class="s">"pad-added"</span><span class="p">,</span> <span class="n">G_CALLBACK</span> <span class="p">(</span><span class="n">pad_added_handler</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>

  <span class="cm">/* Start playing */</span>
  <span class="n">ret</span> <span class="o">=</span> <span class="n">gst_element_set_state</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">GST_STATE_PLAYING</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">GST_STATE_CHANGE_FAILURE</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Unable to set the pipeline to the playing state.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">pipeline</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/* Listen to the bus */</span>
  <span class="n">bus</span> <span class="o">=</span> <span class="n">gst_element_get_bus</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">pipeline</span><span class="p">);</span>
  <span class="k">do</span> <span class="p">{</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">gst_bus_timed_pop_filtered</span> <span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">GST_CLOCK_TIME_NONE</span><span class="p">,</span>
        <span class="n">GST_MESSAGE_STATE_CHANGED</span> <span class="o">|</span> <span class="n">GST_MESSAGE_ERROR</span> <span class="o">|</span> <span class="n">GST_MESSAGE_EOS</span><span class="p">);</span>

    <span class="cm">/* Parse message */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">msg</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">GError</span> <span class="o">*</span><span class="n">err</span><span class="p">;</span>
      <span class="n">gchar</span> <span class="o">*</span><span class="n">debug_info</span><span class="p">;</span>

      <span class="k">switch</span> <span class="p">(</span><span class="n">GST_MESSAGE_TYPE</span> <span class="p">(</span><span class="n">msg</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">GST_MESSAGE_ERROR</span><span class="p">:</span>
          <span class="n">gst_message_parse_error</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">debug_info</span><span class="p">);</span>
          <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Error received from element %s: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GST_OBJECT_NAME</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">),</span> <span class="n">err</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">);</span>
          <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Debugging information: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">debug_info</span> <span class="o">?</span> <span class="n">debug_info</span> <span class="o">:</span> <span class="s">"none"</span><span class="p">);</span>
          <span class="n">g_clear_error</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
          <span class="n">g_free</span> <span class="p">(</span><span class="n">debug_info</span><span class="p">);</span>
          <span class="n">terminate</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">GST_MESSAGE_EOS</span><span class="p">:</span>
          <span class="n">g_print</span> <span class="p">(</span><span class="s">"End-Of-Stream reached.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
          <span class="n">terminate</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">GST_MESSAGE_STATE_CHANGED</span><span class="p">:</span>
          <span class="cm">/* We are only interested in state-changed messages from the pipeline */</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">GST_MESSAGE_SRC</span> <span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="n">GST_OBJECT</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">pipeline</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">GstState</span> <span class="n">old_state</span><span class="p">,</span> <span class="n">new_state</span><span class="p">,</span> <span class="n">pending_state</span><span class="p">;</span>
            <span class="n">gst_message_parse_state_changed</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pending_state</span><span class="p">);</span>
            <span class="n">g_print</span> <span class="p">(</span><span class="s">"Pipeline state changed from %s to %s:</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
                <span class="n">gst_element_state_get_name</span> <span class="p">(</span><span class="n">old_state</span><span class="p">),</span> <span class="n">gst_element_state_get_name</span> <span class="p">(</span><span class="n">new_state</span><span class="p">));</span>
          <span class="p">}</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="nl">default:</span>
          <span class="cm">/* We should not reach here */</span>
          <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Unexpected message received.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">gst_message_unref</span> <span class="p">(</span><span class="n">msg</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">terminate</span><span class="p">);</span>

  <span class="cm">/* Free resources */</span>
  <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">bus</span><span class="p">);</span>
  <span class="n">gst_element_set_state</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">GST_STATE_NULL</span><span class="p">);</span>
  <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">pipeline</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This function will be called by the pad-added signal */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pad_added_handler</span> <span class="p">(</span><span class="n">GstElement</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="n">GstPad</span> <span class="o">*</span><span class="n">new_pad</span><span class="p">,</span> <span class="n">CustomData</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">GstPad</span> <span class="o">*</span><span class="n">sink_pad</span> <span class="o">=</span> <span class="n">gst_element_get_static_pad</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">convert</span><span class="p">,</span> <span class="s">"sink"</span><span class="p">);</span>
  <span class="n">GstPadLinkReturn</span> <span class="n">ret</span><span class="p">;</span>
  <span class="n">GstCaps</span> <span class="o">*</span><span class="n">new_pad_caps</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">GstStructure</span> <span class="o">*</span><span class="n">new_pad_struct</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="k">const</span> <span class="n">gchar</span> <span class="o">*</span><span class="n">new_pad_type</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

  <span class="n">g_print</span> <span class="p">(</span><span class="s">"Received new pad '%s' from '%s':</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GST_PAD_NAME</span> <span class="p">(</span><span class="n">new_pad</span><span class="p">),</span> <span class="n">GST_ELEMENT_NAME</span> <span class="p">(</span><span class="n">src</span><span class="p">));</span>

  <span class="cm">/* If our converter is already linked, we have nothing to do here */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">gst_pad_is_linked</span> <span class="p">(</span><span class="n">sink_pad</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">g_print</span> <span class="p">(</span><span class="s">"We are already linked. Ignoring.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/* Check the new pad's type */</span>
  <span class="n">new_pad_caps</span> <span class="o">=</span> <span class="n">gst_pad_get_current_caps</span> <span class="p">(</span><span class="n">new_pad</span><span class="p">);</span>
  <span class="n">new_pad_struct</span> <span class="o">=</span> <span class="n">gst_caps_get_structure</span> <span class="p">(</span><span class="n">new_pad_caps</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">new_pad_type</span> <span class="o">=</span> <span class="n">gst_structure_get_name</span> <span class="p">(</span><span class="n">new_pad_struct</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">g_str_has_prefix</span> <span class="p">(</span><span class="n">new_pad_type</span><span class="p">,</span> <span class="s">"audio/x-raw"</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">g_print</span> <span class="p">(</span><span class="s">"It has type '%s' which is not raw audio. Ignoring.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">new_pad_type</span><span class="p">);</span>
    <span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/* Attempt the link */</span>
  <span class="n">ret</span> <span class="o">=</span> <span class="n">gst_pad_link</span> <span class="p">(</span><span class="n">new_pad</span><span class="p">,</span> <span class="n">sink_pad</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">GST_PAD_LINK_FAILED</span> <span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">g_print</span> <span class="p">(</span><span class="s">"Type is '%s' but link failed.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">new_pad_type</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">g_print</span> <span class="p">(</span><span class="s">"Link succeeded (type '%s').</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">new_pad_type</span><span class="p">);</span>
  <span class="p">}</span>

<span class="nl">exit:</span>
  <span class="cm">/* Unreference the new pad's caps, if we got them */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">new_pad_caps</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="n">gst_caps_unref</span> <span class="p">(</span><span class="n">new_pad_caps</span><span class="p">);</span>

  <span class="cm">/* Unreference the sink pad */</span>
  <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">sink_pad</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="解說-1"><span class="mr-2">解說</span><a href="#解說-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>首先我們先將資料組成一個struct以便後面使用</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>/* Structure to contain all our information, so we can pass it to callbacks */
typedef struct _CustomData {
  GstElement *pipeline;
  GstElement *source;
  GstElement *convert;
  GstElement *resample;
  GstElement *sink;
} CustomData;
</pre></table></code></div></div><p>接下來這行是<code class="language-plaintext highlighter-rouge">forward reference</code>晚一點會實做這個函式。</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>/* Handler for the pad-added signal */
static void pad_added_handler (GstElement *src, GstPad *pad, CustomData *data);
</pre></table></code></div></div><p>接下來建立element，在這裡<code class="language-plaintext highlighter-rouge">uridecodebin</code>會自動初始化需要的element(sources, demuxers and decoders)以便將URI轉換成影音串流。跟<code class="language-plaintext highlighter-rouge">playbin</code>比起來他只完成了一半，因為它包含了<code class="language-plaintext highlighter-rouge">demuxers</code>，所以只有到執行階段的時候<code class="language-plaintext highlighter-rouge">source pad</code>才會被初始化。</p><p><code class="language-plaintext highlighter-rouge">audioconvert</code>用來轉換audio的格式。<code class="language-plaintext highlighter-rouge">audioresample</code>用來調整audio的sample rate。</p><p><code class="language-plaintext highlighter-rouge">autoaudiosink</code>和<code class="language-plaintext highlighter-rouge">autovideosink</code>類似，他將會把聲音串流輸出到音效卡</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>/* Create the elements */
data.source = gst_element_factory_make ("uridecodebin", "source");
data.convert = gst_element_factory_make ("audioconvert", "convert");
data.resample = gst_element_factory_make ("audioresample", "resample");
data.sink = gst_element_factory_make ("autoaudiosink", "sink");
</pre></table></code></div></div><h2 id="串接element"><span class="mr-2">串接element</span><a href="#串接element" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>接下來我們將converter, resample and sink這些element連接起來。注意這時候還不可以連接source，因為這時候souce還沒有source pad。</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gst_element_link_many</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">convert</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">resample</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">sink</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
  <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Elements could not be linked.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">pipeline</span><span class="p">);</span>
  <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>然後設定source要讀取的URI</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>/* Set the URI to play */
g_object_set (data.source, "uri", "https://www.freedesktop.org/software/gstreamer-sdk/data/media/sintel_trailer-480p.webm", NULL);
</pre></table></code></div></div><h2 id="signals"><span class="mr-2">Signals</span><a href="#signals" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><code class="language-plaintext highlighter-rouge">GSignals</code>是GStreamer的一個重點，他讓我們可以在我們感興趣的事情發生的時候通知我們。GStreamer用名稱來區分signal，而每一個<code class="language-plaintext highlighter-rouge">GObject</code>也都有自己的signal。 `` 在這個範例我們將會關心source(也就是uridecodebin element)發出來的<code class="language-plaintext highlighter-rouge">pad-added</code>這個訊號。我們必須用<code class="language-plaintext highlighter-rouge">g_signal_connect()</code>來連接訊號並且給他callback function(pad_added_handler)和我們的data pointer，讓callback functiony在號發生的時候執行。</p><p>GStreamer不會對data pointer做任何事情，他只是單純的把data pointer傳進我們的callback function，以便我們可以傳送參數給callback function。</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="cm">/* Connect to the pad-added signal */</span>
<span class="n">g_signal_connect</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">source</span><span class="p">,</span> <span class="s">"pad-added"</span><span class="p">,</span> <span class="n">G_CALLBACK</span> <span class="p">(</span><span class="n">pad_added_handler</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
</pre></table></code></div></div><p>在這個範例我們傳入字定義的data struct <code class="language-plaintext highlighter-rouge">CustomData</code>。</p><h2 id="我們的callback-function"><span class="mr-2">我們的callback function</span><a href="#我們的callback-function" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>當source element有足夠的資訊可以產生source pad的時候，就會觸發”pad-added”訊號，而這時候我們的callback就會被呼叫。</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">void</span> <span class="n">pad_added_handler</span> <span class="p">(</span><span class="n">GstElement</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="n">GstPad</span> <span class="o">*</span><span class="n">new_pad</span><span class="p">,</span> <span class="n">CustomData</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
</pre></table></code></div></div><p>在我們的callback中，第一個參數是觸發訊號的<code class="language-plaintext highlighter-rouge">GstElement</code>，也就是<code class="language-plaintext highlighter-rouge">uridecodebin</code>。</p><p>第二個參數是source剛剛產生的pad，也就是我們想要連接的pad。</p><p>第三個參數是一個pointer，我們將用他來傳入我麼的參數給callback。</p><p>在callback裡面，我們將CustomData裡的converter element，利用<code class="language-plaintext highlighter-rouge">gst_element_get_static_pad ()</code>將他的sink pad取出來。他也就是要跟source新產生的pad對接的pad。</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>GstPad *sink_pad = gst_element_get_static_pad (data-&gt;convert, "sink");
</pre></table></code></div></div><p>在上一個範例我們讓GStreamer自己決定要連接的pad，在這裡我們將手動連接pad。首先加入下面這段程式碼以免pad重複被連接</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="cm">/* If our converter is already linked, we have nothing to do here */</span>
<span class="k">if</span> <span class="p">(</span><span class="n">gst_pad_is_linked</span> <span class="p">(</span><span class="n">sink_pad</span><span class="p">))</span> <span class="p">{</span>
  <span class="n">g_print</span> <span class="p">(</span><span class="s">"We are already linked. Ignoring.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>接下來我們檢查新產生的pad他產生的資料是什麼，因為我們只需要連接audio而忽略video。而且我們不能把video的pad和audio的pad對接。</p><p><code class="language-plaintext highlighter-rouge">gst_pad_get_current_caps()</code>可以查到pad會輸出什麼資料，pad的”能力”(capabilities)被紀錄在<code class="language-plaintext highlighter-rouge">GstCaps</code>裡面。而pad所有可用的能力可以用<code class="language-plaintext highlighter-rouge">gst_pad_query_caps()</code>查詢</p><p>GstCaps 裡面可能包含許多的GstStructure，每一個都代表不同的”能力”。</p><p>由於目前我們知道新產生的pad只會有一個capabilities，所以我們直接用<code class="language-plaintext highlighter-rouge">gst_caps_get_structure()</code>取得他的第一個GstStructure。</p><p>最後再利用<code class="language-plaintext highlighter-rouge">gst_structure_get_name()</code>來取得這個GstStructure的名稱，這裡將會有關於pad傳出來的資料格式。</p><p>假如我們拿到的pad輸出的資料格式不是<code class="language-plaintext highlighter-rouge">audio/x-raw</code>，那就不是我們要的pad。如果是的話我們就連接他。</p><p>用<code class="language-plaintext highlighter-rouge">gst_element_link()</code>可以直接連接兩個pad，參數的順序是source在來sink，而且這兩個pad所在的element必須要在同一個bin裡面才可以連接。如此一來我們就完成了。</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="cm">/* Attempt the link */</span>
<span class="n">ret</span> <span class="o">=</span> <span class="n">gst_pad_link</span> <span class="p">(</span><span class="n">new_pad</span><span class="p">,</span> <span class="n">sink_pad</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">GST_PAD_LINK_FAILED</span> <span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
  <span class="n">g_print</span> <span class="p">(</span><span class="s">"Type is '%s' but link failed.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">new_pad_type</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="n">g_print</span> <span class="p">(</span><span class="s">"Link succeeded (type '%s').</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">new_pad_type</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="gstreamer-states"><span class="mr-2">GStreamer States</span><a href="#gstreamer-states" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>GStreamer共有四種狀態</p><ul><li>NULL: 無狀態或初始狀態<li>READY: element已經準備好進入PAUSED狀態<li>PAUSED: element已經暫停，並且準備好處理資料。sink element這時候只接受一個buffer，之後就阻塞<li>PLAYING: element正在撥放，clock正在運作，資料正在傳輸。</ul><p>注意，你只能從移動到鄰近的狀態。也就是不可以直接從NUL跳到PLAYING。當你設定pipeline 為PLAYING的時候，GSstreamer自動幫你處理這些事情。</p><p>下面這段程式監聽message bus，每當狀態有改變的時候就印出來讓你知道。每一個element都會丟出目前狀態的訊息，所以我們過濾出pipeline的狀態訊息。</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>case GST_MESSAGE_STATE_CHANGED:
  /* We are only interested in state-changed messages from the pipeline */
  if (GST_MESSAGE_SRC (msg) == GST_OBJECT (data.pipeline)) {
    GstState old_state, new_state, pending_state;
    gst_message_parse_state_changed (msg, &amp;old_state, &amp;new_state, &amp;pending_state);
    g_print ("Pipeline state changed from %s to %s:\n",
        gst_element_state_get_name (old_state), gst_element_state_get_name (new_state));
  }
  break;
</pre></table></code></div></div><h1 id="時間管理">時間管理</h1><p>在這節將會學習到GStreamer時間相關的功能包含</p><ul><li>向pipeline詢問資訊例如目前串流的位置和長度。<li>尋找(跳躍)到串流上不同的位置(時間)</ul><h2 id="gstquery"><span class="mr-2">GstQuery</span><a href="#gstquery" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><code class="language-plaintext highlighter-rouge">GstQuery</code>是一個用來詢問element或是pad的資訊的機制。在這個範例我們將詢問pipeline是否可以可以搜尋時間(例如如果是串流就沒辦法搜尋時間)，如果可以我們就可以在影片時間軸上跳躍。</p><p>這這個範例我們每隔一段時間就向pipeline詢問目前的影片時間位置，如此一來我們就可以將時間顯示在我們的螢幕上。</p><h2 id="範例-2"><span class="mr-2">範例</span><a href="#範例-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>我們將以範例<code class="language-plaintext highlighter-rouge">basic-tutorial-4.c</code>為例。</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;gst/gst.h&gt;</span><span class="cp">
</span>
<span class="cm">/* Structure to contain all our information, so we can pass it around */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_CustomData</span> <span class="p">{</span>
  <span class="n">GstElement</span> <span class="o">*</span><span class="n">playbin</span><span class="p">;</span>  <span class="cm">/* Our one and only element */</span>
  <span class="n">gboolean</span> <span class="n">playing</span><span class="p">;</span>      <span class="cm">/* Are we in the PLAYING state? */</span>
  <span class="n">gboolean</span> <span class="n">terminate</span><span class="p">;</span>    <span class="cm">/* Should we terminate execution? */</span>
  <span class="n">gboolean</span> <span class="n">seek_enabled</span><span class="p">;</span> <span class="cm">/* Is seeking enabled for this media? */</span>
  <span class="n">gboolean</span> <span class="n">seek_done</span><span class="p">;</span>    <span class="cm">/* Have we performed the seek already? */</span>
  <span class="n">gint64</span> <span class="n">duration</span><span class="p">;</span>       <span class="cm">/* How long does this media last, in nanoseconds */</span>
<span class="p">}</span> <span class="n">CustomData</span><span class="p">;</span>

<span class="cm">/* Forward definition of the message processing function */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_message</span> <span class="p">(</span><span class="n">CustomData</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">GstMessage</span> <span class="o">*</span><span class="n">msg</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
  <span class="n">CustomData</span> <span class="n">data</span><span class="p">;</span>
  <span class="n">GstBus</span> <span class="o">*</span><span class="n">bus</span><span class="p">;</span>
  <span class="n">GstMessage</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
  <span class="n">GstStateChangeReturn</span> <span class="n">ret</span><span class="p">;</span>

  <span class="n">data</span><span class="p">.</span><span class="n">playing</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="n">data</span><span class="p">.</span><span class="n">terminate</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="n">data</span><span class="p">.</span><span class="n">seek_enabled</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="n">data</span><span class="p">.</span><span class="n">seek_done</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="n">data</span><span class="p">.</span><span class="n">duration</span> <span class="o">=</span> <span class="n">GST_CLOCK_TIME_NONE</span><span class="p">;</span>

  <span class="cm">/* Initialize GStreamer */</span>
  <span class="n">gst_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span>

  <span class="cm">/* Create the elements */</span>
  <span class="n">data</span><span class="p">.</span><span class="n">playbin</span> <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"playbin"</span><span class="p">,</span> <span class="s">"playbin"</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">.</span><span class="n">playbin</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Not all elements could be created.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/* Set the URI to play */</span>
  <span class="n">g_object_set</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">playbin</span><span class="p">,</span> <span class="s">"uri"</span><span class="p">,</span> <span class="s">"https://www.freedesktop.org/software/gstreamer-sdk/data/media/sintel_trailer-480p.webm"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

  <span class="cm">/* Start playing */</span>
  <span class="n">ret</span> <span class="o">=</span> <span class="n">gst_element_set_state</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">playbin</span><span class="p">,</span> <span class="n">GST_STATE_PLAYING</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">GST_STATE_CHANGE_FAILURE</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Unable to set the pipeline to the playing state.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">playbin</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/* Listen to the bus */</span>
  <span class="n">bus</span> <span class="o">=</span> <span class="n">gst_element_get_bus</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">playbin</span><span class="p">);</span>
  <span class="k">do</span> <span class="p">{</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">gst_bus_timed_pop_filtered</span> <span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">GST_MSECOND</span><span class="p">,</span>
        <span class="n">GST_MESSAGE_STATE_CHANGED</span> <span class="o">|</span> <span class="n">GST_MESSAGE_ERROR</span> <span class="o">|</span> <span class="n">GST_MESSAGE_EOS</span> <span class="o">|</span> <span class="n">GST_MESSAGE_DURATION</span><span class="p">);</span>

    <span class="cm">/* Parse message */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">msg</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">handle_message</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="cm">/* We got no message, this means the timeout expired */</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">playing</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">gint64</span> <span class="n">current</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

        <span class="cm">/* Query the current position of the stream */</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gst_element_query_position</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">playbin</span><span class="p">,</span> <span class="n">GST_FORMAT_TIME</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
          <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Could not query current position.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="cm">/* If we didn't know it yet, query the stream duration */</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">GST_CLOCK_TIME_IS_VALID</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">duration</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gst_element_query_duration</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">playbin</span><span class="p">,</span> <span class="n">GST_FORMAT_TIME</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">.</span><span class="n">duration</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Could not query current duration.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>

        <span class="cm">/* Print current position and total duration */</span>
        <span class="n">g_print</span> <span class="p">(</span><span class="s">"Position %"</span> <span class="n">GST_TIME_FORMAT</span> <span class="s">" / %"</span> <span class="n">GST_TIME_FORMAT</span> <span class="s">"</span><span class="se">\r</span><span class="s">"</span><span class="p">,</span>
            <span class="n">GST_TIME_ARGS</span> <span class="p">(</span><span class="n">current</span><span class="p">),</span> <span class="n">GST_TIME_ARGS</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">duration</span><span class="p">));</span>

        <span class="cm">/* If seeking is enabled, we have not done it yet, and the time is right, seek */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">seek_enabled</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">data</span><span class="p">.</span><span class="n">seek_done</span> <span class="o">&amp;&amp;</span> <span class="n">current</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">GST_SECOND</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">g_print</span> <span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Reached 10s, performing seek...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
          <span class="n">gst_element_seek_simple</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">playbin</span><span class="p">,</span> <span class="n">GST_FORMAT_TIME</span><span class="p">,</span>
              <span class="n">GST_SEEK_FLAG_FLUSH</span> <span class="o">|</span> <span class="n">GST_SEEK_FLAG_KEY_UNIT</span><span class="p">,</span> <span class="mi">30</span> <span class="o">*</span> <span class="n">GST_SECOND</span><span class="p">);</span>
          <span class="n">data</span><span class="p">.</span><span class="n">seek_done</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">.</span><span class="n">terminate</span><span class="p">);</span>

  <span class="cm">/* Free resources */</span>
  <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">bus</span><span class="p">);</span>
  <span class="n">gst_element_set_state</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">playbin</span><span class="p">,</span> <span class="n">GST_STATE_NULL</span><span class="p">);</span>
  <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">playbin</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_message</span> <span class="p">(</span><span class="n">CustomData</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">GstMessage</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">GError</span> <span class="o">*</span><span class="n">err</span><span class="p">;</span>
  <span class="n">gchar</span> <span class="o">*</span><span class="n">debug_info</span><span class="p">;</span>

  <span class="k">switch</span> <span class="p">(</span><span class="n">GST_MESSAGE_TYPE</span> <span class="p">(</span><span class="n">msg</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">GST_MESSAGE_ERROR</span><span class="p">:</span>
      <span class="n">gst_message_parse_error</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">debug_info</span><span class="p">);</span>
      <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Error received from element %s: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GST_OBJECT_NAME</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">),</span> <span class="n">err</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">);</span>
      <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Debugging information: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">debug_info</span> <span class="o">?</span> <span class="n">debug_info</span> <span class="o">:</span> <span class="s">"none"</span><span class="p">);</span>
      <span class="n">g_clear_error</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
      <span class="n">g_free</span> <span class="p">(</span><span class="n">debug_info</span><span class="p">);</span>
      <span class="n">data</span><span class="o">-&gt;</span><span class="n">terminate</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">GST_MESSAGE_EOS</span><span class="p">:</span>
      <span class="n">g_print</span> <span class="p">(</span><span class="s">"End-Of-Stream reached.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
      <span class="n">data</span><span class="o">-&gt;</span><span class="n">terminate</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">GST_MESSAGE_DURATION</span><span class="p">:</span>
      <span class="cm">/* The duration has changed, mark the current one as invalid */</span>
      <span class="n">data</span><span class="o">-&gt;</span><span class="n">duration</span> <span class="o">=</span> <span class="n">GST_CLOCK_TIME_NONE</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">GST_MESSAGE_STATE_CHANGED</span><span class="p">:</span> <span class="p">{</span>
      <span class="n">GstState</span> <span class="n">old_state</span><span class="p">,</span> <span class="n">new_state</span><span class="p">,</span> <span class="n">pending_state</span><span class="p">;</span>
      <span class="n">gst_message_parse_state_changed</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pending_state</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">GST_MESSAGE_SRC</span> <span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="n">GST_OBJECT</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">playbin</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">g_print</span> <span class="p">(</span><span class="s">"Pipeline state changed from %s to %s:</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
            <span class="n">gst_element_state_get_name</span> <span class="p">(</span><span class="n">old_state</span><span class="p">),</span> <span class="n">gst_element_state_get_name</span> <span class="p">(</span><span class="n">new_state</span><span class="p">));</span>

        <span class="cm">/* Remember whether we are in the PLAYING state or not */</span>
        <span class="n">data</span><span class="o">-&gt;</span><span class="n">playing</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_state</span> <span class="o">==</span> <span class="n">GST_STATE_PLAYING</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">playing</span><span class="p">)</span> <span class="p">{</span>
          <span class="cm">/* We just moved to PLAYING. Check if seeking is possible */</span>
          <span class="n">GstQuery</span> <span class="o">*</span><span class="n">query</span><span class="p">;</span>
          <span class="n">gint64</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>
          <span class="n">query</span> <span class="o">=</span> <span class="n">gst_query_new_seeking</span> <span class="p">(</span><span class="n">GST_FORMAT_TIME</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">gst_element_query</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">playbin</span><span class="p">,</span> <span class="n">query</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">gst_query_parse_seeking</span> <span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">seek_enabled</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">seek_enabled</span><span class="p">)</span> <span class="p">{</span>
              <span class="n">g_print</span> <span class="p">(</span><span class="s">"Seeking is ENABLED from %"</span> <span class="n">GST_TIME_FORMAT</span> <span class="s">" to %"</span> <span class="n">GST_TIME_FORMAT</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
                  <span class="n">GST_TIME_ARGS</span> <span class="p">(</span><span class="n">start</span><span class="p">),</span> <span class="n">GST_TIME_ARGS</span> <span class="p">(</span><span class="n">end</span><span class="p">));</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="n">g_print</span> <span class="p">(</span><span class="s">"Seeking is DISABLED for this stream.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="p">{</span>
            <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Seeking query failed."</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="n">gst_query_unref</span> <span class="p">(</span><span class="n">query</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
      <span class="cm">/* We should not reach here */</span>
      <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Unexpected message received.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">gst_message_unref</span> <span class="p">(</span><span class="n">msg</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="定義資料struct"><span class="mr-2">定義資料struct</span><a href="#定義資料struct" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="cm">/* Structure to contain all our information, so we can pass it around */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_CustomData</span> <span class="p">{</span>
  <span class="n">GstElement</span> <span class="o">*</span><span class="n">playbin</span><span class="p">;</span>  <span class="cm">/* Our one and only element */</span>
  <span class="n">gboolean</span> <span class="n">playing</span><span class="p">;</span>      <span class="cm">/* Are we in the PLAYING state? */</span>
  <span class="n">gboolean</span> <span class="n">terminate</span><span class="p">;</span>    <span class="cm">/* Should we terminate execution? */</span>
  <span class="n">gboolean</span> <span class="n">seek_enabled</span><span class="p">;</span> <span class="cm">/* Is seeking enabled for this media? */</span>
  <span class="n">gboolean</span> <span class="n">seek_done</span><span class="p">;</span>    <span class="cm">/* Have we performed the seek already? */</span>
  <span class="n">gint64</span> <span class="n">duration</span><span class="p">;</span>       <span class="cm">/* How long does this media last, in nanoseconds */</span>
<span class="p">}</span> <span class="n">CustomData</span><span class="p">;</span>

<span class="cm">/* Forward definition of the message processing function */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_message</span> <span class="p">(</span><span class="n">CustomData</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">GstMessage</span> <span class="o">*</span><span class="n">msg</span><span class="p">);</span>
</pre></table></code></div></div><p>首先定義這個範例會用的到資料struct，同時我們也定義一個handle_message來處理我們的資料。</p><h2 id="設定監聽消息的timeout"><span class="mr-2">設定監聽消息的timeout</span><a href="#設定監聽消息的timeout" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>這個範例我們將會設定<code class="language-plaintext highlighter-rouge">gst_bus_timed_pop_filtered()</code>的timeout，如果0.1秒鐘內沒有收到任何訊息，就會發出<code class="language-plaintext highlighter-rouge">gst_bus_timed_pop_filtered()</code>會回傳一個NULL。timeoout的設定必須用到<code class="language-plaintext highlighter-rouge">GstClockTime</code>，因此我們直接用GST_SECOND 或 GST_MSECOND來產生<code class="language-plaintext highlighter-rouge">GstClockTime</code>時間。</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">msg</span> <span class="o">=</span> <span class="n">gst_bus_timed_pop_filtered</span> <span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">GST_MSECOND</span><span class="p">,</span>
    <span class="n">GST_MESSAGE_STATE_CHANGED</span> <span class="o">|</span> <span class="n">GST_MESSAGE_ERROR</span> <span class="o">|</span> <span class="n">GST_MESSAGE_EOS</span> <span class="o">|</span> <span class="n">GST_MESSAGE_DURATION</span><span class="p">);</span>
</pre></table></code></div></div><h2 id="更新使用者介面"><span class="mr-2">更新使用者介面</span><a href="#更新使用者介面" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>首先檢查pipeline是PLAYING的才對pipeline做查詢以免出錯。</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="cm">/* We got no message, this means the timeout expired */</span>
<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">playing</span><span class="p">)</span> <span class="p">{</span>
</pre></table></code></div></div><p>接著用<code class="language-plaintext highlighter-rouge">GstElement</code>提供的方法取得時間。</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="cm">/* Query the current position of the stream */</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gst_element_query_position</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">GST_FORMAT_TIME</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
  <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Could not query current position.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>如果無法取得就改成檢查是否可以詢問stream的長度</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="cm">/* If we didn't know it yet, query the stream duration */</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">GST_CLOCK_TIME_IS_VALID</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">duration</span><span class="p">))</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gst_element_query_duration</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">GST_FORMAT_TIME</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">.</span><span class="n">duration</span><span class="p">))</span> <span class="p">{</span>
     <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Could not query current duration.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>接下來就可以詢問影片長度</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="cm">/* Print current position and total duration */</span>
<span class="n">g_print</span> <span class="p">(</span><span class="s">"Position %"</span> <span class="n">GST_TIME_FORMAT</span> <span class="s">" / %"</span> <span class="n">GST_TIME_FORMAT</span> <span class="s">"</span><span class="se">\r</span><span class="s">"</span><span class="p">,</span>
    <span class="n">GST_TIME_ARGS</span> <span class="p">(</span><span class="n">current</span><span class="p">),</span> <span class="n">GST_TIME_ARGS</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">duration</span><span class="p">));</span>
</pre></table></code></div></div><p>下一段是在影片時間軸跳躍的程式，利用<code class="language-plaintext highlighter-rouge">gst_element_seek_simple()</code>來達成。</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="cm">/* If seeking is enabled, we have not done it yet, and the time is right, seek */</span>
<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">seek_enabled</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">data</span><span class="p">.</span><span class="n">seek_done</span> <span class="o">&amp;&amp;</span> <span class="n">current</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">GST_SECOND</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">g_print</span> <span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Reached 10s, performing seek...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="n">gst_element_seek_simple</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">GST_FORMAT_TIME</span><span class="p">,</span>
      <span class="n">GST_SEEK_FLAG_FLUSH</span> <span class="o">|</span> <span class="n">GST_SEEK_FLAG_KEY_UNIT</span><span class="p">,</span> <span class="mi">30</span> <span class="o">*</span> <span class="n">GST_SECOND</span><span class="p">);</span>
  <span class="n">data</span><span class="p">.</span><span class="n">seek_done</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><ol><li>GST_FORMAT_TIME: 目標時間的格式<li>GstSeekFlags: 指令跳躍的行為<ul><li>GST_SEEK_FLAG_FLUSH: 直接拋棄掉目標時間之前的所有畫面。<li>GST_SEEK_FLAG_KEY_UNIT: 移動到目標時間附近的key frame<li>GST_SEEK_FLAG_ACCURATE: 精準的移動到目標時間上。</ul><li>目標時間: 是指定要跳躍到的時間位置</ol><h2 id="message-pump"><span class="mr-2">Message Pump</span><a href="#message-pump" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>首先如果影片長度改變我們就先讓pipeline不能被詢問影片時間。</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">case</span> <span class="n">GST_MESSAGE_DURATION</span><span class="p">:</span>
  <span class="cm">/* The duration has changed, mark the current one as invalid */</span>
  <span class="n">data</span><span class="o">-&gt;</span><span class="n">duration</span> <span class="o">=</span> <span class="n">GST_CLOCK_TIME_NONE</span><span class="p">;</span>
  <span class="k">break</span><span class="p">;</span>
</pre></table></code></div></div><p>接下來這段程式如果pipeline狀態改變，確認pipeline為PAUSED或是PLAYING才可以在時間軸跳躍</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre>    <span class="k">case</span> <span class="n">GST_MESSAGE_STATE_CHANGED</span><span class="p">:</span> <span class="p">{</span>
      <span class="n">GstState</span> <span class="n">old_state</span><span class="p">,</span> <span class="n">new_state</span><span class="p">,</span> <span class="n">pending_state</span><span class="p">;</span>
      <span class="n">gst_message_parse_state_changed</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pending_state</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">GST_MESSAGE_SRC</span> <span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="n">GST_OBJECT</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">playbin</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">g_print</span> <span class="p">(</span><span class="s">"Pipeline state changed from %s to %s:</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
            <span class="n">gst_element_state_get_name</span> <span class="p">(</span><span class="n">old_state</span><span class="p">),</span> <span class="n">gst_element_state_get_name</span> <span class="p">(</span><span class="n">new_state</span><span class="p">));</span>

        <span class="cm">/* Remember whether we are in the PLAYING state or not */</span>
        <span class="n">data</span><span class="o">-&gt;</span><span class="n">playing</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_state</span> <span class="o">==</span> <span class="n">GST_STATE_PLAYING</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">playing</span><span class="p">)</span> <span class="p">{</span>
          <span class="cm">/* We just moved to PLAYING. Check if seeking is possible */</span>
          <span class="n">GstQuery</span> <span class="o">*</span><span class="n">query</span><span class="p">;</span>
          <span class="n">gint64</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>
          <span class="n">query</span> <span class="o">=</span> <span class="n">gst_query_new_seeking</span> <span class="p">(</span><span class="n">GST_FORMAT_TIME</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">gst_element_query</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">playbin</span><span class="p">,</span> <span class="n">query</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">gst_query_parse_seeking</span> <span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">seek_enabled</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">seek_enabled</span><span class="p">)</span> <span class="p">{</span>
              <span class="n">g_print</span> <span class="p">(</span><span class="s">"Seeking is ENABLED from %"</span> <span class="n">GST_TIME_FORMAT</span> <span class="s">" to %"</span> <span class="n">GST_TIME_FORMAT</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
                  <span class="n">GST_TIME_ARGS</span> <span class="p">(</span><span class="n">start</span><span class="p">),</span> <span class="n">GST_TIME_ARGS</span> <span class="p">(</span><span class="n">end</span><span class="p">));</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="n">g_print</span> <span class="p">(</span><span class="s">"Seeking is DISABLED for this stream.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="p">{</span>
            <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Seeking query failed."</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="n">gst_query_unref</span> <span class="p">(</span><span class="n">query</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">gst_query_new_seeking()</code>建立一個新的query物件，這個query物件利用<code class="language-plaintext highlighter-rouge">gst_element_query()</code>函式被發送到pipeline。如果咬讀去回傳結果可以用<code class="language-plaintext highlighter-rouge">gst_query_parse_seeking()</code></p><h1 id="媒體格式和pad-capabilities">媒體格式和pad Capabilities</h1><h2 id="pads"><span class="mr-2">Pads</span><a href="#pads" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Capabilities 顯示在這個Pad上流動的資料的模樣。例如他可能是”解析度300x200的RGB影片，FPS 30”</p><p>Pad可以有多種Capabilities，例如一個video sink可以同時支援RGB和YUV格式。</p><p>Capabilities也可以是一個範圍，例如audio sink可以支援samples rates 1~48000。</p><p>如果要將兩個element連接起來，他們必須要擁有共同的Capabilities。</p><p>如果連接的時候Capabilities沒辦法對應，就會出現<code class="language-plaintext highlighter-rouge">negotiation error</code></p><h2 id="pad-templates"><span class="mr-2">Pad templates</span><a href="#pad-templates" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Pad 是從Pad templates產生的，他可以產生各種Capabilities 的Pad。</p><h2 id="capabilities範例"><span class="mr-2">Capabilities範例</span><a href="#capabilities範例" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>下面是一個sink pad。他支援整數型態的raw audio，包含unsigned 8-bit或是 signed, 16-bit little endian。<code class="language-plaintext highlighter-rouge">[]</code>裡面代表範圍例如channels可能是一個或兩個。</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>SINK template: 'sink'
  Availability: Always
  Capabilities:
    audio/x-raw
               format: S16LE
                 rate: [ 1, 2147483647 ]
             channels: [ 1, 2 ]
    audio/x-raw
               format: U8
                 rate: [ 1, 2147483647 ]
             channels: [ 1, 2 ]
</pre></table></code></div></div><p>注意有些Capabilities跟平台是有相關性的，要直到READY state的時候才能確定能不能用。</p><h2 id="範例-3"><span class="mr-2">範例</span><a href="#範例-3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><code class="language-plaintext highlighter-rouge">basic-tutorial-6.c</code></p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;gst/gst.h&gt;</span><span class="cp">
</span>
<span class="cm">/* Functions below print the Capabilities in a human-friendly format */</span>
<span class="k">static</span> <span class="n">gboolean</span> <span class="nf">print_field</span> <span class="p">(</span><span class="n">GQuark</span> <span class="n">field</span><span class="p">,</span> <span class="k">const</span> <span class="n">GValue</span> <span class="o">*</span> <span class="n">value</span><span class="p">,</span> <span class="n">gpointer</span> <span class="n">pfx</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">gchar</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="n">gst_value_serialize</span> <span class="p">(</span><span class="n">value</span><span class="p">);</span>

  <span class="n">g_print</span> <span class="p">(</span><span class="s">"%s  %15s: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="p">(</span><span class="n">gchar</span> <span class="o">*</span><span class="p">)</span> <span class="n">pfx</span><span class="p">,</span> <span class="n">g_quark_to_string</span> <span class="p">(</span><span class="n">field</span><span class="p">),</span> <span class="n">str</span><span class="p">);</span>
  <span class="n">g_free</span> <span class="p">(</span><span class="n">str</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_caps</span> <span class="p">(</span><span class="k">const</span> <span class="n">GstCaps</span> <span class="o">*</span> <span class="n">caps</span><span class="p">,</span> <span class="k">const</span> <span class="n">gchar</span> <span class="o">*</span> <span class="n">pfx</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">guint</span> <span class="n">i</span><span class="p">;</span>

  <span class="n">g_return_if_fail</span> <span class="p">(</span><span class="n">caps</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">gst_caps_is_any</span> <span class="p">(</span><span class="n">caps</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">g_print</span> <span class="p">(</span><span class="s">"%sANY</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pfx</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">gst_caps_is_empty</span> <span class="p">(</span><span class="n">caps</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">g_print</span> <span class="p">(</span><span class="s">"%sEMPTY</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pfx</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">gst_caps_get_size</span> <span class="p">(</span><span class="n">caps</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">GstStructure</span> <span class="o">*</span><span class="n">structure</span> <span class="o">=</span> <span class="n">gst_caps_get_structure</span> <span class="p">(</span><span class="n">caps</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

    <span class="n">g_print</span> <span class="p">(</span><span class="s">"%s%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pfx</span><span class="p">,</span> <span class="n">gst_structure_get_name</span> <span class="p">(</span><span class="n">structure</span><span class="p">));</span>
    <span class="n">gst_structure_foreach</span> <span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">print_field</span><span class="p">,</span> <span class="p">(</span><span class="n">gpointer</span><span class="p">)</span> <span class="n">pfx</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Prints information about a Pad Template, including its Capabilities */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_pad_templates_information</span> <span class="p">(</span><span class="n">GstElementFactory</span> <span class="o">*</span> <span class="n">factory</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">const</span> <span class="n">GList</span> <span class="o">*</span><span class="n">pads</span><span class="p">;</span>
  <span class="n">GstStaticPadTemplate</span> <span class="o">*</span><span class="n">padtemplate</span><span class="p">;</span>

  <span class="n">g_print</span> <span class="p">(</span><span class="s">"Pad Templates for %s:</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">gst_element_factory_get_longname</span> <span class="p">(</span><span class="n">factory</span><span class="p">));</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gst_element_factory_get_num_pad_templates</span> <span class="p">(</span><span class="n">factory</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">g_print</span> <span class="p">(</span><span class="s">"  none</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">pads</span> <span class="o">=</span> <span class="n">gst_element_factory_get_static_pad_templates</span> <span class="p">(</span><span class="n">factory</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">pads</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">padtemplate</span> <span class="o">=</span> <span class="n">pads</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
    <span class="n">pads</span> <span class="o">=</span> <span class="n">g_list_next</span> <span class="p">(</span><span class="n">pads</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">padtemplate</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">==</span> <span class="n">GST_PAD_SRC</span><span class="p">)</span>
      <span class="n">g_print</span> <span class="p">(</span><span class="s">"  SRC template: '%s'</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">padtemplate</span><span class="o">-&gt;</span><span class="n">name_template</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">padtemplate</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">==</span> <span class="n">GST_PAD_SINK</span><span class="p">)</span>
      <span class="n">g_print</span> <span class="p">(</span><span class="s">"  SINK template: '%s'</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">padtemplate</span><span class="o">-&gt;</span><span class="n">name_template</span><span class="p">);</span>
    <span class="k">else</span>
      <span class="n">g_print</span> <span class="p">(</span><span class="s">"  UNKNOWN!!! template: '%s'</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">padtemplate</span><span class="o">-&gt;</span><span class="n">name_template</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">padtemplate</span><span class="o">-&gt;</span><span class="n">presence</span> <span class="o">==</span> <span class="n">GST_PAD_ALWAYS</span><span class="p">)</span>
      <span class="n">g_print</span> <span class="p">(</span><span class="s">"    Availability: Always</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">padtemplate</span><span class="o">-&gt;</span><span class="n">presence</span> <span class="o">==</span> <span class="n">GST_PAD_SOMETIMES</span><span class="p">)</span>
      <span class="n">g_print</span> <span class="p">(</span><span class="s">"    Availability: Sometimes</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">padtemplate</span><span class="o">-&gt;</span><span class="n">presence</span> <span class="o">==</span> <span class="n">GST_PAD_REQUEST</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">g_print</span> <span class="p">(</span><span class="s">"    Availability: On request</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span>
      <span class="n">g_print</span> <span class="p">(</span><span class="s">"    Availability: UNKNOWN!!!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">padtemplate</span><span class="o">-&gt;</span><span class="n">static_caps</span><span class="p">.</span><span class="n">string</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">GstCaps</span> <span class="o">*</span><span class="n">caps</span><span class="p">;</span>
      <span class="n">g_print</span> <span class="p">(</span><span class="s">"    Capabilities:</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
      <span class="n">caps</span> <span class="o">=</span> <span class="n">gst_static_caps_get</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">padtemplate</span><span class="o">-&gt;</span><span class="n">static_caps</span><span class="p">);</span>
      <span class="n">print_caps</span> <span class="p">(</span><span class="n">caps</span><span class="p">,</span> <span class="s">"      "</span><span class="p">);</span>
      <span class="n">gst_caps_unref</span> <span class="p">(</span><span class="n">caps</span><span class="p">);</span>

    <span class="p">}</span>

    <span class="n">g_print</span> <span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Shows the CURRENT capabilities of the requested pad in the given element */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_pad_capabilities</span> <span class="p">(</span><span class="n">GstElement</span> <span class="o">*</span><span class="n">element</span><span class="p">,</span> <span class="n">gchar</span> <span class="o">*</span><span class="n">pad_name</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">GstPad</span> <span class="o">*</span><span class="n">pad</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">GstCaps</span> <span class="o">*</span><span class="n">caps</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

  <span class="cm">/* Retrieve pad */</span>
  <span class="n">pad</span> <span class="o">=</span> <span class="n">gst_element_get_static_pad</span> <span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">pad_name</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pad</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Could not retrieve pad '%s'</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pad_name</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/* Retrieve negotiated caps (or acceptable caps if negotiation is not finished yet) */</span>
  <span class="n">caps</span> <span class="o">=</span> <span class="n">gst_pad_get_current_caps</span> <span class="p">(</span><span class="n">pad</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">caps</span><span class="p">)</span>
    <span class="n">caps</span> <span class="o">=</span> <span class="n">gst_pad_query_caps</span> <span class="p">(</span><span class="n">pad</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

  <span class="cm">/* Print and free */</span>
  <span class="n">g_print</span> <span class="p">(</span><span class="s">"Caps for the %s pad:</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pad_name</span><span class="p">);</span>
  <span class="n">print_caps</span> <span class="p">(</span><span class="n">caps</span><span class="p">,</span> <span class="s">"      "</span><span class="p">);</span>
  <span class="n">gst_caps_unref</span> <span class="p">(</span><span class="n">caps</span><span class="p">);</span>
  <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">pad</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
  <span class="n">GstElement</span> <span class="o">*</span><span class="n">pipeline</span><span class="p">,</span> <span class="o">*</span><span class="n">source</span><span class="p">,</span> <span class="o">*</span><span class="n">sink</span><span class="p">;</span>
  <span class="n">GstElementFactory</span> <span class="o">*</span><span class="n">source_factory</span><span class="p">,</span> <span class="o">*</span><span class="n">sink_factory</span><span class="p">;</span>
  <span class="n">GstBus</span> <span class="o">*</span><span class="n">bus</span><span class="p">;</span>
  <span class="n">GstMessage</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
  <span class="n">GstStateChangeReturn</span> <span class="n">ret</span><span class="p">;</span>
  <span class="n">gboolean</span> <span class="n">terminate</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

  <span class="cm">/* Initialize GStreamer */</span>
  <span class="n">gst_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span>

  <span class="cm">/* Create the element factories */</span>
  <span class="n">source_factory</span> <span class="o">=</span> <span class="n">gst_element_factory_find</span> <span class="p">(</span><span class="s">"audiotestsrc"</span><span class="p">);</span>
  <span class="n">sink_factory</span> <span class="o">=</span> <span class="n">gst_element_factory_find</span> <span class="p">(</span><span class="s">"autoaudiosink"</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">source_factory</span> <span class="o">||</span> <span class="o">!</span><span class="n">sink_factory</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Not all element factories could be created.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/* Print information about the pad templates of these factories */</span>
  <span class="n">print_pad_templates_information</span> <span class="p">(</span><span class="n">source_factory</span><span class="p">);</span>
  <span class="n">print_pad_templates_information</span> <span class="p">(</span><span class="n">sink_factory</span><span class="p">);</span>

  <span class="cm">/* Ask the factories to instantiate actual elements */</span>
  <span class="n">source</span> <span class="o">=</span> <span class="n">gst_element_factory_create</span> <span class="p">(</span><span class="n">source_factory</span><span class="p">,</span> <span class="s">"source"</span><span class="p">);</span>
  <span class="n">sink</span> <span class="o">=</span> <span class="n">gst_element_factory_create</span> <span class="p">(</span><span class="n">sink_factory</span><span class="p">,</span> <span class="s">"sink"</span><span class="p">);</span>

  <span class="cm">/* Create the empty pipeline */</span>
  <span class="n">pipeline</span> <span class="o">=</span> <span class="n">gst_pipeline_new</span> <span class="p">(</span><span class="s">"test-pipeline"</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pipeline</span> <span class="o">||</span> <span class="o">!</span><span class="n">source</span> <span class="o">||</span> <span class="o">!</span><span class="n">sink</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Not all elements could be created.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/* Build the pipeline */</span>
  <span class="n">gst_bin_add_many</span> <span class="p">(</span><span class="n">GST_BIN</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">),</span> <span class="n">source</span><span class="p">,</span> <span class="n">sink</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">gst_element_link</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">sink</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Elements could not be linked.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/* Print initial negotiated caps (in NULL state) */</span>
  <span class="n">g_print</span> <span class="p">(</span><span class="s">"In NULL state:</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="n">print_pad_capabilities</span> <span class="p">(</span><span class="n">sink</span><span class="p">,</span> <span class="s">"sink"</span><span class="p">);</span>

  <span class="cm">/* Start playing */</span>
  <span class="n">ret</span> <span class="o">=</span> <span class="n">gst_element_set_state</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">GST_STATE_PLAYING</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">GST_STATE_CHANGE_FAILURE</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Unable to set the pipeline to the playing state (check the bus for error messages).</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/* Wait until error, EOS or State Change */</span>
  <span class="n">bus</span> <span class="o">=</span> <span class="n">gst_element_get_bus</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">);</span>
  <span class="k">do</span> <span class="p">{</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">gst_bus_timed_pop_filtered</span> <span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">GST_CLOCK_TIME_NONE</span><span class="p">,</span> <span class="n">GST_MESSAGE_ERROR</span> <span class="o">|</span> <span class="n">GST_MESSAGE_EOS</span> <span class="o">|</span>
        <span class="n">GST_MESSAGE_STATE_CHANGED</span><span class="p">);</span>

    <span class="cm">/* Parse message */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">msg</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">GError</span> <span class="o">*</span><span class="n">err</span><span class="p">;</span>
      <span class="n">gchar</span> <span class="o">*</span><span class="n">debug_info</span><span class="p">;</span>

      <span class="k">switch</span> <span class="p">(</span><span class="n">GST_MESSAGE_TYPE</span> <span class="p">(</span><span class="n">msg</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">GST_MESSAGE_ERROR</span><span class="p">:</span>
          <span class="n">gst_message_parse_error</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">debug_info</span><span class="p">);</span>
          <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Error received from element %s: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GST_OBJECT_NAME</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">),</span> <span class="n">err</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">);</span>
          <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Debugging information: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">debug_info</span> <span class="o">?</span> <span class="n">debug_info</span> <span class="o">:</span> <span class="s">"none"</span><span class="p">);</span>
          <span class="n">g_clear_error</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
          <span class="n">g_free</span> <span class="p">(</span><span class="n">debug_info</span><span class="p">);</span>
          <span class="n">terminate</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">GST_MESSAGE_EOS</span><span class="p">:</span>
          <span class="n">g_print</span> <span class="p">(</span><span class="s">"End-Of-Stream reached.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
          <span class="n">terminate</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">GST_MESSAGE_STATE_CHANGED</span><span class="p">:</span>
          <span class="cm">/* We are only interested in state-changed messages from the pipeline */</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">GST_MESSAGE_SRC</span> <span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="n">GST_OBJECT</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">GstState</span> <span class="n">old_state</span><span class="p">,</span> <span class="n">new_state</span><span class="p">,</span> <span class="n">pending_state</span><span class="p">;</span>
            <span class="n">gst_message_parse_state_changed</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pending_state</span><span class="p">);</span>
            <span class="n">g_print</span> <span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Pipeline state changed from %s to %s:</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
                <span class="n">gst_element_state_get_name</span> <span class="p">(</span><span class="n">old_state</span><span class="p">),</span> <span class="n">gst_element_state_get_name</span> <span class="p">(</span><span class="n">new_state</span><span class="p">));</span>
            <span class="cm">/* Print the current capabilities of the sink element */</span>
            <span class="n">print_pad_capabilities</span> <span class="p">(</span><span class="n">sink</span><span class="p">,</span> <span class="s">"sink"</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="nl">default:</span>
          <span class="cm">/* We should not reach here because we only asked for ERRORs, EOS and STATE_CHANGED */</span>
          <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Unexpected message received.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">gst_message_unref</span> <span class="p">(</span><span class="n">msg</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">terminate</span><span class="p">);</span>

  <span class="cm">/* Free resources */</span>
  <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">bus</span><span class="p">);</span>
  <span class="n">gst_element_set_state</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">GST_STATE_NULL</span><span class="p">);</span>
  <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">);</span>
  <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">source_factory</span><span class="p">);</span>
  <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">sink_factory</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="印出capabilities"><span class="mr-2">印出capabilities</span><a href="#印出capabilities" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><code class="language-plaintext highlighter-rouge">print_field</code>、<code class="language-plaintext highlighter-rouge">print_caps</code>和<code class="language-plaintext highlighter-rouge">print_pad_templates</code>可以印出capabilities。</p><p><code class="language-plaintext highlighter-rouge">gst_element_get_static_pad()</code>可以用名稱取得Pad，之所以static是因為這個pad永遠都會出現在這個element裡面。</p><p><code class="language-plaintext highlighter-rouge">gst_pad_get_current_caps()</code>可以取得Pad目前的capabilities，這個capabilities是固定的也可能之後會改變，甚只有可能目前沒有capabilities，要看negotiation proces的狀態來決定。</p><p>我們可以用<code class="language-plaintext highlighter-rouge">gst_pad_query_caps()</code>來取得在NULL state時的Capabilities</p><h2 id="gstelementfactory"><span class="mr-2">GstElementFactory</span><a href="#gstelementfactory" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><code class="language-plaintext highlighter-rouge">GstElementFactory</code>用來初始化指定的element。</p><p><code class="language-plaintext highlighter-rouge">gst_element_factory_make()</code> = <code class="language-plaintext highlighter-rouge">gst_element_factory_find()</code>+ <code class="language-plaintext highlighter-rouge">gst_element_factory_create()</code></p><h2 id="gst_pad_get_current_caps-和-gst_pad_query_caps-的差別"><span class="mr-2">gst_pad_get_current_caps() 和 gst_pad_query_caps() 的差別</span><a href="#gst_pad_get_current_caps-和-gst_pad_query_caps-的差別" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>gst_pad_get_current_caps() : 目前可用的Capabilities<li>gst_pad_query_caps() : 包含所有可能的Capabilities</ul><h1 id="多執行續和pad-availability">多執行續和Pad Availability</h1><p>通常GStreamer會自己處理多執行續，但有時候會需要手動處理他。</p><h2 id="multithreading"><span class="mr-2">Multithreading</span><a href="#multithreading" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>GStreamer 是一個Multithreading的框架。他會自己產生和消滅thread，甚至plugin可以在自己的process裡面產生新的thread，例如video decoder會自己產生四個thread。</p><h2 id="multithreading範例"><span class="mr-2">Multithreading範例</span><a href="#multithreading範例" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>下面是一個多執行續的pipeline，通常多個sink的pipeline是Multithreading <img data-src="/assets/img/2023-01-06-16-33/basic-tutorial-7.png" alt="Alt text" data-proofer-ignore></p><h2 id="request-pads"><span class="mr-2">Request pads</span><a href="#request-pads" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>在前面的範例我們已經知道<code class="language-plaintext highlighter-rouge">uridecodebin</code>在執行時才會確定產生多少個pad，這種pad稱為<code class="language-plaintext highlighter-rouge">Sometimes Pads</code>，而固定不變的pad稱為<code class="language-plaintext highlighter-rouge">Always Pads</code>。</p><p>第三中Pad稱為<code class="language-plaintext highlighter-rouge">Request Pad</code>，是有需要的時候才建立。在<code class="language-plaintext highlighter-rouge">tee</code>裡面就有<code class="language-plaintext highlighter-rouge">Request Pad</code>。你必須主動建立才會產生<code class="language-plaintext highlighter-rouge">Request Pad</code>。<code class="language-plaintext highlighter-rouge">Request Pad</code>沒辦法自動連接，必須手動連接。</p><p>另外如果在<code class="language-plaintext highlighter-rouge">PLAYING</code>或<code class="language-plaintext highlighter-rouge">PAUSED</code>的時候建立或是釋放<code class="language-plaintext highlighter-rouge">Request Pad</code>要特別小心，因為有時候會造成(Pad blocking)。通常在<code class="language-plaintext highlighter-rouge">NULL</code> 或 <code class="language-plaintext highlighter-rouge">READY</code>狀態的時候建立或釋放比較安全。</p><h2 id="範例-4"><span class="mr-2">範例</span><a href="#範例-4" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><code class="language-plaintext highlighter-rouge">basic-tutorial-7.c</code></p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;gst/gst.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
  <span class="n">GstElement</span> <span class="o">*</span><span class="n">pipeline</span><span class="p">,</span> <span class="o">*</span><span class="n">audio_source</span><span class="p">,</span> <span class="o">*</span><span class="n">tee</span><span class="p">,</span> <span class="o">*</span><span class="n">audio_queue</span><span class="p">,</span> <span class="o">*</span><span class="n">audio_convert</span><span class="p">,</span> <span class="o">*</span><span class="n">audio_resample</span><span class="p">,</span> <span class="o">*</span><span class="n">audio_sink</span><span class="p">;</span>
  <span class="n">GstElement</span> <span class="o">*</span><span class="n">video_queue</span><span class="p">,</span> <span class="o">*</span><span class="n">visual</span><span class="p">,</span> <span class="o">*</span><span class="n">video_convert</span><span class="p">,</span> <span class="o">*</span><span class="n">video_sink</span><span class="p">;</span>
  <span class="n">GstBus</span> <span class="o">*</span><span class="n">bus</span><span class="p">;</span>
  <span class="n">GstMessage</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
  <span class="n">GstPad</span> <span class="o">*</span><span class="n">tee_audio_pad</span><span class="p">,</span> <span class="o">*</span><span class="n">tee_video_pad</span><span class="p">;</span>
  <span class="n">GstPad</span> <span class="o">*</span><span class="n">queue_audio_pad</span><span class="p">,</span> <span class="o">*</span><span class="n">queue_video_pad</span><span class="p">;</span>

  <span class="cm">/* Initialize GStreamer */</span>
  <span class="n">gst_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span>

  <span class="cm">/* Create the elements */</span>
  <span class="n">audio_source</span> <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"audiotestsrc"</span><span class="p">,</span> <span class="s">"audio_source"</span><span class="p">);</span>
  <span class="n">tee</span> <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"tee"</span><span class="p">,</span> <span class="s">"tee"</span><span class="p">);</span>
  <span class="n">audio_queue</span> <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"queue"</span><span class="p">,</span> <span class="s">"audio_queue"</span><span class="p">);</span>
  <span class="n">audio_convert</span> <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"audioconvert"</span><span class="p">,</span> <span class="s">"audio_convert"</span><span class="p">);</span>
  <span class="n">audio_resample</span> <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"audioresample"</span><span class="p">,</span> <span class="s">"audio_resample"</span><span class="p">);</span>
  <span class="n">audio_sink</span> <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"autoaudiosink"</span><span class="p">,</span> <span class="s">"audio_sink"</span><span class="p">);</span>
  <span class="n">video_queue</span> <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"queue"</span><span class="p">,</span> <span class="s">"video_queue"</span><span class="p">);</span>
  <span class="n">visual</span> <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"wavescope"</span><span class="p">,</span> <span class="s">"visual"</span><span class="p">);</span>
  <span class="n">video_convert</span> <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"videoconvert"</span><span class="p">,</span> <span class="s">"csp"</span><span class="p">);</span>
  <span class="n">video_sink</span> <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"autovideosink"</span><span class="p">,</span> <span class="s">"video_sink"</span><span class="p">);</span>

  <span class="cm">/* Create the empty pipeline */</span>
  <span class="n">pipeline</span> <span class="o">=</span> <span class="n">gst_pipeline_new</span> <span class="p">(</span><span class="s">"test-pipeline"</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pipeline</span> <span class="o">||</span> <span class="o">!</span><span class="n">audio_source</span> <span class="o">||</span> <span class="o">!</span><span class="n">tee</span> <span class="o">||</span> <span class="o">!</span><span class="n">audio_queue</span> <span class="o">||</span> <span class="o">!</span><span class="n">audio_convert</span> <span class="o">||</span> <span class="o">!</span><span class="n">audio_resample</span> <span class="o">||</span> <span class="o">!</span><span class="n">audio_sink</span> <span class="o">||</span>
      <span class="o">!</span><span class="n">video_queue</span> <span class="o">||</span> <span class="o">!</span><span class="n">visual</span> <span class="o">||</span> <span class="o">!</span><span class="n">video_convert</span> <span class="o">||</span> <span class="o">!</span><span class="n">video_sink</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Not all elements could be created.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/* Configure elements */</span>
  <span class="n">g_object_set</span> <span class="p">(</span><span class="n">audio_source</span><span class="p">,</span> <span class="s">"freq"</span><span class="p">,</span> <span class="mi">215</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="n">g_object_set</span> <span class="p">(</span><span class="n">visual</span><span class="p">,</span> <span class="s">"shader"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"style"</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

  <span class="cm">/* Link all elements that can be automatically linked because they have "Always" pads */</span>
  <span class="n">gst_bin_add_many</span> <span class="p">(</span><span class="n">GST_BIN</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">),</span> <span class="n">audio_source</span><span class="p">,</span> <span class="n">tee</span><span class="p">,</span> <span class="n">audio_queue</span><span class="p">,</span> <span class="n">audio_convert</span><span class="p">,</span> <span class="n">audio_resample</span><span class="p">,</span> <span class="n">audio_sink</span><span class="p">,</span>
      <span class="n">video_queue</span><span class="p">,</span> <span class="n">visual</span><span class="p">,</span> <span class="n">video_convert</span><span class="p">,</span> <span class="n">video_sink</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">gst_element_link_many</span> <span class="p">(</span><span class="n">audio_source</span><span class="p">,</span> <span class="n">tee</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TRUE</span> <span class="o">||</span>
      <span class="n">gst_element_link_many</span> <span class="p">(</span><span class="n">audio_queue</span><span class="p">,</span> <span class="n">audio_convert</span><span class="p">,</span> <span class="n">audio_resample</span><span class="p">,</span> <span class="n">audio_sink</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TRUE</span> <span class="o">||</span>
      <span class="n">gst_element_link_many</span> <span class="p">(</span><span class="n">video_queue</span><span class="p">,</span> <span class="n">visual</span><span class="p">,</span> <span class="n">video_convert</span><span class="p">,</span> <span class="n">video_sink</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Elements could not be linked.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/* Manually link the Tee, which has "Request" pads */</span>
  <span class="n">tee_audio_pad</span> <span class="o">=</span> <span class="n">gst_element_get_request_pad</span> <span class="p">(</span><span class="n">tee</span><span class="p">,</span> <span class="s">"src_%u"</span><span class="p">);</span>
  <span class="n">g_print</span> <span class="p">(</span><span class="s">"Obtained request pad %s for audio branch.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">gst_pad_get_name</span> <span class="p">(</span><span class="n">tee_audio_pad</span><span class="p">));</span>
  <span class="n">queue_audio_pad</span> <span class="o">=</span> <span class="n">gst_element_get_static_pad</span> <span class="p">(</span><span class="n">audio_queue</span><span class="p">,</span> <span class="s">"sink"</span><span class="p">);</span>
  <span class="n">tee_video_pad</span> <span class="o">=</span> <span class="n">gst_element_get_request_pad</span> <span class="p">(</span><span class="n">tee</span><span class="p">,</span> <span class="s">"src_%u"</span><span class="p">);</span>
  <span class="n">g_print</span> <span class="p">(</span><span class="s">"Obtained request pad %s for video branch.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">gst_pad_get_name</span> <span class="p">(</span><span class="n">tee_video_pad</span><span class="p">));</span>
  <span class="n">queue_video_pad</span> <span class="o">=</span> <span class="n">gst_element_get_static_pad</span> <span class="p">(</span><span class="n">video_queue</span><span class="p">,</span> <span class="s">"sink"</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">gst_pad_link</span> <span class="p">(</span><span class="n">tee_audio_pad</span><span class="p">,</span> <span class="n">queue_audio_pad</span><span class="p">)</span> <span class="o">!=</span> <span class="n">GST_PAD_LINK_OK</span> <span class="o">||</span>
      <span class="n">gst_pad_link</span> <span class="p">(</span><span class="n">tee_video_pad</span><span class="p">,</span> <span class="n">queue_video_pad</span><span class="p">)</span> <span class="o">!=</span> <span class="n">GST_PAD_LINK_OK</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Tee could not be linked.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">queue_audio_pad</span><span class="p">);</span>
  <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">queue_video_pad</span><span class="p">);</span>

  <span class="cm">/* Start playing the pipeline */</span>
  <span class="n">gst_element_set_state</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">GST_STATE_PLAYING</span><span class="p">);</span>

  <span class="cm">/* Wait until error or EOS */</span>
  <span class="n">bus</span> <span class="o">=</span> <span class="n">gst_element_get_bus</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">);</span>
  <span class="n">msg</span> <span class="o">=</span> <span class="n">gst_bus_timed_pop_filtered</span> <span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">GST_CLOCK_TIME_NONE</span><span class="p">,</span> <span class="n">GST_MESSAGE_ERROR</span> <span class="o">|</span> <span class="n">GST_MESSAGE_EOS</span><span class="p">);</span>

  <span class="cm">/* Release the request pads from the Tee, and unref them */</span>
  <span class="n">gst_element_release_request_pad</span> <span class="p">(</span><span class="n">tee</span><span class="p">,</span> <span class="n">tee_audio_pad</span><span class="p">);</span>
  <span class="n">gst_element_release_request_pad</span> <span class="p">(</span><span class="n">tee</span><span class="p">,</span> <span class="n">tee_video_pad</span><span class="p">);</span>
  <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">tee_audio_pad</span><span class="p">);</span>
  <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">tee_video_pad</span><span class="p">);</span>

  <span class="cm">/* Free resources */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">msg</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="n">gst_message_unref</span> <span class="p">(</span><span class="n">msg</span><span class="p">);</span>
  <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">bus</span><span class="p">);</span>
  <span class="n">gst_element_set_state</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">GST_STATE_NULL</span><span class="p">);</span>

  <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="初始化element"><span class="mr-2">初始化element</span><a href="#初始化element" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="cm">/* Create the elements */</span>
<span class="n">audio_source</span> <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"audiotestsrc"</span><span class="p">,</span> <span class="s">"audio_source"</span><span class="p">);</span>
<span class="n">tee</span> <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"tee"</span><span class="p">,</span> <span class="s">"tee"</span><span class="p">);</span>
<span class="n">audio_queue</span> <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"queue"</span><span class="p">,</span> <span class="s">"audio_queue"</span><span class="p">);</span>
<span class="n">audio_convert</span> <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"audioconvert"</span><span class="p">,</span> <span class="s">"audio_convert"</span><span class="p">);</span>
  <span class="n">audio_resample</span> <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"audioresample"</span><span class="p">,</span> <span class="s">"audio_resample"</span><span class="p">);</span>
<span class="n">audio_sink</span> <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"autoaudiosink"</span><span class="p">,</span> <span class="s">"audio_sink"</span><span class="p">);</span>
<span class="n">video_queue</span> <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"queue"</span><span class="p">,</span> <span class="s">"video_queue"</span><span class="p">);</span>
<span class="n">visual</span> <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"wavescope"</span><span class="p">,</span> <span class="s">"visual"</span><span class="p">);</span>
<span class="n">video_convert</span> <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"videoconvert"</span><span class="p">,</span> <span class="s">"video_convert"</span><span class="p">);</span>
<span class="n">video_sink</span> <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"autovideosink"</span><span class="p">,</span> <span class="s">"video_sink"</span><span class="p">);</span>
</pre></table></code></div></div><h2 id="調整element"><span class="mr-2">調整element</span><a href="#調整element" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>為了範例需求，微調屬性</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="cm">/* Configure elements */</span>
<span class="n">g_object_set</span> <span class="p">(</span><span class="n">audio_source</span><span class="p">,</span> <span class="s">"freq"</span><span class="p">,</span> <span class="mi">215</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="n">g_object_set</span> <span class="p">(</span><span class="n">visual</span><span class="p">,</span> <span class="s">"shader"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"style"</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</pre></table></code></div></div><h2 id="將element放進pipeline"><span class="mr-2">將element放進pipeline</span><a href="#將element放進pipeline" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>將所有element放入pipeline並且連接所有<code class="language-plaintext highlighter-rouge">Always Pads</code></p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="cm">/* Link all elements that can be automatically linked because they have "Always" pads */</span>
<span class="n">gst_bin_add_many</span> <span class="p">(</span><span class="n">GST_BIN</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">),</span> <span class="n">audio_source</span><span class="p">,</span> <span class="n">tee</span><span class="p">,</span> <span class="n">audio_queue</span><span class="p">,</span> <span class="n">audio_convert</span><span class="p">,</span> <span class="n">audio_sink</span><span class="p">,</span>
    <span class="n">video_queue</span><span class="p">,</span> <span class="n">visual</span><span class="p">,</span> <span class="n">video_convert</span><span class="p">,</span> <span class="n">video_sink</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">gst_element_link_many</span> <span class="p">(</span><span class="n">audio_source</span><span class="p">,</span> <span class="n">tee</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TRUE</span> <span class="o">||</span>
    <span class="n">gst_element_link_many</span> <span class="p">(</span><span class="n">audio_queue</span><span class="p">,</span> <span class="n">audio_convert</span><span class="p">,</span> <span class="n">audio_sink</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TRUE</span> <span class="o">||</span>
    <span class="n">gst_element_link_many</span> <span class="p">(</span><span class="n">video_queue</span><span class="p">,</span> <span class="n">visual</span><span class="p">,</span> <span class="n">video_convert</span><span class="p">,</span> <span class="n">video_sink</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Elements could not be linked.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">);</span>
  <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>注意:<br /> <code class="language-plaintext highlighter-rouge">gst_element_link_many()</code>其實也可以自動連接<code class="language-plaintext highlighter-rouge">Request Pads</code>。因為它會自動請求新的pad。但是問題是你還是必須要手動釋放<code class="language-plaintext highlighter-rouge">Request Pads</code>。所以最好的做法是手動連接<code class="language-plaintext highlighter-rouge">Request Pads</code>。</p><h2 id="連接request-pads"><span class="mr-2">連接Request Pads</span><a href="#連接request-pads" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>要連接<code class="language-plaintext highlighter-rouge">Request Pads</code>必須要先跟element請求，而因為element有時候可以產生不同的request pads，所以要提供所需的Pad Template名稱。</p><p>在tee的文件中可以看到他有兩個Pad Template，一個是”sink”，另一個是”src_%u”(也就是Request pads)，我們可以用<code class="language-plaintext highlighter-rouge">gst_element_request_pad_simple()</code>函式來請求兩個Pads(一個給audio一個給video)。</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>Pad Templates:
  SRC template: 'src_%u'
    Availability: On request
    Capabilities:
      ANY
  
  SINK template: 'sink'
    Availability: Always
    Capabilities:
      ANY
</pre></table></code></div></div><p>接著我們需要取得下游queue element的Always pad，因此用<code class="language-plaintext highlighter-rouge">gst_element_get_static_pad()</code>。</p><p>我們用<code class="language-plaintext highlighter-rouge">gst_pad_link()</code>連接Pads。<code class="language-plaintext highlighter-rouge">gst_pad_link()</code>內部其實就是<code class="language-plaintext highlighter-rouge">gst_element_link()</code>和<code class="language-plaintext highlighter-rouge">gst_element_link_many()</code></p><p>我們用來儲存下游queue always pad的變數<code class="language-plaintext highlighter-rouge">queue_audio_pad</code>和<code class="language-plaintext highlighter-rouge">queue_video_pad</code>要記得釋放，以免佔用reference count。</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="cm">/* Manually link the Tee, which has "Request" pads */</span>
<span class="n">tee_audio_pad</span> <span class="o">=</span> <span class="n">gst_element_get_request_pad</span> <span class="p">(</span><span class="n">tee</span><span class="p">,</span> <span class="s">"src_%u"</span><span class="p">);</span>
<span class="n">g_print</span> <span class="p">(</span><span class="s">"Obtained request pad %s for audio branch.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">gst_pad_get_name</span> <span class="p">(</span><span class="n">tee_audio_pad</span><span class="p">));</span>
<span class="n">queue_audio_pad</span> <span class="o">=</span> <span class="n">gst_element_get_static_pad</span> <span class="p">(</span><span class="n">audio_queue</span><span class="p">,</span> <span class="s">"sink"</span><span class="p">);</span>
<span class="n">tee_video_pad</span> <span class="o">=</span> <span class="n">gst_element_get_request_pad</span> <span class="p">(</span><span class="n">tee</span><span class="p">,</span> <span class="s">"src_%u"</span><span class="p">);</span>
<span class="n">g_print</span> <span class="p">(</span><span class="s">"Obtained request pad %s for video branch.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">gst_pad_get_name</span> <span class="p">(</span><span class="n">tee_video_pad</span><span class="p">));</span>
<span class="n">queue_video_pad</span> <span class="o">=</span> <span class="n">gst_element_get_static_pad</span> <span class="p">(</span><span class="n">video_queue</span><span class="p">,</span> <span class="s">"sink"</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">gst_pad_link</span> <span class="p">(</span><span class="n">tee_audio_pad</span><span class="p">,</span> <span class="n">queue_audio_pad</span><span class="p">)</span> <span class="o">!=</span> <span class="n">GST_PAD_LINK_OK</span> <span class="o">||</span>
    <span class="n">gst_pad_link</span> <span class="p">(</span><span class="n">tee_video_pad</span><span class="p">,</span> <span class="n">queue_video_pad</span><span class="p">)</span> <span class="o">!=</span> <span class="n">GST_PAD_LINK_OK</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Tee could not be linked.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">);</span>
  <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">queue_audio_pad</span><span class="p">);</span>
<span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">queue_video_pad</span><span class="p">);</span>
</pre></table></code></div></div><p>最後在程式結束後，要記得釋放request pad</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="cm">/* Release the request pads from the Tee, and unref them */</span>
<span class="n">gst_element_release_request_pad</span> <span class="p">(</span><span class="n">tee</span><span class="p">,</span> <span class="n">tee_audio_pad</span><span class="p">);</span>
<span class="n">gst_element_release_request_pad</span> <span class="p">(</span><span class="n">tee</span><span class="p">,</span> <span class="n">tee_video_pad</span><span class="p">);</span>
<span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">tee_audio_pad</span><span class="p">);</span>
<span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">tee_video_pad</span><span class="p">);</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">gst_element_release_request_pad()</code>從tee釋放requests pads，<code class="language-plaintext highlighter-rouge">gst_object_unref</code>釋放<code class="language-plaintext highlighter-rouge">tee_audio_pad</code>變數</p><h1 id="hort-cutting-the-pipeline-goal">hort-cutting the pipeline Goal</h1><p>pipeline的資料並不是封閉的，我們可以從外界注入資料給pipeline，也可以從pipeline內取得資料</p><h2 id="appsrcappsink"><span class="mr-2">appsrc、appsink</span><a href="#appsrcappsink" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>把資料注入pipeline的element為<code class="language-plaintext highlighter-rouge">appsrc</code>，相反的從pipeline取得資料的element是<code class="language-plaintext highlighter-rouge">appsink</code>。這裡sink和source的概念是從GStreamer應用程式的角度來看，你可以想像<code class="language-plaintext highlighter-rouge">appsrc</code>也是一個source，只不過他的資料來源是來自於應用程式，相反的<code class="language-plaintext highlighter-rouge">appsink</code>就像普通的<code class="language-plaintext highlighter-rouge">sink</code>只是他最後流向應用程式。</p><p>appsrc有多種模式，在<code class="language-plaintext highlighter-rouge">pull</code>模式每當需要的時候他將會向應用程式索取資料。在<code class="language-plaintext highlighter-rouge">push</code>模式則是應用程式主動推送資料進去。在<code class="language-plaintext highlighter-rouge">push</code>模式中應用程式還可以阻塞push function當已經推入足夠多的資料到pipeline裡面的時候，或者他可以監聽<code class="language-plaintext highlighter-rouge">enough-data</code>和<code class="language-plaintext highlighter-rouge">need-data</code>訊號。</p><h2 id="buffers"><span class="mr-2">Buffers</span><a href="#buffers" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>數據以Chunks方式進入pipeline的方式稱為Buffers，Buffers代表一單位的資料，但是每一個Buffers大小不一定一樣大。注意，我們不應該假設一個Buffers進入element就同時會有一個離開element。element可以隨意地讓Buffers停留在element內部。</p><p>Source pad產生Buffers，而sink pad接收Buffers，Gstreamer將這些Buffers一流過每一個element。</p><h2 id="gstbuffer-和-gstmemory"><span class="mr-2">GstBuffer 和 GstMemory</span><a href="#gstbuffer-和-gstmemory" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>GstBuffers 可能包含一個或一個以上的memory buffer，而真正的記憶體buffer被抽像化為<code class="language-plaintext highlighter-rouge">GstMemory</code>，因此一個<code class="language-plaintext highlighter-rouge">GstBuffer</code>可以包含一個或一個以上的<code class="language-plaintext highlighter-rouge">GstMemory</code></p><p>每一個buffer都有時間戳和長度，以及他需要被decode的長度。</p><h2 id="範例-5"><span class="mr-2">範例</span><a href="#範例-5" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>下面範例延續Multithreading and Pad Availability的範例並擴展。</p><p>首先<code class="language-plaintext highlighter-rouge">audiotestsrc</code>被置換成<code class="language-plaintext highlighter-rouge">appsrc</code>來產生audio資料。</p><p>第二個是增加一個新的<code class="language-plaintext highlighter-rouge">tee</code>分支，這隻分支會接著<code class="language-plaintext highlighter-rouge">appsink</code>，<code class="language-plaintext highlighter-rouge">appsink</code>會將資訊回傳給應用程式。</p><p>範例<code class="language-plaintext highlighter-rouge">basic-tutorial-8.c</code>的程式如下</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;gst/gst.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;gst/audio/audio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span>
<span class="cp">#define CHUNK_SIZE 1024   </span><span class="cm">/* Amount of bytes we are sending in each buffer */</span><span class="cp">
#define SAMPLE_RATE 44100 </span><span class="cm">/* Samples per second we are sending */</span><span class="cp">
</span>
<span class="cm">/* Structure to contain all our information, so we can pass it to callbacks */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_CustomData</span> <span class="p">{</span>
  <span class="n">GstElement</span> <span class="o">*</span><span class="n">pipeline</span><span class="p">,</span> <span class="o">*</span><span class="n">app_source</span><span class="p">,</span> <span class="o">*</span><span class="n">tee</span><span class="p">,</span> <span class="o">*</span><span class="n">audio_queue</span><span class="p">,</span> <span class="o">*</span><span class="n">audio_convert1</span><span class="p">,</span> <span class="o">*</span><span class="n">audio_resample</span><span class="p">,</span> <span class="o">*</span><span class="n">audio_sink</span><span class="p">;</span>
  <span class="n">GstElement</span> <span class="o">*</span><span class="n">video_queue</span><span class="p">,</span> <span class="o">*</span><span class="n">audio_convert2</span><span class="p">,</span> <span class="o">*</span><span class="n">visual</span><span class="p">,</span> <span class="o">*</span><span class="n">video_convert</span><span class="p">,</span> <span class="o">*</span><span class="n">video_sink</span><span class="p">;</span>
  <span class="n">GstElement</span> <span class="o">*</span><span class="n">app_queue</span><span class="p">,</span> <span class="o">*</span><span class="n">app_sink</span><span class="p">;</span>

  <span class="n">guint64</span> <span class="n">num_samples</span><span class="p">;</span>   <span class="cm">/* Number of samples generated so far (for timestamp generation) */</span>
  <span class="n">gfloat</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">;</span>     <span class="cm">/* For waveform generation */</span>

  <span class="n">guint</span> <span class="n">sourceid</span><span class="p">;</span>        <span class="cm">/* To control the GSource */</span>

  <span class="n">GMainLoop</span> <span class="o">*</span><span class="n">main_loop</span><span class="p">;</span>  <span class="cm">/* GLib's Main Loop */</span>
<span class="p">}</span> <span class="n">CustomData</span><span class="p">;</span>

<span class="cm">/* This method is called by the idle GSource in the mainloop, to feed CHUNK_SIZE bytes into appsrc.
 * The idle handler is added to the mainloop when appsrc requests us to start sending data (need-data signal)
 * and is removed when appsrc has enough data (enough-data signal).
 */</span>
<span class="k">static</span> <span class="n">gboolean</span> <span class="nf">push_data</span> <span class="p">(</span><span class="n">CustomData</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">GstBuffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
  <span class="n">GstFlowReturn</span> <span class="n">ret</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="n">GstMapInfo</span> <span class="n">map</span><span class="p">;</span>
  <span class="n">gint16</span> <span class="o">*</span><span class="n">raw</span><span class="p">;</span>
  <span class="n">gint</span> <span class="n">num_samples</span> <span class="o">=</span> <span class="n">CHUNK_SIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* Because each sample is 16 bits */</span>
  <span class="n">gfloat</span> <span class="n">freq</span><span class="p">;</span>

  <span class="cm">/* Create a new empty buffer */</span>
  <span class="n">buffer</span> <span class="o">=</span> <span class="n">gst_buffer_new_and_alloc</span> <span class="p">(</span><span class="n">CHUNK_SIZE</span><span class="p">);</span>

  <span class="cm">/* Set its timestamp and duration */</span>
  <span class="n">GST_BUFFER_TIMESTAMP</span> <span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">=</span> <span class="n">gst_util_uint64_scale</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">num_samples</span><span class="p">,</span> <span class="n">GST_SECOND</span><span class="p">,</span> <span class="n">SAMPLE_RATE</span><span class="p">);</span>
  <span class="n">GST_BUFFER_DURATION</span> <span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">=</span> <span class="n">gst_util_uint64_scale</span> <span class="p">(</span><span class="n">num_samples</span><span class="p">,</span> <span class="n">GST_SECOND</span><span class="p">,</span> <span class="n">SAMPLE_RATE</span><span class="p">);</span>

  <span class="cm">/* Generate some psychodelic waveforms */</span>
  <span class="n">gst_buffer_map</span> <span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">map</span><span class="p">,</span> <span class="n">GST_MAP_WRITE</span><span class="p">);</span>
  <span class="n">raw</span> <span class="o">=</span> <span class="p">(</span><span class="n">gint16</span> <span class="o">*</span><span class="p">)</span><span class="n">map</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
  <span class="n">data</span><span class="o">-&gt;</span><span class="n">c</span> <span class="o">+=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">;</span>
  <span class="n">data</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">-=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">c</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
  <span class="n">freq</span> <span class="o">=</span> <span class="mi">1100</span> <span class="o">+</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_samples</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">data</span><span class="o">-&gt;</span><span class="n">a</span> <span class="o">+=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">;</span>
    <span class="n">data</span><span class="o">-&gt;</span><span class="n">b</span> <span class="o">-=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">a</span> <span class="o">/</span> <span class="n">freq</span><span class="p">;</span>
    <span class="n">raw</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">gint16</span><span class="p">)(</span><span class="mi">500</span> <span class="o">*</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">gst_buffer_unmap</span> <span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">map</span><span class="p">);</span>
  <span class="n">data</span><span class="o">-&gt;</span><span class="n">num_samples</span> <span class="o">+=</span> <span class="n">num_samples</span><span class="p">;</span>

  <span class="cm">/* Push the buffer into the appsrc */</span>
  <span class="n">g_signal_emit_by_name</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">app_source</span><span class="p">,</span> <span class="s">"push-buffer"</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">);</span>

  <span class="cm">/* Free the buffer now that we are done with it */</span>
  <span class="n">gst_buffer_unref</span> <span class="p">(</span><span class="n">buffer</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">GST_FLOW_OK</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* We got some error, stop sending data */</span>
    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This signal callback triggers when appsrc needs data. Here, we add an idle handler
 * to the mainloop to start pushing data into the appsrc */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">start_feed</span> <span class="p">(</span><span class="n">GstElement</span> <span class="o">*</span><span class="n">source</span><span class="p">,</span> <span class="n">guint</span> <span class="n">size</span><span class="p">,</span> <span class="n">CustomData</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sourceid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">g_print</span> <span class="p">(</span><span class="s">"Start feeding</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">data</span><span class="o">-&gt;</span><span class="n">sourceid</span> <span class="o">=</span> <span class="n">g_idle_add</span> <span class="p">((</span><span class="n">GSourceFunc</span><span class="p">)</span> <span class="n">push_data</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* This callback triggers when appsrc has enough data and we can stop sending.
 * We remove the idle handler from the mainloop */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">stop_feed</span> <span class="p">(</span><span class="n">GstElement</span> <span class="o">*</span><span class="n">source</span><span class="p">,</span> <span class="n">CustomData</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sourceid</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">g_print</span> <span class="p">(</span><span class="s">"Stop feeding</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">g_source_remove</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sourceid</span><span class="p">);</span>
    <span class="n">data</span><span class="o">-&gt;</span><span class="n">sourceid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* The appsink has received a buffer */</span>
<span class="k">static</span> <span class="n">GstFlowReturn</span> <span class="nf">new_sample</span> <span class="p">(</span><span class="n">GstElement</span> <span class="o">*</span><span class="n">sink</span><span class="p">,</span> <span class="n">CustomData</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">GstSample</span> <span class="o">*</span><span class="n">sample</span><span class="p">;</span>

  <span class="cm">/* Retrieve the buffer */</span>
  <span class="n">g_signal_emit_by_name</span> <span class="p">(</span><span class="n">sink</span><span class="p">,</span> <span class="s">"pull-sample"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sample</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">sample</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* The only thing we do in this example is print a * to indicate a received buffer */</span>
    <span class="n">g_print</span> <span class="p">(</span><span class="s">"*"</span><span class="p">);</span>
    <span class="n">gst_sample_unref</span> <span class="p">(</span><span class="n">sample</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">GST_FLOW_OK</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">GST_FLOW_ERROR</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This function is called when an error message is posted on the bus */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">error_cb</span> <span class="p">(</span><span class="n">GstBus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="n">GstMessage</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="n">CustomData</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">GError</span> <span class="o">*</span><span class="n">err</span><span class="p">;</span>
  <span class="n">gchar</span> <span class="o">*</span><span class="n">debug_info</span><span class="p">;</span>

  <span class="cm">/* Print error details on the screen */</span>
  <span class="n">gst_message_parse_error</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">debug_info</span><span class="p">);</span>
  <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Error received from element %s: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GST_OBJECT_NAME</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">),</span> <span class="n">err</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">);</span>
  <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Debugging information: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">debug_info</span> <span class="o">?</span> <span class="n">debug_info</span> <span class="o">:</span> <span class="s">"none"</span><span class="p">);</span>
  <span class="n">g_clear_error</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
  <span class="n">g_free</span> <span class="p">(</span><span class="n">debug_info</span><span class="p">);</span>

  <span class="n">g_main_loop_quit</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">main_loop</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
  <span class="n">CustomData</span> <span class="n">data</span><span class="p">;</span>
  <span class="n">GstPad</span> <span class="o">*</span><span class="n">tee_audio_pad</span><span class="p">,</span> <span class="o">*</span><span class="n">tee_video_pad</span><span class="p">,</span> <span class="o">*</span><span class="n">tee_app_pad</span><span class="p">;</span>
  <span class="n">GstPad</span> <span class="o">*</span><span class="n">queue_audio_pad</span><span class="p">,</span> <span class="o">*</span><span class="n">queue_video_pad</span><span class="p">,</span> <span class="o">*</span><span class="n">queue_app_pad</span><span class="p">;</span>
  <span class="n">GstAudioInfo</span> <span class="n">info</span><span class="p">;</span>
  <span class="n">GstCaps</span> <span class="o">*</span><span class="n">audio_caps</span><span class="p">;</span>
  <span class="n">GstBus</span> <span class="o">*</span><span class="n">bus</span><span class="p">;</span>

  <span class="cm">/* Initialize custom data structure */</span>
  <span class="n">memset</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">data</span><span class="p">));</span>
  <span class="n">data</span><span class="p">.</span><span class="n">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* For waveform generation */</span>
  <span class="n">data</span><span class="p">.</span><span class="n">d</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

  <span class="cm">/* Initialize GStreamer */</span>
  <span class="n">gst_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span>

  <span class="cm">/* Create the elements */</span>
  <span class="n">data</span><span class="p">.</span><span class="n">app_source</span> <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"appsrc"</span><span class="p">,</span> <span class="s">"audio_source"</span><span class="p">);</span>
  <span class="n">data</span><span class="p">.</span><span class="n">tee</span> <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"tee"</span><span class="p">,</span> <span class="s">"tee"</span><span class="p">);</span>
  <span class="n">data</span><span class="p">.</span><span class="n">audio_queue</span> <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"queue"</span><span class="p">,</span> <span class="s">"audio_queue"</span><span class="p">);</span>
  <span class="n">data</span><span class="p">.</span><span class="n">audio_convert1</span> <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"audioconvert"</span><span class="p">,</span> <span class="s">"audio_convert1"</span><span class="p">);</span>
  <span class="n">data</span><span class="p">.</span><span class="n">audio_resample</span> <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"audioresample"</span><span class="p">,</span> <span class="s">"audio_resample"</span><span class="p">);</span>
  <span class="n">data</span><span class="p">.</span><span class="n">audio_sink</span> <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"autoaudiosink"</span><span class="p">,</span> <span class="s">"audio_sink"</span><span class="p">);</span>
  <span class="n">data</span><span class="p">.</span><span class="n">video_queue</span> <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"queue"</span><span class="p">,</span> <span class="s">"video_queue"</span><span class="p">);</span>
  <span class="n">data</span><span class="p">.</span><span class="n">audio_convert2</span> <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"audioconvert"</span><span class="p">,</span> <span class="s">"audio_convert2"</span><span class="p">);</span>
  <span class="n">data</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"wavescope"</span><span class="p">,</span> <span class="s">"visual"</span><span class="p">);</span>
  <span class="n">data</span><span class="p">.</span><span class="n">video_convert</span> <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"videoconvert"</span><span class="p">,</span> <span class="s">"video_convert"</span><span class="p">);</span>
  <span class="n">data</span><span class="p">.</span><span class="n">video_sink</span> <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"autovideosink"</span><span class="p">,</span> <span class="s">"video_sink"</span><span class="p">);</span>
  <span class="n">data</span><span class="p">.</span><span class="n">app_queue</span> <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"queue"</span><span class="p">,</span> <span class="s">"app_queue"</span><span class="p">);</span>
  <span class="n">data</span><span class="p">.</span><span class="n">app_sink</span> <span class="o">=</span> <span class="n">gst_element_factory_make</span> <span class="p">(</span><span class="s">"appsink"</span><span class="p">,</span> <span class="s">"app_sink"</span><span class="p">);</span>

  <span class="cm">/* Create the empty pipeline */</span>
  <span class="n">data</span><span class="p">.</span><span class="n">pipeline</span> <span class="o">=</span> <span class="n">gst_pipeline_new</span> <span class="p">(</span><span class="s">"test-pipeline"</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">.</span><span class="n">pipeline</span> <span class="o">||</span> <span class="o">!</span><span class="n">data</span><span class="p">.</span><span class="n">app_source</span> <span class="o">||</span> <span class="o">!</span><span class="n">data</span><span class="p">.</span><span class="n">tee</span> <span class="o">||</span> <span class="o">!</span><span class="n">data</span><span class="p">.</span><span class="n">audio_queue</span> <span class="o">||</span> <span class="o">!</span><span class="n">data</span><span class="p">.</span><span class="n">audio_convert1</span> <span class="o">||</span>
      <span class="o">!</span><span class="n">data</span><span class="p">.</span><span class="n">audio_resample</span> <span class="o">||</span> <span class="o">!</span><span class="n">data</span><span class="p">.</span><span class="n">audio_sink</span> <span class="o">||</span> <span class="o">!</span><span class="n">data</span><span class="p">.</span><span class="n">video_queue</span> <span class="o">||</span> <span class="o">!</span><span class="n">data</span><span class="p">.</span><span class="n">audio_convert2</span> <span class="o">||</span> <span class="o">!</span><span class="n">data</span><span class="p">.</span><span class="n">visual</span> <span class="o">||</span>
      <span class="o">!</span><span class="n">data</span><span class="p">.</span><span class="n">video_convert</span> <span class="o">||</span> <span class="o">!</span><span class="n">data</span><span class="p">.</span><span class="n">video_sink</span> <span class="o">||</span> <span class="o">!</span><span class="n">data</span><span class="p">.</span><span class="n">app_queue</span> <span class="o">||</span> <span class="o">!</span><span class="n">data</span><span class="p">.</span><span class="n">app_sink</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Not all elements could be created.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/* Configure wavescope */</span>
  <span class="n">g_object_set</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">visual</span><span class="p">,</span> <span class="s">"shader"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"style"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

  <span class="cm">/* Configure appsrc */</span>
  <span class="n">gst_audio_info_set_format</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">GST_AUDIO_FORMAT_S16</span><span class="p">,</span> <span class="n">SAMPLE_RATE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="n">audio_caps</span> <span class="o">=</span> <span class="n">gst_audio_info_to_caps</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
  <span class="n">g_object_set</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">app_source</span><span class="p">,</span> <span class="s">"caps"</span><span class="p">,</span> <span class="n">audio_caps</span><span class="p">,</span> <span class="s">"format"</span><span class="p">,</span> <span class="n">GST_FORMAT_TIME</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="n">g_signal_connect</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">app_source</span><span class="p">,</span> <span class="s">"need-data"</span><span class="p">,</span> <span class="n">G_CALLBACK</span> <span class="p">(</span><span class="n">start_feed</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
  <span class="n">g_signal_connect</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">app_source</span><span class="p">,</span> <span class="s">"enough-data"</span><span class="p">,</span> <span class="n">G_CALLBACK</span> <span class="p">(</span><span class="n">stop_feed</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>

  <span class="cm">/* Configure appsink */</span>
  <span class="n">g_object_set</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">app_sink</span><span class="p">,</span> <span class="s">"emit-signals"</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">,</span> <span class="s">"caps"</span><span class="p">,</span> <span class="n">audio_caps</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="n">g_signal_connect</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">app_sink</span><span class="p">,</span> <span class="s">"new-sample"</span><span class="p">,</span> <span class="n">G_CALLBACK</span> <span class="p">(</span><span class="n">new_sample</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
  <span class="n">gst_caps_unref</span> <span class="p">(</span><span class="n">audio_caps</span><span class="p">);</span>

  <span class="cm">/* Link all elements that can be automatically linked because they have "Always" pads */</span>
  <span class="n">gst_bin_add_many</span> <span class="p">(</span><span class="n">GST_BIN</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">pipeline</span><span class="p">),</span> <span class="n">data</span><span class="p">.</span><span class="n">app_source</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">tee</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">audio_queue</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">audio_convert1</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">audio_resample</span><span class="p">,</span>
      <span class="n">data</span><span class="p">.</span><span class="n">audio_sink</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">video_queue</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">audio_convert2</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">visual</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">video_convert</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">video_sink</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">app_queue</span><span class="p">,</span>
      <span class="n">data</span><span class="p">.</span><span class="n">app_sink</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">gst_element_link_many</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">app_source</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">tee</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TRUE</span> <span class="o">||</span>
      <span class="n">gst_element_link_many</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">audio_queue</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">audio_convert1</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">audio_resample</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">audio_sink</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TRUE</span> <span class="o">||</span>
      <span class="n">gst_element_link_many</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">video_queue</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">audio_convert2</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">visual</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">video_convert</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">video_sink</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TRUE</span> <span class="o">||</span>
      <span class="n">gst_element_link_many</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">app_queue</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">app_sink</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Elements could not be linked.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">pipeline</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/* Manually link the Tee, which has "Request" pads */</span>
  <span class="n">tee_audio_pad</span> <span class="o">=</span> <span class="n">gst_element_request_pad_simple</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">tee</span><span class="p">,</span> <span class="s">"src_%u"</span><span class="p">);</span>
  <span class="n">g_print</span> <span class="p">(</span><span class="s">"Obtained request pad %s for audio branch.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">gst_pad_get_name</span> <span class="p">(</span><span class="n">tee_audio_pad</span><span class="p">));</span>
  <span class="n">queue_audio_pad</span> <span class="o">=</span> <span class="n">gst_element_get_static_pad</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">audio_queue</span><span class="p">,</span> <span class="s">"sink"</span><span class="p">);</span>
  <span class="n">tee_video_pad</span> <span class="o">=</span> <span class="n">gst_element_request_pad_simple</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">tee</span><span class="p">,</span> <span class="s">"src_%u"</span><span class="p">);</span>
  <span class="n">g_print</span> <span class="p">(</span><span class="s">"Obtained request pad %s for video branch.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">gst_pad_get_name</span> <span class="p">(</span><span class="n">tee_video_pad</span><span class="p">));</span>
  <span class="n">queue_video_pad</span> <span class="o">=</span> <span class="n">gst_element_get_static_pad</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">video_queue</span><span class="p">,</span> <span class="s">"sink"</span><span class="p">);</span>
  <span class="n">tee_app_pad</span> <span class="o">=</span> <span class="n">gst_element_request_pad_simple</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">tee</span><span class="p">,</span> <span class="s">"src_%u"</span><span class="p">);</span>
  <span class="n">g_print</span> <span class="p">(</span><span class="s">"Obtained request pad %s for app branch.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">gst_pad_get_name</span> <span class="p">(</span><span class="n">tee_app_pad</span><span class="p">));</span>
  <span class="n">queue_app_pad</span> <span class="o">=</span> <span class="n">gst_element_get_static_pad</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">app_queue</span><span class="p">,</span> <span class="s">"sink"</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">gst_pad_link</span> <span class="p">(</span><span class="n">tee_audio_pad</span><span class="p">,</span> <span class="n">queue_audio_pad</span><span class="p">)</span> <span class="o">!=</span> <span class="n">GST_PAD_LINK_OK</span> <span class="o">||</span>
      <span class="n">gst_pad_link</span> <span class="p">(</span><span class="n">tee_video_pad</span><span class="p">,</span> <span class="n">queue_video_pad</span><span class="p">)</span> <span class="o">!=</span> <span class="n">GST_PAD_LINK_OK</span> <span class="o">||</span>
      <span class="n">gst_pad_link</span> <span class="p">(</span><span class="n">tee_app_pad</span><span class="p">,</span> <span class="n">queue_app_pad</span><span class="p">)</span> <span class="o">!=</span> <span class="n">GST_PAD_LINK_OK</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Tee could not be linked</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">pipeline</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">queue_audio_pad</span><span class="p">);</span>
  <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">queue_video_pad</span><span class="p">);</span>
  <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">queue_app_pad</span><span class="p">);</span>

  <span class="cm">/* Instruct the bus to emit signals for each received message, and connect to the interesting signals */</span>
  <span class="n">bus</span> <span class="o">=</span> <span class="n">gst_element_get_bus</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">pipeline</span><span class="p">);</span>
  <span class="n">gst_bus_add_signal_watch</span> <span class="p">(</span><span class="n">bus</span><span class="p">);</span>
  <span class="n">g_signal_connect</span> <span class="p">(</span><span class="n">G_OBJECT</span> <span class="p">(</span><span class="n">bus</span><span class="p">),</span> <span class="s">"message::error"</span><span class="p">,</span> <span class="p">(</span><span class="n">GCallback</span><span class="p">)</span><span class="n">error_cb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
  <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">bus</span><span class="p">);</span>

  <span class="cm">/* Start playing the pipeline */</span>
  <span class="n">gst_element_set_state</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">GST_STATE_PLAYING</span><span class="p">);</span>

  <span class="cm">/* Create a GLib Main Loop and set it to run */</span>
  <span class="n">data</span><span class="p">.</span><span class="n">main_loop</span> <span class="o">=</span> <span class="n">g_main_loop_new</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
  <span class="n">g_main_loop_run</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">main_loop</span><span class="p">);</span>

  <span class="cm">/* Release the request pads from the Tee, and unref them */</span>
  <span class="n">gst_element_release_request_pad</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">tee</span><span class="p">,</span> <span class="n">tee_audio_pad</span><span class="p">);</span>
  <span class="n">gst_element_release_request_pad</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">tee</span><span class="p">,</span> <span class="n">tee_video_pad</span><span class="p">);</span>
  <span class="n">gst_element_release_request_pad</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">tee</span><span class="p">,</span> <span class="n">tee_app_pad</span><span class="p">);</span>
  <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">tee_audio_pad</span><span class="p">);</span>
  <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">tee_video_pad</span><span class="p">);</span>
  <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">tee_app_pad</span><span class="p">);</span>

  <span class="cm">/* Free resources */</span>
  <span class="n">gst_element_set_state</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">GST_STATE_NULL</span><span class="p">);</span>
  <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">pipeline</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="加入appsrc和appsink"><span class="mr-2">加入appsrc和appsink</span><a href="#加入appsrc和appsink" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>首先要先設定appsrc的caps，他決定了appsrc所輸出的資料類型。我們可以用字串來建立<code class="language-plaintext highlighter-rouge">GstCaps</code>物件，只需要用<code class="language-plaintext highlighter-rouge">gst_caps_from_string()</code>函式。</p><p>另外我們還必須連接<code class="language-plaintext highlighter-rouge">need-data</code>和<code class="language-plaintext highlighter-rouge">enough-data</code>訊號。這兩個訊號是<code class="language-plaintext highlighter-rouge">appsrc</code>發出來的。</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="cm">/* Configure appsrc */</span>
<span class="n">gst_audio_info_set_format</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">GST_AUDIO_FORMAT_S16</span><span class="p">,</span> <span class="n">SAMPLE_RATE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="n">audio_caps</span> <span class="o">=</span> <span class="n">gst_audio_info_to_caps</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
<span class="n">g_object_set</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">app_source</span><span class="p">,</span> <span class="s">"caps"</span><span class="p">,</span> <span class="n">audio_caps</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="n">g_signal_connect</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">app_source</span><span class="p">,</span> <span class="s">"need-data"</span><span class="p">,</span> <span class="n">G_CALLBACK</span> <span class="p">(</span><span class="n">start_feed</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
<span class="n">g_signal_connect</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">app_source</span><span class="p">,</span> <span class="s">"enough-data"</span><span class="p">,</span> <span class="n">G_CALLBACK</span> <span class="p">(</span><span class="n">stop_feed</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
</pre></table></code></div></div><h2 id="new-sample訊號"><span class="mr-2">new-sample訊號</span><a href="#new-sample訊號" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>另外我們還要接上<code class="language-plaintext highlighter-rouge">app_sink</code>的訊號<code class="language-plaintext highlighter-rouge">new-sample</code>，這個訊號預設是關閉的所以必須手動打開這個訊號，由<code class="language-plaintext highlighter-rouge">emit-signals</code>可以設定。</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="cm">/* Configure appsink */</span>
<span class="n">g_object_set</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">app_sink</span><span class="p">,</span> <span class="s">"emit-signals"</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">,</span> <span class="s">"caps"</span><span class="p">,</span> <span class="n">audio_caps</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="n">g_signal_connect</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">app_sink</span><span class="p">,</span> <span class="s">"new-sample"</span><span class="p">,</span> <span class="n">G_CALLBACK</span> <span class="p">(</span><span class="n">new_sample</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
<span class="n">gst_caps_unref</span> <span class="p">(</span><span class="n">audio_caps</span><span class="p">);</span>
</pre></table></code></div></div><h2 id="callback-function"><span class="mr-2">callback function</span><a href="#callback-function" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>我們的callback function在每當<code class="language-plaintext highlighter-rouge">appsrc</code>內部的queue快要沒資料的時候被呼叫。他唯一做的事情就是註冊一個GLib的函式<code class="language-plaintext highlighter-rouge">g_idle_add()</code>，他將會給<code class="language-plaintext highlighter-rouge">appsrc</code>資料直到<code class="language-plaintext highlighter-rouge">appsrc</code>滿了為止。</p><p>Glib的main event loop更進一步說明可以參考<a href="https://zhuanlan.zhihu.com/p/567441726">這裡</a></p><p>我們將<code class="language-plaintext highlighter-rouge">g_idle_add()</code>回傳的id做個紀錄以便等一下可以停止他。</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="cm">/* This signal callback triggers when appsrc needs data. Here, we add an idle handler
 * to the mainloop to start pushing data into the appsrc */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">start_feed</span> <span class="p">(</span><span class="n">GstElement</span> <span class="o">*</span><span class="n">source</span><span class="p">,</span> <span class="n">guint</span> <span class="n">size</span><span class="p">,</span> <span class="n">CustomData</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sourceid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">g_print</span> <span class="p">(</span><span class="s">"Start feeding</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">data</span><span class="o">-&gt;</span><span class="n">sourceid</span> <span class="o">=</span> <span class="n">g_idle_add</span> <span class="p">((</span><span class="n">GSourceFunc</span><span class="p">)</span> <span class="n">push_data</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>下面這個callback function當<code class="language-plaintext highlighter-rouge">appsrc</code>內部的queue滿的時候會被呼叫。在這裡我們就直接用<code class="language-plaintext highlighter-rouge">g_source_remove()</code>移除idle function</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="cm">/* This callback triggers when appsrc has enough data and we can stop sending.
 * We remove the idle handler from the mainloop */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">stop_feed</span> <span class="p">(</span><span class="n">GstElement</span> <span class="o">*</span><span class="n">source</span><span class="p">,</span> <span class="n">CustomData</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sourceid</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">g_print</span> <span class="p">(</span><span class="s">"Stop feeding</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">g_source_remove</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sourceid</span><span class="p">);</span>
    <span class="n">data</span><span class="o">-&gt;</span><span class="n">sourceid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>接下來這個function是推送資料給<code class="language-plaintext highlighter-rouge">appsrc</code>的callback，是給GLib的<code class="language-plaintext highlighter-rouge">g_idle_add()</code>呼叫用的。</p><p>首先他的工作是建立一個新的buffer並且給定大小(這個範例設為1024 bytes)，設定大小可以用<code class="language-plaintext highlighter-rouge">gst_buffer_new_and_alloc()</code>。</p><p>接下例我們計算我們已經餵給<code class="language-plaintext highlighter-rouge">appsrc</code>的資料數目，並且用<code class="language-plaintext highlighter-rouge">CustomData.num_samples</code>紀錄，如此一來就可以給這個buffer時間戳，時皆戳可以用<code class="language-plaintext highlighter-rouge">GstBuffer</code>的<code class="language-plaintext highlighter-rouge">GST_BUFFER_TIMESTAMP</code> marco。</p><p>因為我們每次都提供相同大小的buffer，他的長度都是相同的，我們可以用<code class="language-plaintext highlighter-rouge">GstBuffer</code>的<code class="language-plaintext highlighter-rouge">GST_BUFFER_DURATION</code>marco來設定duration。</p><p><code class="language-plaintext highlighter-rouge">gst_util_uint64_scale()</code>是用來放大或縮小大數字的函式，用這個函是就不用擔心overflows。</p><p>buffer的大小可以用GstBuffer 可以用GST_BUFFER_DATA 取得。</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="cm">/* This method is called by the idle GSource in the mainloop, to feed CHUNK_SIZE bytes into appsrc.
 * The ide handler is added to the mainloop when appsrc requests us to start sending data (need-data signal)
 * and is removed when appsrc has enough data (enough-data signal).
 */</span>
<span class="k">static</span> <span class="n">gboolean</span> <span class="nf">push_data</span> <span class="p">(</span><span class="n">CustomData</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">GstBuffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
  <span class="n">GstFlowReturn</span> <span class="n">ret</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="n">gint16</span> <span class="o">*</span><span class="n">raw</span><span class="p">;</span>
  <span class="n">gint</span> <span class="n">num_samples</span> <span class="o">=</span> <span class="n">CHUNK_SIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* Because each sample is 16 bits */</span>
  <span class="n">gfloat</span> <span class="n">freq</span><span class="p">;</span>

  <span class="cm">/* Create a new empty buffer */</span>
  <span class="n">buffer</span> <span class="o">=</span> <span class="n">gst_buffer_new_and_alloc</span> <span class="p">(</span><span class="n">CHUNK_SIZE</span><span class="p">);</span>

  <span class="cm">/* Set its timestamp and duration */</span>
  <span class="n">GST_BUFFER_TIMESTAMP</span> <span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">=</span> <span class="n">gst_util_uint64_scale</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">num_samples</span><span class="p">,</span> <span class="n">GST_SECOND</span><span class="p">,</span> <span class="n">SAMPLE_RATE</span><span class="p">);</span>
  <span class="n">GST_BUFFER_DURATION</span> <span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">=</span> <span class="n">gst_util_uint64_scale</span> <span class="p">(</span><span class="n">num_samples</span><span class="p">,</span> <span class="n">GST_SECOND</span><span class="p">,</span> <span class="n">SAMPLE_RATE</span><span class="p">);</span>

  <span class="cm">/* Generate some psychodelic waveforms */</span>
  <span class="n">raw</span> <span class="o">=</span> <span class="p">(</span><span class="n">gint16</span> <span class="o">*</span><span class="p">)</span><span class="n">GST_BUFFER_DATA</span> <span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
</pre></table></code></div></div><p>最後就是把生成好的資料推送進<code class="language-plaintext highlighter-rouge">appsrc</code>裡面，並且會觸發<code class="language-plaintext highlighter-rouge">push-buffer</code>訊號。</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="cm">/* Push the buffer into the appsrc */</span>
<span class="n">g_signal_emit_by_name</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">app_source</span><span class="p">,</span> <span class="s">"push-buffer"</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">);</span>

<span class="cm">/* Free the buffer now that we are done with it */</span>
<span class="n">gst_buffer_unref</span> <span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
</pre></table></code></div></div><p>而當<code class="language-plaintext highlighter-rouge">appsink</code>接收到資料的時候下面的函式會被呼叫。我們用<code class="language-plaintext highlighter-rouge">pull-sample</code>動作訊號來取得buffer並且應到螢幕上。利用<code class="language-plaintext highlighter-rouge">GST_BUFFER_DATA</code>取得資料的指針以及<code class="language-plaintext highlighter-rouge">GST_BUFFER_SIZE</code>取得資料大小。</p><p>注意，在這裡的buffer不一定會跟我們在前面指定的buffer大小一樣，因為任何element都有可能去更動buffer，雖然在這個範例buffer並沒有被改動。</p><h1 id="debugging-tools">Debugging tools</h1><h2 id="debug-log"><span class="mr-2">debug log</span><a href="#debug-log" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>debug log是由<code class="language-plaintext highlighter-rouge">GST_DEBUG</code>環境變數控制。下面是GST_DEBUG=2的時候的debug log。</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>0:00:00.868050000  1592   09F62420 WARN                 filesrc gstfilesrc.c:1044:gst_file_src_start:&lt;filesrc0&gt; error: No such file "non-existing-file.webm"
</pre></table></code></div></div><p>通常我們不會把debug log全部打開以免訊息塞爆文件或是訊息視窗。下面是各種等級的debug log會輸出的資料。</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre>| # | Name    | Description                                                    |
|---|---------|----------------------------------------------------------------|
| 0 | none    | No debug information is output.                                |
| 1 | ERROR   | Logs all fatal errors. These are errors that do not allow the  |
|   |         | core or elements to perform the requested action. The          |
|   |         | application can still recover if programmed to handle the      |
|   |         | conditions that triggered the error.                           |
| 2 | WARNING | Logs all warnings. Typically these are non-fatal, but          |
|   |         | user-visible problems are expected to happen.                  |
| 3 | FIXME   | Logs all "fixme" messages. Those typically that a codepath that|
|   |         | is known to be incomplete has been triggered. It may work in   |
|   |         | most cases, but may cause problems in specific instances.      |
| 4 | INFO    | Logs all informational messages. These are typically used for  |
|   |         | events in the system that only happen once, or are important   |
|   |         | and rare enough to be logged at this level.                    |
| 5 | DEBUG   | Logs all debug messages. These are general debug messages for  |
|   |         | events that happen only a limited number of times during an    |
|   |         | object's lifetime; these include setup, teardown, change of    |
|   |         | parameters, etc.                                               |
| 6 | LOG     | Logs all log messages. These are messages for events that      |
|   |         | happen repeatedly during an object's lifetime; these include   |
|   |         | streaming and steady-state conditions. This is used for log    |
|   |         | messages that happen on every buffer in an element for example.|
| 7 | TRACE   | Logs all trace messages. Those are message that happen very    |
|   |         | very often. This is for example is each time the reference     |
|   |         | count of a GstMiniObject, such as a GstBuffer or GstEvent, is  |
|   |         | modified.                                                      |
| 9 | MEMDUMP | Logs all memory dump messages. This is the heaviest logging and|
|   |         | may include dumping the content of blocks of memory.           |
+------------------------------------------------------------------------------+
</pre></table></code></div></div><h2 id="設置element的debug-log"><span class="mr-2">設置element的debug log</span><a href="#設置element的debug-log" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>如果要設置個別element的debug level，範例如下。如此一來<code class="language-plaintext highlighter-rouge">audiotestsrc</code>的level是6，其他的都是2</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>GST_DEBUG=2,audiotestsrc:6
</pre></table></code></div></div><h2 id="gst_debug格是"><span class="mr-2">GST_DEBUG格是</span><a href="#gst_debug格是" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>GST_DEBUG的第一個參數是optional的，他會設定全域的debug level。參數之間以逗號<code class="language-plaintext highlighter-rouge">,</code>區隔，除了第一個參數，每一個設定的格式都是<code class="language-plaintext highlighter-rouge">category:level</code>。</p><p><code class="language-plaintext highlighter-rouge">*</code>也可以被用在GST_DEBUG裡面，例如<code class="language-plaintext highlighter-rouge">GST_DEBUG=2,audio*:6</code>會把所有開頭為audio的element都設為level 6，其他保持level 2。</p><h2 id="增加自訂除錯訊息"><span class="mr-2">增加自訂除錯訊息</span><a href="#增加自訂除錯訊息" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>如果要讓category 看起來更有意義，可以加入下面兩行</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">GST_DEBUG_CATEGORY_STATIC</span> <span class="p">(</span><span class="n">my_category</span><span class="p">);</span>
<span class="cp">#define GST_CAT_DEFAULT my_category
</span></pre></table></code></div></div><p>以及下面這行在<code class="language-plaintext highlighter-rouge">gst_init()</code>被呼叫之後。</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">GST_DEBUG_CATEGORY_INIT</span> <span class="p">(</span><span class="n">my_category</span><span class="p">,</span> <span class="s">"my category"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"This is my very own"</span><span class="p">);</span>
</pre></table></code></div></div><h2 id="取得pipeline的圖"><span class="mr-2">取得pipeline的圖</span><a href="#取得pipeline的圖" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>gstreamer可以將你的pipeline輸出成.dot檔可以用例如GraphViz來開啟。</p><p>如果在程式內想開啟這項功能可以用<code class="language-plaintext highlighter-rouge">GST_DEBUG_BIN_TO_DOT_FILE()</code> 和 <code class="language-plaintext highlighter-rouge">GST_DEBUG_BIN_TO_DOT_FILE_WITH_TS()</code>marco來開啟這個功能。 範例:<br /> 可以在程式中加入下面程式碼來儲存pipeline圖<br /> <a href="https://gstreamer.freedesktop.org/documentation/gstreamer/debugutils.html#gst_debug_bin_to_dot_file">官方文件</a><br /> <a href="https://gstreamer.freedesktop.org/documentation/gstreamer/debugutils.html?gi-language=c#GstDebugGraphDetails">圖案參數</a><br /> <a href="https://github.com/nnstreamer/nnstreamer/blob/main/tools/debugging/README.md">參考來源</a></p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">GST_DEBUG_BIN_TO_DOT_FILE</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">GST_DEBUG_GRAPH_SHOW_ALL</span><span class="p">,</span> <span class="s">"pipeline"</span><span class="p">);</span> <span class="c1">//三個參數分別為 pipeline的instance, 圖案參數, 檔案名稱</span>
</pre></table></code></div></div><p>這行程式記得加在將pipeline state設定為<code class="language-plaintext highlighter-rouge">playing</code>之前，這樣才能完整看到pipeline的樣子。</p><p>然後執行程式之前先設定環境變數<code class="language-plaintext highlighter-rouge">GST_DEBUG_DUMP_DOT_DIR</code>來指定儲存位置</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">export </span><span class="nv">GST_DEBUG_DUMP_DOT_DIR</span><span class="o">=</span>./tracing/
<span class="nb">mkdir </span>tracing
</pre></table></code></div></div><p>接下來就會在tracing看到<code class="language-plaintext highlighter-rouge">pipeline.dot</code>檔</p><p>安裝<code class="language-plaintext highlighter-rouge">xdot</code>來讀取.dot檔</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>apt <span class="nb">install </span>xdot
xdot pipeline.dot
</pre></table></code></div></div><p>gst-launch-1.0可以用用GST_DEBUG_DUMP_DOT_DIR來設定儲存圖片的資料夾並開啟這項功能。每當pipeline的狀態改變的時候都會畫一張圖，如此一來就可以看到pipeline的變化</p><h1 id="gst-debugger">gst-debugger</h1><p><a href="https://github.com/GNOME/gst-debugger.git">遠端除錯gstreamer</a></p><p>安裝protoc<br /> http://google.github.io/proto-lens/installing-protoc.html</p><h1 id="streaming">Streaming</h1><p>這裡將介紹streaming要注意的點</p><ul><li>開啟buffering<li>斷線重連 通常網路串流會因為網路連線的關係造成串流封包沒有準時到達而造成跨面卡住。而這個問題的解法就是使用<code class="language-plaintext highlighter-rouge">buffer</code>。<code class="language-plaintext highlighter-rouge">buffer</code>讓一些影音chunks儲存在queue裡面，如此一來雖然剛開始影片會稍微延遲一點，但是如果網路連線不穩的話話面不會卡住，因為queue裡面還有chunks。</ul><h2 id="clock"><span class="mr-2">clock</span><a href="#clock" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>應用程式應該隨時監看<code class="language-plaintext highlighter-rouge">buffer</code>的狀態，如果<code class="language-plaintext highlighter-rouge">buffer</code>太少，就應該暫停撥放。為了達到所有的sink都可以同步，GStreamer有一個global clock，所有的element都會共用這個global clock。 有時候如果切換streaming或是切換輸出裝置，clock會消失，這時候就必須重選clock，下面的範例將會解說這個步驟。</p><p>當clock消失的時候應用程式會接收到訊息，這時候只需要將pipeline設為PAUSED再設為PLAYING就可以選擇新的clock。</p><h2 id="範例-6"><span class="mr-2">範例</span><a href="#範例-6" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>範例<code class="language-plaintext highlighter-rouge">basic-tutorial-12.c</code></p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;gst/gst.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_CustomData</span> <span class="p">{</span>
  <span class="n">gboolean</span> <span class="n">is_live</span><span class="p">;</span>
  <span class="n">GstElement</span> <span class="o">*</span><span class="n">pipeline</span><span class="p">;</span>
  <span class="n">GMainLoop</span> <span class="o">*</span><span class="n">loop</span><span class="p">;</span>
<span class="p">}</span> <span class="n">CustomData</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cb_message</span> <span class="p">(</span><span class="n">GstBus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="n">GstMessage</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="n">CustomData</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">switch</span> <span class="p">(</span><span class="n">GST_MESSAGE_TYPE</span> <span class="p">(</span><span class="n">msg</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">GST_MESSAGE_ERROR</span><span class="p">:</span> <span class="p">{</span>
      <span class="n">GError</span> <span class="o">*</span><span class="n">err</span><span class="p">;</span>
      <span class="n">gchar</span> <span class="o">*</span><span class="n">debug</span><span class="p">;</span>

      <span class="n">gst_message_parse_error</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">debug</span><span class="p">);</span>
      <span class="n">g_print</span> <span class="p">(</span><span class="s">"Error: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">err</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">);</span>
      <span class="n">g_error_free</span> <span class="p">(</span><span class="n">err</span><span class="p">);</span>
      <span class="n">g_free</span> <span class="p">(</span><span class="n">debug</span><span class="p">);</span>

      <span class="n">gst_element_set_state</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">GST_STATE_READY</span><span class="p">);</span>
      <span class="n">g_main_loop_quit</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">loop</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">case</span> <span class="n">GST_MESSAGE_EOS</span><span class="p">:</span>
      <span class="cm">/* end-of-stream */</span>
      <span class="n">gst_element_set_state</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">GST_STATE_READY</span><span class="p">);</span>
      <span class="n">g_main_loop_quit</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">loop</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">GST_MESSAGE_BUFFERING</span><span class="p">:</span> <span class="p">{</span>
      <span class="n">gint</span> <span class="n">percent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

      <span class="cm">/* If the stream is live, we do not care about buffering. */</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">is_live</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>

      <span class="n">gst_message_parse_buffering</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">percent</span><span class="p">);</span>
      <span class="n">g_print</span> <span class="p">(</span><span class="s">"Buffering (%3d%%)</span><span class="se">\r</span><span class="s">"</span><span class="p">,</span> <span class="n">percent</span><span class="p">);</span>
      <span class="cm">/* Wait until buffering is complete before start/resume playing */</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">percent</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">gst_element_set_state</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">GST_STATE_PAUSED</span><span class="p">);</span>
      <span class="k">else</span>
        <span class="n">gst_element_set_state</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">GST_STATE_PLAYING</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">case</span> <span class="n">GST_MESSAGE_CLOCK_LOST</span><span class="p">:</span>
      <span class="cm">/* Get a new clock */</span>
      <span class="n">gst_element_set_state</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">GST_STATE_PAUSED</span><span class="p">);</span>
      <span class="n">gst_element_set_state</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">GST_STATE_PLAYING</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
      <span class="cm">/* Unhandled message */</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
  <span class="n">GstElement</span> <span class="o">*</span><span class="n">pipeline</span><span class="p">;</span>
  <span class="n">GstBus</span> <span class="o">*</span><span class="n">bus</span><span class="p">;</span>
  <span class="n">GstStateChangeReturn</span> <span class="n">ret</span><span class="p">;</span>
  <span class="n">GMainLoop</span> <span class="o">*</span><span class="n">main_loop</span><span class="p">;</span>
  <span class="n">CustomData</span> <span class="n">data</span><span class="p">;</span>

  <span class="cm">/* Initialize GStreamer */</span>
  <span class="n">gst_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span>

  <span class="cm">/* Initialize our data structure */</span>
  <span class="n">memset</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">data</span><span class="p">));</span>

  <span class="cm">/* Build the pipeline */</span>
  <span class="n">pipeline</span> <span class="o">=</span> <span class="n">gst_parse_launch</span> <span class="p">(</span><span class="s">"playbin uri=https://www.freedesktop.org/software/gstreamer-sdk/data/media/sintel_trailer-480p.webm"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="n">bus</span> <span class="o">=</span> <span class="n">gst_element_get_bus</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">);</span>

  <span class="cm">/* Start playing */</span>
  <span class="n">ret</span> <span class="o">=</span> <span class="n">gst_element_set_state</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">GST_STATE_PLAYING</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">GST_STATE_CHANGE_FAILURE</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Unable to set the pipeline to the playing state.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">GST_STATE_CHANGE_NO_PREROLL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">data</span><span class="p">.</span><span class="n">is_live</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">main_loop</span> <span class="o">=</span> <span class="n">g_main_loop_new</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
  <span class="n">data</span><span class="p">.</span><span class="n">loop</span> <span class="o">=</span> <span class="n">main_loop</span><span class="p">;</span>
  <span class="n">data</span><span class="p">.</span><span class="n">pipeline</span> <span class="o">=</span> <span class="n">pipeline</span><span class="p">;</span>

  <span class="n">gst_bus_add_signal_watch</span> <span class="p">(</span><span class="n">bus</span><span class="p">);</span>
  <span class="n">g_signal_connect</span> <span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="s">"message"</span><span class="p">,</span> <span class="n">G_CALLBACK</span> <span class="p">(</span><span class="n">cb_message</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>

  <span class="n">g_main_loop_run</span> <span class="p">(</span><span class="n">main_loop</span><span class="p">);</span>

  <span class="cm">/* Free resources */</span>
  <span class="n">g_main_loop_unref</span> <span class="p">(</span><span class="n">main_loop</span><span class="p">);</span>
  <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">bus</span><span class="p">);</span>
  <span class="n">gst_element_set_state</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">GST_STATE_NULL</span><span class="p">);</span>
  <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="說明"><span class="mr-2">說明</span><a href="#說明" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>在這個範例中比較特別的是下面這一段，注意如果收到<code class="language-plaintext highlighter-rouge">GST_STATE_CHANGE_NO_PREROLL</code>而不是<code class="language-plaintext highlighter-rouge">GST_STATE_CHANGE_SUCCESS</code>，這代表目前正再撥放直撥串流。</p><p>因為直撥串流是不能暫停的，所以就算把pipeline的狀態設為PAUSED他的行為還是跟PLAYING一樣。而且即使我們嘗試將pipeline設為PLAYING也會收到這個訊息。</p><p>因為我們想要關閉直撥串流的<code class="language-plaintext highlighter-rouge">buffering</code>，所以我們用<code class="language-plaintext highlighter-rouge">gst_element_set_state()</code>在data裡面做記號</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="cm">/* Start playing */</span>
<span class="n">ret</span> <span class="o">=</span> <span class="n">gst_element_set_state</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">GST_STATE_PLAYING</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">GST_STATE_CHANGE_FAILURE</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">g_printerr</span> <span class="p">(</span><span class="s">"Unable to set the pipeline to the playing state.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="n">gst_object_unref</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">);</span>
  <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">GST_STATE_CHANGE_NO_PREROLL</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">data</span><span class="p">.</span><span class="n">is_live</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="callback"><span class="mr-2">callback</span><a href="#callback" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>接下來我們看一下message parsing callback，首先如果發現是直撥串流，就不要打開<code class="language-plaintext highlighter-rouge">buffering</code>。接下來用<code class="language-plaintext highlighter-rouge">gst_message_parse_buffering()</code>來取得 buffering level。</p><p>然後我們印出 buffering level並且設定當 buffering level小於100%的時候就暫停pipeline，如果超過就設為PLAYING。</p><p>程式執行的時候會看到buffer慢慢攀升到100%，然後如果網路不穩到buffer小於100%，就會暫停撥放直到回復100%後才重新撥放。</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="k">case</span> <span class="n">GST_MESSAGE_BUFFERING</span><span class="p">:</span> <span class="p">{</span>
  <span class="n">gint</span> <span class="n">percent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="cm">/* If the stream is live, we do not care about buffering. */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">is_live</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>

  <span class="n">gst_message_parse_buffering</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">percent</span><span class="p">);</span>
  <span class="n">g_print</span> <span class="p">(</span><span class="s">"Buffering (%3d%%)</span><span class="se">\r</span><span class="s">"</span><span class="p">,</span> <span class="n">percent</span><span class="p">);</span>
  <span class="cm">/* Wait until buffering is complete before start/resume playing */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">percent</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">gst_element_set_state</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">GST_STATE_PAUSED</span><span class="p">);</span>
  <span class="k">else</span>
    <span class="n">gst_element_set_state</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">GST_STATE_PLAYING</span><span class="p">);</span>
  <span class="k">break</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="lost-clock"><span class="mr-2">lost clock</span><a href="#lost-clock" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>另一個我們要處理的消息是遺失clock，我們只需要將pipeline設為PAUSED再設為PLAYING就可以了。</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">case</span> <span class="n">GST_MESSAGE_CLOCK_LOST</span><span class="p">:</span>
  <span class="cm">/* Get a new clock */</span>
  <span class="n">gst_element_set_state</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">GST_STATE_PAUSED</span><span class="p">);</span>
  <span class="n">gst_element_set_state</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">GST_STATE_PLAYING</span><span class="p">);</span>
  <span class="k">break</span><span class="p">;</span>
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/%E6%B7%B1%E5%BA%A6%E5%AD%B8%E7%BF%92%E5%B7%A5%E5%85%B7/'>深度學習工具</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/gstreamer/" class="post-tag no-text-decoration" >gstreamer</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=GStreamer%E5%9F%BA%E7%A4%8E%E6%95%99%E5%AD%B8+-+Steven&url=https%3A%2F%2Fjenhaoyang.github.io%2F%2Fposts%2Fgstreamer%25E5%259F%25BA%25E7%25A4%258E%25E6%2595%2599%25E5%25AD%25B8%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=GStreamer%E5%9F%BA%E7%A4%8E%E6%95%99%E5%AD%B8+-+Steven&u=https%3A%2F%2Fjenhaoyang.github.io%2F%2Fposts%2Fgstreamer%25E5%259F%25BA%25E7%25A4%258E%25E6%2595%2599%25E5%25AD%25B8%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fjenhaoyang.github.io%2F%2Fposts%2Fgstreamer%25E5%259F%25BA%25E7%25A4%258E%25E6%2595%2599%25E5%25AD%25B8%2F&text=GStreamer%E5%9F%BA%E7%A4%8E%E6%95%99%E5%AD%B8+-+Steven" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Windows-NTP%E6%A0%A1%E6%99%82/">Windows-NTP校時</a><li><a href="/posts/Gstreamer%E4%BD%BF%E7%94%A8%E7%AD%86%E8%A8%98/">Gstreamer使用筆記</a><li><a href="/posts/ubuntu%E8%A8%AD%E5%AE%9Ahome%E7%9B%AE%E9%8C%84%E5%88%B0%E5%AE%9A%E5%8F%A6%E4%B8%80%E9%A1%86%E7%A1%AC%E7%A2%9F/">Ubuntu設定home目錄到定另一顆硬碟</a><li><a href="/posts/Linux%E4%B8%8B%E7%9A%84Docker%E6%9B%B4%E6%94%B9image%E5%84%B2%E5%AD%98%E4%BD%8D%E7%BD%AE/">Linux下的Docker更改image儲存位置</a><li><a href="/posts/tensorrt%E7%B3%BB%E5%88%97-%E4%B8%80-%E7%92%B0%E5%A2%83%E8%A8%AD%E5%AE%9A/">TensorRT系列(一)環境設定</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ubuntu/">ubuntu</a> <a class="post-tag" href="/tags/cmake/">cmake</a> <a class="post-tag" href="/tags/cpp/">cpp</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/deepstream/">deepstream</a> <a class="post-tag" href="/tags/peopleflow/">peopleflow</a> <a class="post-tag" href="/tags/pythoncpp/">pythoncpp</a> <a class="post-tag" href="/tags/ssh/">ssh</a> <a class="post-tag" href="/tags/ubuntu/">Ubuntu</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/deepstream%E6%95%99%E5%AD%B8/"><div class="card-body"> <em class="small" data-ts="1673411280" data-df="ll" > Jan 11, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>deepstream教學</h3><div class="text-muted small"><p> 客製化模型實作nvinfer介面 nvinfer呼叫介面 任何客製化介面最終必須被編譯成一個獨立的shared library。nvinfer在執行期間利用dlopen()呼叫函式庫，並且利用dlsym()呼叫函式庫中的函式。進一步的資訊紀錄在nvdsinfer_custom_impl.h裡面https://docs.nvidia.com/metropolis/deepstream/sdk...</p></div></div></a></div><div class="card"> <a href="/posts/deepstream-tracker%E5%8F%83%E6%95%B8%E8%AA%BF%E6%95%B4/"><div class="card-body"> <em class="small" data-ts="1686803280" data-df="ll" > Jun 15, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>deepstream-tracker參數調整</h3><div class="text-muted small"><p> Accuracy-Performance Tradeoffs 下面這些參數的調整將會影響到準確度和效能。 Visual Feature Types and Feature Sizes Visual feature types useColorNames useHog Feature sizes featureImgSizeLevel searchRegionPadd...</p></div></div></a></div><div class="card"> <a href="/posts/%E7%B7%A8%E8%AD%AFonnxruntime/"><div class="card-body"> <em class="small" data-ts="1655803680" data-df="ll" > Jun 21, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>編譯onnxruntime Tensorrt ExecutionProvider</h3><div class="text-muted small"><p> 1. 安裝CUDA、cuDNN、Tensorrt 我的環境 Windows10 Visual Studio 2019(注意 先安裝visual studio 再安裝CUDA，因為CUDA包含給visual studio使用的原件) cmake: 3.24.0 CUDA: 11.4 cuDNN: 8.2 Tensorrt:8.2.3.0 2.下載onnxrunt...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/deepstream%E5%8B%95%E6%85%8B%E5%A2%9E%E6%B8%9B%E4%B8%B2%E6%B5%81/" class="btn btn-outline-primary" prompt="Older"><p>DeepStream動態增減串流</p></a> <a href="/posts/ubuntu%E8%A8%AD%E5%AE%9Ahome%E7%9B%AE%E9%8C%84%E5%88%B0%E5%AE%9A%E5%8F%A6%E4%B8%80%E9%A1%86%E7%A1%AC%E7%A2%9F/" class="btn btn-outline-primary" prompt="Newer"><p>Ubuntu設定home目錄到定另一顆硬碟</p></a></div><script type="text/javascript"> $(function () { const origin = "https://giscus.app"; const iframe = "iframe.giscus-frame"; const lightTheme = "light"; const darkTheme = "dark_dimmed"; let initTheme = lightTheme; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = darkTheme; } let giscusAttributes = { "src": "https://giscus.app/client.js", "data-repo": "jenhaoyang/jenhaoyang.github.io", "data-repo-id": "R_kgDOGONpkw", "data-category": "Announcements", "data-category-id": "DIC_kwDOGONpk84CPyux", "data-mapping": "pathname", "data-reactions-enabled": "1", "data-emit-metadata": "0", "data-theme": initTheme, "data-input-position": "bottom", "data-lang": "en", "crossorigin": "anonymous", "async": "" }; let giscusScript = document.createElement("script"); Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value)); document.getElementById("tail-wrapper").appendChild(giscusScript); addEventListener("message", (event) => { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* global theme mode changed */ const mode = event.data.message; const theme = (mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme); const message = { setConfig: { theme: theme } }; const giscus = document.querySelector(iframe).contentWindow; giscus.postMessage({ giscus: message }, origin); } }); }); </script></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://github.com/jenhaoyang">Steven Yang</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ubuntu/">ubuntu</a> <a class="post-tag" href="/tags/cmake/">cmake</a> <a class="post-tag" href="/tags/cpp/">cpp</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/deepstream/">deepstream</a> <a class="post-tag" href="/tags/peopleflow/">peopleflow</a> <a class="post-tag" href="/tags/pythoncpp/">pythoncpp</a> <a class="post-tag" href="/tags/ssh/">ssh</a> <a class="post-tag" href="/tags/ubuntu/">Ubuntu</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-YD5Z1Y7D6R"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-YD5Z1Y7D6R'); }); </script>
